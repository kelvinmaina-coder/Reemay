<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kagema University - Student Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --primary: #0A2472;
            --primary-dark: #051844;
            --secondary: #F9A826;
            --secondary-dark: #e09312;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            background: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .university-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .university-logo h1 {
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
        }

        .university-logo p {
            color: var(--secondary);
            font-style: italic;
        }

        .motto {
            color: var(--gray);
            font-size: 12px;
            margin-top: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(249, 168, 38, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Portal Layout */
        .portal-container {
            display: none;
        }

        .portal-container.active {
            display: block;
        }

        /* Top Navigation */
        .top-nav {
            background: var(--primary);
            color: white;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .nav-line {
            padding: 10px 30px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-item {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--secondary);
            color: var(--primary);
        }

        .brand {
            font-size: 18px;
            font-weight: 700;
            margin-right: auto;
        }

        .brand span {
            color: var(--secondary);
        }

        /* Main Content */
        .main-content {
            margin-top: 130px;
            padding: 30px;
            min-height: calc(100vh - 130px);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .student-info-card {
            grid-column: span 2;
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: var(--light);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .action-btn {
            padding: 12px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover:not(:disabled) {
            background: var(--secondary);
            color: var(--primary);
            border-color: var(--secondary);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px;
            background: var(--light);
            font-weight: 600;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        /* Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fed7aa; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary);
            transition: width 0.3s;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Course Grid */
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .course-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        /* Registration Period Banner */
        .period-banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .countdown {
            font-size: 24px;
            font-weight: 700;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-line {
                padding: 10px;
                gap: 8px;
            }
            
            .nav-item {
                font-size: 12px;
                padding: 4px 8px;
            }
            
            .main-content {
                padding: 15px;
                margin-top: 160px;
            }
            
            .student-info-card {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="university-logo">
                <h1>üèõÔ∏è KAGEMA UNIVERSITY</h1>
                <p>of Science and Technology</p>
                <div class="motto">"Technology Meets Wisdom"</div>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Admission Number</label>
                    <input type="text" id="loginAdmission" placeholder="e.g., KUST/2024/001">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password">
                </div>
                <button class="login-btn" onclick="login()">Login to Portal</button>
                <div style="text-align: center; margin-top: 20px;">
                    <a href="#" style="color: var(--secondary); text-decoration: none;" onclick="showAdminLogin()">Admin Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Portal -->
    <div class="portal-container" id="portalContainer">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-line">
                <div class="brand">KAGEMA <span>UNIVERSITY</span></div>
                <a class="nav-item active" onclick="showSection('dashboard')">üè† Home</a>
                <a class="nav-item" onclick="showSection('profile')">üìù Profile</a>
                <a class="nav-item" onclick="showSection('fees')">üí∞ Fees</a>
                <a class="nav-item" onclick="showSection('timetable')">üìÖ Timetable</a>
                <a class="nav-item" onclick="showSection('registration')">üìö Registration</a>
                <a class="nav-item" onclick="showSection('results')">üìä Results</a>
                <a class="nav-item" onclick="showSection('requests')">üìã Requests</a>
                <a class="nav-item" onclick="logout()">üö™ Sign Out</a>
            </div>
            <div class="nav-line">
                <a class="nav-item" onclick="showSection('downloads')">üì• Downloads</a>
                <a class="nav-item" onclick="showSection('elearning')">üíª eLearning</a>
                <a class="nav-item" onclick="showSection('library')">üìö Library</a>
                <a class="nav-item" onclick="showSection('hostel')">üè† Hostel</a>
                <a class="nav-item" onclick="showSection('health')">üè• Health</a>
                <a class="nav-item" onclick="showSection('career')">üíº Career</a>
                <a class="nav-item" onclick="showSection('examCard')">üé´ Exam Card</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent"></main>
    </div>

    <!-- M-Pesa Modal -->
    <div class="modal" id="mpesaModal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">M-Pesa Payment</h2>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="text" id="mpesaPhone" class="form-input" value="2547" placeholder="0712345678">
            </div>
            <div class="form-group">
                <label>Amount (KES)</label>
                <input type="number" id="mpesaAmount" class="form-input" value="5000">
            </div>
            <div class="form-group">
                <label>Account Reference</label>
                <input type="text" id="mpesaRef" class="form-input" value="KUST-FEES">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="action-btn" onclick="closeModal('mpesaModal')">Cancel</button>
                <button class="action-btn" style="background: var(--secondary);" onclick="processMpesaPayment()">Pay Now</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SYSTEM CONFIGURATION ====================
        const SYSTEM_CONFIG = {
            registrationDeadline: '2024-03-15T23:59:59',
            minCredits: 12,
            maxCredits: 21,
            maxUnits: 8,
            currentSemester: 'Semester 1, 2024',
            academicYear: '2023/2024'
        };

        // ==================== STUDENT DATABASE ====================
        const studentsDatabase = {
            'KUST/2024/001': {
                admission: 'KUST/2024/001',
                name: 'John Kamau',
                password: 'pass123',
                email: 'john.kamau@student.kagemauniversity.ac.ke',
                phone: '+254 712 345 678',
                program: 'BSc. Computer Science',
                yearOfStudy: 3,
                yearOfEntry: 2024,
                expectedGraduation: 2027,
                birthCertificate: 'BC-1998-123456',
                idNumber: 'ID-34567890',
                dateOfBirth: '1998-05-15',
                gender: 'Male',
                nationality: 'Kenyan',
                admissionDate: '2024-01-10',
                
                // Academic Records
                registeredUnits: [
                    { code: 'CSC 3101', title: 'Database Systems', credits: 4, status: 'active' }
                ],
                
                // Results
                results: {
                    'CSC 3101': { cat1: 24, cat2: 28, assignment: 18, exam: 85, total: 78, grade: 'A' }
                },
                
                // Financial Records
                feeBalance: 45000,
                payments: [
                    { date: '2024-01-15', receipt: 'RCT-2024-001', amount: 50000, method: 'M-Pesa', status: 'completed' },
                    { date: '2024-02-01', receipt: 'RCT-2024-089', amount: 35000, method: 'Bank', status: 'completed' }
                ],
                
                // Exam Eligibility
                examEligible: false,
                catsCompleted: true,
                
                // Hostel
                hostelBooking: null,
                
                // Library
                borrowedBooks: [],
                
                // Medical
                appointments: []
            }
        };

        // ==================== AVAILABLE UNITS ====================
        const availableUnits = [
            { code: 'CSC 3101', title: 'Database Systems', credits: 4, lecturer: 'Dr. Kimani', capacity: 60, enrolled: 45, prerequisites: [], type: 'core', schedule: 'Mon 8-10am', room: 'Lab 3', department: 'Computer Science' },
            { code: 'CSC 3102', title: 'Data Structures', credits: 4, lecturer: 'Prof. Odhiambo', capacity: 60, enrolled: 52, prerequisites: ['CSC 2101'], type: 'core', schedule: 'Tue 10-12pm', room: 'Room 204', department: 'Computer Science' },
            { code: 'CSC 3201', title: 'Web Development', credits: 4, lecturer: 'Prof. Ochieng', capacity: 50, enrolled: 38, prerequisites: ['CSC 2102'], type: 'core', schedule: 'Wed 2-4pm', room: 'Lab 2', department: 'Computer Science' },
            { code: 'CSC 3202', title: 'Mobile Programming', credits: 3, lecturer: 'Dr. Wanjiru', capacity: 40, enrolled: 25, prerequisites: ['CSC 3201'], type: 'elective', schedule: 'Thu 8-10am', room: 'Lab 1', department: 'Computer Science' },
            { code: 'CSC 3301', title: 'Network Security', credits: 4, lecturer: 'Dr. Wanjiku', capacity: 45, enrolled: 32, prerequisites: ['CSC 3102'], type: 'core', schedule: 'Fri 10-12pm', room: 'Room 305', department: 'Computer Science' },
            { code: 'CSC 3302', title: 'Cloud Computing', credits: 3, lecturer: 'Dr. Mwangi', capacity: 40, enrolled: 18, prerequisites: ['CSC 3201'], type: 'elective', schedule: 'Sat 9-11am', room: 'Online', department: 'Computer Science' },
            { code: 'MAT 2101', title: 'Discrete Mathematics', credits: 3, lecturer: 'Prof. Akinyi', capacity: 80, enrolled: 65, prerequisites: [], type: 'core', schedule: 'Mon 11am-1pm', room: 'Hall A', department: 'Mathematics' },
            { code: 'PHY 2101', title: 'Physics I', credits: 3, lecturer: 'Dr. Omondi', capacity: 75, enrolled: 70, prerequisites: [], type: 'core', schedule: 'Wed 9-11am', room: 'Lab 4', department: 'Physics' }
        ];

        // ==================== FEE STRUCTURE ====================
        const feeStructure = {
            tuitionPerCredit: 5000,
            registration: 5000,
            library: 3000,
            computerLab: 4000,
            activity: 2000,
            medical: 1000,
            hostel: {
                single: 15000,
                double: 12000
            },
            mealPlan: 40000
        };

        // ==================== STATE MANAGEMENT ====================
        let currentUser = null;
        let currentSection = 'dashboard';
        let cartUnits = [];
        let isRegistrationOpen = checkRegistrationPeriod();
        let notifications = [];

        // ==================== INITIALIZATION ====================
        function init() {
            loadNotifications();
            checkSession();
            startCountdown();
        }

        function checkSession() {
            const savedSession = localStorage.getItem('kust_session');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.expiry > Date.now()) {
                    currentUser = studentsDatabase[session.admission];
                    if (currentUser) {
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('portalContainer').classList.add('active');
                        showSection('dashboard');
                    }
                } else {
                    localStorage.removeItem('kust_session');
                }
            }
        }

        // ==================== AUTHENTICATION ====================
        function login() {
            const admission = document.getElementById('loginAdmission').value;
            const password = document.getElementById('loginPassword').value;

            if (!admission || !password) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const student = studentsDatabase[admission];
            
            if (student && student.password === password) {
                currentUser = student;
                
                // Check if first login
                if (!student.lastLogin) {
                    showFirstLoginSetup();
                }
                
                // Create session
                const session = {
                    admission: admission,
                    expiry: Date.now() + (8 * 60 * 60 * 1000) // 8 hours
                };
                localStorage.setItem('kust_session', JSON.stringify(session));
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('portalContainer').classList.add('active');
                showSection('dashboard');
                showToast(`Welcome, ${currentUser.name}!`, 'success');
            } else {
                showToast('Invalid admission number or password', 'error');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('kust_session');
                currentUser = null;
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('portalContainer').classList.remove('active');
                showToast('Logged out successfully', 'success');
            }
        }

        function showFirstLoginSetup() {
            alert('Welcome to Kagema University! Please complete your profile setup.');
            showSection('profile');
        }

        // ==================== REGISTRATION PERIOD ====================
        function checkRegistrationPeriod() {
            const now = new Date();
            const deadline = new Date(SYSTEM_CONFIG.registrationDeadline);
            return now <= deadline;
        }

        function startCountdown() {
            setInterval(() => {
                const now = new Date();
                const deadline = new Date(SYSTEM_CONFIG.registrationDeadline);
                const diff = deadline - now;
                
                if (diff <= 0) {
                    isRegistrationOpen = false;
                }
                
                // Update countdown if element exists
                const countdownEl = document.getElementById('registrationCountdown');
                if (countdownEl) {
                    if (diff <= 0) {
                        countdownEl.innerHTML = 'Registration Closed';
                    } else {
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        countdownEl.innerHTML = `${days}d ${hours}h ${minutes}m`;
                    }
                }
            }, 1000);
        }

        // ==================== NAVIGATION ====================
        function showSection(section) {
            currentSection = section;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const content = document.getElementById('mainContent');
            
            switch(section) {
                case 'dashboard': content.innerHTML = renderDashboard(); break;
                case 'profile': content.innerHTML = renderProfile(); break;
                case 'fees': content.innerHTML = renderFees(); break;
                case 'timetable': content.innerHTML = renderTimetable(); break;
                case 'registration': content.innerHTML = renderRegistration(); break;
                case 'results': content.innerHTML = renderResults(); break;
                case 'examCard': content.innerHTML = renderExamCard(); break;
                case 'downloads': content.innerHTML = renderDownloads(); break;
                case 'elearning': content.innerHTML = renderElearning(); break;
                case 'library': content.innerHTML = renderLibrary(); break;
                case 'hostel': content.innerHTML = renderHostel(); break;
                case 'health': content.innerHTML = renderHealth(); break;
                case 'career': content.innerHTML = renderCareer(); break;
                case 'requests': content.innerHTML = renderRequests(); break;
            }
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const totalCredits = currentUser.registeredUnits.reduce((sum, u) => sum + u.credits, 0);
            const examEligible = checkExamEligibility();

            return `
                <div class="period-banner">
                    <div>
                        <strong>${SYSTEM_CONFIG.currentSemester}</strong>
                        <p>Registration Deadline: ${new Date(SYSTEM_CONFIG.registrationDeadline).toLocaleDateString()}</p>
                    </div>
                    <div class="countdown" id="registrationCountdown"></div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h1 style="color: var(--primary);">Welcome, ${currentUser.name}!</h1>
                    <div style="display: flex; gap: 15px;">
                        <span class="badge badge-info">${currentUser.admission}</span>
                        <span class="badge badge-${examEligible ? 'success' : 'warning'}">
                            ${examEligible ? 'Exam Eligible' : 'Exam Not Eligible'}
                        </span>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <!-- Student Info Card -->
                    <div class="card student-info-card">
                        <div class="profile-photo">
                            üë§
                        </div>
                        <div style="flex: 1;">
                            <h2>${currentUser.name}</h2>
                            <p style="color: var(--gray);">${currentUser.admission}</p>
                            <p>${currentUser.program} | Year ${currentUser.yearOfStudy}</p>
                            <p>üìß ${currentUser.email}</p>
                            <p>üì± ${currentUser.phone}</p>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <span class="badge badge-info">Birth Cert: ${currentUser.birthCertificate}</span>
                                <span class="badge badge-info">ID: ${currentUser.idNumber}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card">
                        <h3>Academic Summary</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">${currentUser.registeredUnits.length}</div>
                                <div class="stat-label">Units</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${totalCredits}</div>
                                <div class="stat-label">Credits</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${calculateGPA()}</div>
                                <div class="stat-label">GPA</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">KES ${currentUser.feeBalance.toLocaleString()}</div>
                                <div class="stat-label">Balance</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <h3>Quick Actions</h3>
                        <div class="quick-actions">
                            <button class="action-btn" onclick="showSection('registration')" ${!isRegistrationOpen ? 'disabled' : ''}>üìö Register</button>
                            <button class="action-btn" onclick="showSection('fees')">üí∞ Pay Fees</button>
                            <button class="action-btn" onclick="showSection('examCard')" ${!examEligible ? 'disabled' : ''}>üé´ Exam Card</button>
                            <button class="action-btn" onclick="downloadFeeStructure()">üìÑ Fee Structure</button>
                            <button class="action-btn" onclick="showSection('results')">üìä Results</button>
                            <button class="action-btn" onclick="showSection('hostel')">üè† Book Hostel</button>
                            <button class="action-btn" onclick="downloadRegistrationSlip()">üìã Reg Slip</button>
                            <button class="action-btn" onclick="showSection('profile')">üë§ Profile</button>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="card">
                        <h3>Notifications</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${notifications.map(n => `
                                <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                                    <p style="font-weight: 500;">${n.title}</p>
                                    <p style="font-size: 12px; color: var(--gray);">${n.time}</p>
                                </div>
                            `).join('')}
                            ${!examEligible ? `
                                <div style="padding: 10px; background: #fee2e2; border-radius: 8px; margin-top: 10px;">
                                    <p style="color: #991b1b;">‚ö†Ô∏è You are not eligible for exams. Clear fees and complete all CATs.</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== PROFILE ====================
        function renderProfile() {
            return `
                <h1 style="margin-bottom: 30px; color: var(--primary);">Student Profile</h1>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Personal Information</h3>
                        <div style="margin-top: 20px;">
                            <p><strong>Full Name:</strong> ${currentUser.name}</p>
                            <p><strong>Admission Number:</strong> ${currentUser.admission}</p>
                            <p><strong>Date of Birth:</strong> ${currentUser.dateOfBirth}</p>
                            <p><strong>Gender:</strong> ${currentUser.gender}</p>
                            <p><strong>Nationality:</strong> ${currentUser.nationality}</p>
                            <p><strong>Birth Certificate:</strong> ${currentUser.birthCertificate}</p>
                            <p><strong>ID/Passport:</strong> ${currentUser.idNumber}</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Academic Information</h3>
                        <div style="margin-top: 20px;">
                            <p><strong>Program:</strong> ${currentUser.program}</p>
                            <p><strong>Year of Study:</strong> ${currentUser.yearOfStudy}</p>
                            <p><strong>Year of Entry:</strong> ${currentUser.yearOfEntry}</p>
                            <p><strong>Expected Graduation:</strong> ${currentUser.expectedGraduation}</p>
                            <p><strong>Registration Status:</strong> <span class="badge badge-success">Active</span></p>
                            <p><strong>Mode of Study:</strong> Full-time</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Contact Information</h3>
                        <div style="margin-top: 20px;">
                            <p><strong>Email:</strong> ${currentUser.email}</p>
                            <p><strong>Phone:</strong> ${currentUser.phone}</p>
                            
                            <h4 style="margin: 20px 0 10px;">Emergency Contact</h4>
                            <p><strong>Name:</strong> Jane Kamau</p>
                            <p><strong>Relationship:</strong> Sister</p>
                            <p><strong>Phone:</strong> 0712345679</p>
                            <p><strong>Email:</strong> jane.kamau@gmail.com</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== FEES PAGE ====================
        function renderFees() {
            const totalFees = calculateTotalFees();
            const paidFees = calculatePaidFees();
            const balance = totalFees - paidFees;

            return `
                <h1 style="margin-bottom: 30px; color: var(--primary);">Fee Statement</h1>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>Fee Summary</h3>
                        <div style="font-size: 36px; color: ${balance > 0 ? 'var(--danger)' : 'var(--success)'}; margin: 20px 0;">
                            KES ${balance.toLocaleString()}
                        </div>
                        ${balance > 0 ? 
                            '<p class="badge badge-danger">Outstanding Balance</p>' :
                            '<p class="badge badge-success">Fees Cleared</p>'
                        }
                        
                        <div style="margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>Paid: KES ${paidFees.toLocaleString()}</span>
                                <span>Total: KES ${totalFees.toLocaleString()}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(paidFees/totalFees)*100}%"></div>
                            </div>
                            <p style="text-align: center; margin-top: 10px;">${((paidFees/totalFees)*100).toFixed(1)}% Paid</p>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button class="action-btn" style="flex: 1; background: var(--secondary);" onclick="openModal('mpesaModal')">
                                Pay via M-Pesa
                            </button>
                            <button class="action-btn" style="flex: 1;" onclick="downloadFeeStructure()">
                                üìÑ Fee Structure
                            </button>
                        </div>
                    </div>

                    <div class="card" style="grid-column: span 2;">
                        <h3>Fee Breakdown - ${SYSTEM_CONFIG.academicYear}</h3>
                        <table class="data-table">
                            <tr>
                                <td>Tuition (${totalCredits()} credits √ó KES 5,000)</td>
                                <td style="text-align: right;">KES ${(totalCredits() * 5000).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>Registration Fee</td>
                                <td style="text-align: right;">KES 5,000</td>
                            </tr>
                            <tr>
                                <td>Library Fee</td>
                                <td style="text-align: right;">KES 3,000</td>
                            </tr>
                            <tr>
                                <td>Computer Lab</td>
                                <td style="text-align: right;">KES 4,000</td>
                            </tr>
                            <tr>
                                <td>Activity Fee</td>
                                <td style="text-align: right;">KES 2,000</td>
                            </tr>
                            <tr>
                                <td>Medical Fee</td>
                                <td style="text-align: right;">KES 1,000</td>
                            </tr>
                            <tr>
                                <td>Caution Money (Refundable)</td>
                                <td style="text-align: right;">KES 5,000</td>
                            </tr>
                            <tr style="font-weight: bold; border-top: 2px solid var(--border);">
                                <td>Total Charged</td>
                                <td style="text-align: right;">KES ${totalFees.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="card" style="grid-column: span 2;">
                        <h3>Payment History</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Receipt No</th>
                                    <th>Description</th>
                                    <th>Method</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentUser.payments.map(p => `
                                    <tr>
                                        <td>${p.date}</td>
                                        <td>${p.receipt}</td>
                                        <td>${p.method}</td>
                                        <td>${p.method}</td>
                                        <td>KES ${p.amount.toLocaleString()}</td>
                                        <td><span class="badge badge-success">${p.status}</span></td>
                                        <td><button class="action-btn" style="padding: 5px;" onclick="downloadReceipt('${p.receipt}')">Download</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==================== REGISTRATION PAGE ====================
        function renderRegistration() {
            if (!isRegistrationOpen) {
                return `
                    <div class="card" style="text-align: center; padding: 50px;">
                        <h2 style="color: var(--danger);">Registration Period Closed</h2>
                        <p style="margin: 20px 0;">The registration deadline was ${new Date(SYSTEM_CONFIG.registrationDeadline).toLocaleDateString()}</p>
                        <p>Please contact the Registrar's Office for assistance.</p>
                    </div>
                `;
            }

            const totalCredits = cartUnits.reduce((sum, u) => sum + u.credits, 0);
            
            return `
                <h1 style="margin-bottom: 30px; color: var(--primary);">Course Registration - ${SYSTEM_CONFIG.currentSemester}</h1>
                
                <div class="period-banner">
                    <div>
                        <strong>Registration Period</strong>
                        <p>You can add/drop units until: ${new Date(SYSTEM_CONFIG.registrationDeadline).toLocaleDateString()}</p>
                    </div>
                    <div class="countdown" id="registrationCountdown"></div>
                </div>

                <div class="dashboard-grid">
                    <div class="card" style="grid-column: span 2;">
                        <h3>Available Units</h3>
                        <div class="course-grid">
                            ${availableUnits.map(unit => {
                                const inCart = cartUnits.some(u => u.code === unit.code);
                                const registered = currentUser.registeredUnits.some(u => u.code === unit.code);
                                const canAdd = !registered && !inCart && cartUnits.length < SYSTEM_CONFIG.maxUnits && (totalCredits + unit.credits) <= SYSTEM_CONFIG.maxCredits;
                                const prerequisitesMet = checkPrerequisites(unit.prerequisites);
                                
                                return `
                                    <div class="course-card">
                                        <div style="display: flex; justify-content: space-between;">
                                            <h4>${unit.code}</h4>
                                            <span class="badge badge-info">${unit.credits} cr</span>
                                        </div>
                                        <h3 style="margin: 10px 0;">${unit.title}</h3>
                                        <p style="font-size: 13px; color: var(--gray);">${unit.lecturer}</p>
                                        <p style="font-size: 13px;">${unit.schedule} ‚Ä¢ ${unit.room}</p>
                                        <div style="margin: 10px 0;">
                                            <span class="badge ${unit.enrolled < unit.capacity ? 'badge-success' : 'badge-warning'}">
                                                Slots: ${unit.enrolled}/${unit.capacity}
                                            </span>
                                            <span class="badge badge-info" style="margin-left: 5px;">${unit.type}</span>
                                        </div>
                                        ${unit.prerequisites.length > 0 ? `
                                            <p style="font-size: 12px;">
                                                Pre-req: ${unit.prerequisites.join(', ')}
                                                ${prerequisitesMet ? ' ‚úì' : ' ‚úó'}
                                            </p>
                                        ` : ''}
                                        ${registered ? 
                                            `<button class="action-btn" style="background: var(--success);" disabled>Registered</button>` :
                                            inCart ?
                                            `<button class="action-btn" onclick="removeFromCart('${unit.code}')">Drop Unit</button>` :
                                            `<button class="action-btn" onclick="addToCart('${unit.code}')" ${!canAdd || !prerequisitesMet ? 'disabled' : ''}>Add Unit</button>`
                                        }
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="card">
                        <h3>Registration Cart</h3>
                        <div style="margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Units: ${cartUnits.length}/${SYSTEM_CONFIG.maxUnits}</span>
                                <span>Credits: ${totalCredits}/${SYSTEM_CONFIG.maxCredits}</span>
                            </div>
                            <div class="progress-bar" style="margin-top: 10px;">
                                <div class="progress-fill" style="width: ${(totalCredits/SYSTEM_CONFIG.maxCredits)*100}%"></div>
                            </div>
                            <p style="font-size: 12px; margin-top: 5px;">Min: ${SYSTEM_CONFIG.minCredits} credits required</p>
                        </div>

                        <div style="max-height: 400px; overflow-y: auto;">
                            ${cartUnits.length > 0 ? cartUnits.map(unit => `
                                <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
                                    <div>
                                        <strong>${unit.code}</strong>
                                        <p style="font-size: 12px;">${unit.title}</p>
                                    </div>
                                    <button class="action-btn" style="padding: 5px;" onclick="removeFromCart('${unit.code}')">Drop</button>
                                </div>
                            `).join('') : '<p style="color: var(--gray); text-align: center;">Cart is empty</p>'}
                        </div>

                        <button class="action-btn" style="width: 100%; background: var(--secondary); margin-top: 20px;" 
                                onclick="confirmRegistration()" ${cartUnits.length === 0 || totalCredits < SYSTEM_CONFIG.minCredits ? 'disabled' : ''}>
                            Submit Registration
                        </button>
                        
                        ${totalCredits < SYSTEM_CONFIG.minCredits ? 
                            '<p class="badge badge-warning" style="display: block; text-align: center; margin-top: 10px;">Minimum credits not met</p>' : ''}
                    </div>
                </div>
            `;
        }

        // ==================== EXAM CARD PAGE ====================
        function renderExamCard() {
            const examEligible = checkExamEligibility();
            
            if (!examEligible) {
                return `
                    <div class="card" style="text-align: center; padding: 50px;">
                        <h2 style="color: var(--danger);">Exam Card Not Available</h2>
                        <p style="margin: 20px 0;">You are not eligible to generate an exam card.</p>
                        <div style="background: #fee2e2; padding: 20px; border-radius: 10px; text-align: left;">
                            <h4>Requirements not met:</h4>
                            <ul style="margin-top: 10px;">
                                ${currentUser.feeBalance > 0 ? '<li>‚ùå Outstanding fee balance</li>' : ''}
                                ${!currentUser.catsCompleted ? '<li>‚ùå CATs not completed</li>' : ''}
                                ${currentUser.registeredUnits.length === 0 ? '<li>‚ùå No units registered</li>' : ''}
                            </ul>
                        </div>
                        <button class="action-btn" style="margin-top: 20px;" onclick="showSection('fees')">Pay Fees</button>
                    </div>
                `;
            }

            return `
                <h1 style="margin-bottom: 30px; color: var(--primary);">Examination Card</h1>
                
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <div style="border: 2px solid var(--primary); padding: 30px; border-radius: 16px;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h2 style="color: var(--primary);">KAGEMA UNIVERSITY</h2>
                            <p style="color: var(--secondary);">Examination Card - ${SYSTEM_CONFIG.currentSemester}</p>
                        </div>

                        <div style="display: flex; gap: 30px; margin-bottom: 30px;">
                            <div style="width: 120px; height: 120px; background: var(--light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                                üë§
                            </div>
                            <div style="flex: 1;">
                                <p><strong>Name:</strong> ${currentUser.name}</p>
                                <p><strong>Admission:</strong> ${currentUser.admission}</p>
                                <p><strong>Program:</strong> ${currentUser.program}</p>
                                <p><strong>Year of Study:</strong> ${currentUser.yearOfStudy}</p>
                            </div>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr style="background: var(--primary); color: white;">
                                    <th style="padding: 10px;">Course Code</th>
                                    <th style="padding: 10px;">Course Title</th>
                                    <th style="padding: 10px;">Date</th>
                                    <th style="padding: 10px;">Time</th>
                                    <th style="padding: 10px;">Venue</th>
                                    <th style="padding: 10px;">Seat</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentUser.registeredUnits.map((unit, index) => `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid var(--border);">${unit.code}</td>
                                        <td style="padding: 10px; border: 1px solid var(--border);">${unit.title}</td>
                                        <td style="padding: 10px; border: 1px solid var(--border);">2024-04-${15 + index}</td>
                                        <td style="padding: 10px; border: 1px solid var(--border);">9:00 AM</td>
                                        <td style="padding: 10px; border: 1px solid var(--border);">Hall ${index + 1}</td>
                                        <td style="padding: 10px; border: 1px solid var(--border);">${index + 1}0${index + 1}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                            <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; text-align: center;">
                                <p><strong>Student's Signature</strong></p>
                                <div style="height: 40px;"></div>
                                <p>__________________</p>
                            </div>
                            <div style="padding: 20px; border: 1px solid var(--border); border-radius: 10px; text-align: center;">
                                <p><strong>Registrar's Signature</strong></p>
                                <div style="height: 40px;"></div>
                                <p>__________________</p>
                            </div>
                        </div>

                        <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="action-btn" onclick="downloadExamCardPDF()">üì• Download PDF</button>
                            <button class="action-btn" onclick="printExamCard()">üñ®Ô∏è Print</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== RESULTS PAGE ====================
        function renderResults() {
            const results = Object.entries(currentUser.results || {});

            return `
                <h1 style="margin-bottom: 30px; color: var(--primary);">Academic Results</h1>
                
                <div class="dashboard-grid">
                    <div class="card" style="grid-column: span 2;">
                        <h3>${SYSTEM_CONFIG.currentSemester} Results</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Title</th>
                                    <th>CAT 1</th>
                                    <th>CAT 2</th>
                                    <th>Assign</th>
                                    <th>Exam</th>
                                    <th>Total</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map(([code, r]) => `
                                    <tr>
                                        <td>${code}</td>
                                        <td>${r.title || code}</td>
                                        <td>${r.cat1}/30</td>
                                        <td>${r.cat2}/30</td>
                                        <td>${r.assignment}/20</td>
                                        <td>${r.exam}/100</td>
                                        <td><strong>${r.total}</strong></td>
                                        <td><span class="badge badge-success">${r.grade}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>GPA Summary</h3>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 48px; color: var(--primary);">${calculateGPA()}</div>
                            <p>Semester GPA</p>
                            <div style="font-size: 32px; margin-top: 20px;">${calculateCGPA()}</div>
                            <p>Cumulative GPA</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Download Results</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <button class="action-btn" onclick="downloadResultSlip()">üìÑ Download Result Slip</button>
                            <button class="action-btn" onclick="downloadTranscript()">üìä Download Transcript</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== DOWNLOADS PAGE ====================
        function renderDownloads() {
            return `
                <h1 style="margin-bottom: 30px; color: var(--primary);">Downloads</h1>
                
                <div class="dashboard-grid">
                    <div class="card" style="grid-column: span 3;">
                        <h3>Available Documents</h3>
                        <div class="course-grid">
                            <div class="course-card">
                                <h4>üìÑ Fee Structure</h4>
                                <p>Academic Year ${SYSTEM_CONFIG.academicYear}</p>
                                <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="downloadFeeStructure()">Download</button>
                            </div>
                            <div class="course-card">
                                <h4>üé´ Exam Card</h4>
                                <p>${SYSTEM_CONFIG.currentSemester}</p>
                                <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="downloadExamCard()">Download</button>
                            </div>
                            <div class="course-card">
                                <h4>üìä Result Slip</h4>
                                <p>${SYSTEM_CONFIG.currentSemester}</p>
                                <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="downloadResultSlip()">Download</button>
                            </div>
                            <div class="course-card">
                                <h4>üìã Registration Slip</h4>
                                <p>${SYSTEM_CONFIG.currentSemester}</p>
                                <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="downloadRegistrationSlip()">Download</button>
                            </div>
                            <div class="course-card">
                                <h4>üìú Transcript</h4>
                                <p>Official Academic Record</p>
                                <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="downloadTranscript()">Download</button>
                            </div>
                            <div class="course-card">
                                <h4>üí∞ Fee Statement</h4>
                                <p>Payment History</p>
                                <button class="action-btn" style="width: 100%; margin-top: 10px;" onclick="downloadFeeStatement()">Download</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== HELPER FUNCTIONS ====================
        function checkExamEligibility() {
            return currentUser.feeBalance === 0 && 
                   currentUser.catsCompleted && 
                   currentUser.registeredUnits.length > 0;
        }

        function calculateGPA() {
            const results = Object.values(currentUser.results || {});
            if (results.length === 0) return '0.0';
            
            const gradePoints = {
                'A': 5.0, 'B+': 4.5, 'B': 4.0, 'C+': 3.5,
                'C': 3.0, 'D+': 2.5, 'D': 2.0, 'E': 0.0
            };
            
            const total = results.reduce((sum, r) => sum + (gradePoints[r.grade] || 0), 0);
            return (total / results.length).toFixed(2);
        }

        function calculateCGPA() {
            // Simulate CGPA calculation
            return '3.6';
        }

        function totalCredits() {
            return currentUser.registeredUnits.reduce((sum, u) => sum + u.credits, 0);
        }

        function calculateTotalFees() {
            const credits = totalCredits();
            return (credits * 5000) + 5000 + 3000 + 4000 + 2000 + 1000 + 5000;
        }

        function calculatePaidFees() {
            return currentUser.payments.reduce((sum, p) => sum + p.amount, 0);
        }

        function checkPrerequisites(prereqs) {
            // Simulate prerequisite check
            return true;
        }

        // ==================== ACTION FUNCTIONS ====================
        function addToCart(code) {
            const unit = availableUnits.find(u => u.code === code);
            if (unit && cartUnits.length < SYSTEM_CONFIG.maxUnits) {
                cartUnits.push(unit);
                showToast(`${code} added to cart`, 'success');
                showSection('registration');
            }
        }

        function removeFromCart(code) {
            cartUnits = cartUnits.filter(u => u.code !== code);
            showToast(`${code} dropped from cart`, 'info');
            showSection('registration');
        }

        function confirmRegistration() {
            const totalCredits = cartUnits.reduce((sum, u) => sum + u.credits, 0);
            
            if (cartUnits.length === 0 || totalCredits < SYSTEM_CONFIG.minCredits) {
                showToast('Please select at least 12 credits', 'error');
                return;
            }

            // Add to registered units
            currentUser.registeredUnits = [...currentUser.registeredUnits, ...cartUnits];
            
            // Update enrolled counts
            cartUnits.forEach(unit => {
                const target = availableUnits.find(u => u.code === unit.code);
                if (target) target.enrolled++;
            });

            // Create registration slip content
            const slipContent = generateRegistrationSlip();
            
            // Show success
            cartUnits = [];
            showToast('Registration confirmed! Registration slip generated.', 'success');
            
            // Offer to download slip
            if (confirm('Registration successful! Download registration slip?')) {
                downloadRegistrationSlip();
            }
            
            showSection('dashboard');
        }

        function generateRegistrationSlip() {
            const slip = {
                university: 'Kagema University',
                student: currentUser.name,
                admission: currentUser.admission,
                semester: SYSTEM_CONFIG.currentSemester,
                units: currentUser.registeredUnits,
                date: new Date().toLocaleDateString()
            };
            return slip;
        }

        // ==================== DOWNLOAD FUNCTIONS ====================
        function downloadFeeStructure() {
            const content = `
KAGEMA UNIVERSITY - FEE STRUCTURE ${SYSTEM_CONFIG.academicYear}
========================================================

TUITION FEES:
- Per Credit Hour: KES 5,000
- Minimum Credits: ${SYSTEM_CONFIG.minCredits}
- Maximum Credits: ${SYSTEM_CONFIG.maxCredits}

MANDATORY FEES:
1. Registration Fee: KES 5,000
2. Library Fee: KES 3,000
3. Computer Lab Fee: KES 4,000
4. Activity Fee: KES 2,000
5. Medical Fee: KES 1,000
6. Caution Money (Refundable): KES 5,000

HOSTEL FEES (Per Semester):
- Single Room: KES 15,000
- Double Room: KES 12,000
- Meal Plan: KES 40,000

PAYMENT METHODS:
1. M-Pesa Paybill: 123456
2. Bank: KUST Account 1234567890
3. Credit Card (Online)

CONTACTS:
Finance Office: finance@kagemauniversity.ac.ke
Tel: 020-123-4567

Generated on: ${new Date().toLocaleString()}
            `;
            
            downloadFile('fee-structure.txt', content);
            showToast('Fee structure downloaded', 'success');
        }

        function downloadExamCard() {
            if (!checkExamEligibility()) {
                showToast('You are not eligible for exam card', 'error');
                return;
            }

            const content = `
KAGEMA UNIVERSITY - EXAMINATION CARD
====================================
${SYSTEM_CONFIG.currentSemester}

STUDENT DETAILS:
----------------
Name: ${currentUser.name}
Admission: ${currentUser.admission}
Program: ${currentUser.program}
Year: ${currentUser.yearOfStudy}

EXAM TIMETABLE:
---------------
${currentUser.registeredUnits.map((unit, i) => `
${unit.code} - ${unit.title}
Date: 2024-04-${15 + i}
Time: 9:00 AM
Venue: Hall ${i + 1}
Seat: ${i + 1}0${i + 1}
`).join('\n')}

STUDENT'S SIGNATURE: _________________
REGISTRAR'S SIGNATURE: _________________

Date: ${new Date().toLocaleDateString()}
            `;
            
            downloadFile('exam-card.txt', content);
            showToast('Exam card downloaded', 'success');
        }

        function downloadResultSlip() {
            const results = Object.entries(currentUser.results || {});
            
            const content = `
KAGEMA UNIVERSITY - RESULT SLIP
===============================
${SYSTEM_CONFIG.currentSemester}

STUDENT: ${currentUser.name}
ADMISSION: ${currentUser.admission}
PROGRAM: ${currentUser.program}

RESULTS:
--------
${results.map(([code, r]) => `
${code}: CAT1: ${r.cat1}/30, CAT2: ${r.cat2}/30, ASSIGN: ${r.assignment}/20, EXAM: ${r.exam}/100
TOTAL: ${r.total}% - GRADE: ${r.grade}
`).join('\n')}

SEMESTER GPA: ${calculateGPA()}
CUMULATIVE GPA: ${calculateCGPA()}

Generated on: ${new Date().toLocaleString()}
            `;
            
            downloadFile('result-slip.txt', content);
            showToast('Result slip downloaded', 'success');
        }

        function downloadRegistrationSlip() {
            const content = `
KAGEMA UNIVERSITY - REGISTRATION SLIP
=====================================
${SYSTEM_CONFIG.currentSemester}

STUDENT DETAILS:
----------------
Name: ${currentUser.name}
Admission: ${currentUser.admission}
Program: ${currentUser.program}
Year: ${currentUser.yearOfStudy}

REGISTERED UNITS:
-----------------
${currentUser.registeredUnits.map(u => `${u.code} - ${u.title} (${u.credits} credits)`).join('\n')}

TOTAL CREDITS: ${totalCredits()}

REGISTRAR'S SIGNATURE: _________________
DATE: ${new Date().toLocaleDateString()}
            `;
            
            downloadFile('registration-slip.txt', content);
            showToast('Registration slip downloaded', 'success');
        }

        function downloadTranscript() {
            const content = `
KAGEMA UNIVERSITY - ACADEMIC TRANSCRIPT
=======================================
OFFICIAL DOCUMENT

STUDENT INFORMATION:
--------------------
Name: ${currentUser.name}
Admission: ${currentUser.admission}
Program: ${currentUser.program}
Year of Entry: ${currentUser.yearOfEntry}
Expected Graduation: ${currentUser.expectedGraduation}

ACADEMIC RECORD:
----------------
${SYSTEM_CONFIG.currentSemester}:
${Object.entries(currentUser.results || {}).map(([code, r]) => 
    `${code}: ${r.grade} (${r.total}%)`
).join('\n')}

GPA: ${calculateGPA()}
CGPA: ${calculateCGPA()}

This is to certify that the above is a true record of academic performance.

REGISTRAR'S SIGNATURE: _________________
DATE: ${new Date().toLocaleDateString()}
UNIVERSITY SEAL

Generated on: ${new Date().toLocaleString()}
            `;
            
            downloadFile('transcript.txt', content);
            showToast('Transcript downloaded', 'success');
        }

        function downloadFeeStatement() {
            const totalFees = calculateTotalFees();
            const paidFees = calculatePaidFees();
            
            const content = `
KAGEMA UNIVERSITY - FEE STATEMENT
=================================
${SYSTEM_CONFIG.academicYear}

STUDENT: ${currentUser.name}
ADMISSION: ${currentUser.admission}

FEE BREAKDOWN:
--------------
Tuition (${totalCredits()} credits): KES ${(totalCredits() * 5000).toLocaleString()}
Registration Fee: KES 5,000
Library Fee: KES 3,000
Computer Lab: KES 4,000
Activity Fee: KES 2,000
Medical Fee: KES 1,000
Caution Money: KES 5,000
TOTAL CHARGED: KES ${totalFees.toLocaleString()}

PAYMENTS MADE:
--------------
${currentUser.payments.map(p => `${p.date}: KES ${p.amount.toLocaleString()} (${p.receipt})`).join('\n')}

BALANCE: KES ${(totalFees - paidFees).toLocaleString()}

Generated on: ${new Date().toLocaleString()}
            `;
            
            downloadFile('fee-statement.txt', content);
            showToast('Fee statement downloaded', 'success');
        }

        function downloadReceipt(receiptNo) {
            const payment = currentUser.payments.find(p => p.receipt === receiptNo);
            
            const content = `
KAGEMA UNIVERSITY - OFFICIAL RECEIPT
====================================

Receipt No: ${receiptNo}
Date: ${payment.date}
Student: ${currentUser.name}
Admission: ${currentUser.admission}

Amount: KES ${payment.amount.toLocaleString()}
Payment Method: ${payment.method}
Status: ${payment.status}

For: ${SYSTEM_CONFIG.academicYear} Fees

This is an electronically generated receipt.

Generated on: ${new Date().toLocaleString()}
            `;
            
            downloadFile(`receipt-${receiptNo}.txt`, content);
            showToast(`Receipt ${receiptNo} downloaded`, 'success');
        }

        function downloadExamCardPDF() {
            downloadExamCard();
        }

        function printExamCard() {
            window.print();
        }

        function downloadFile(filename, content) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        // ==================== PLACEHOLDER FUNCTIONS ====================
        function renderTimetable() { return '<h1>Timetable Page</h1>'; }
        function renderElearning() { return '<h1>eLearning Portal</h1>'; }
        function renderLibrary() { return '<h1>Library</h1>'; }
        function renderHostel() { return '<h1>Hostel Management</h1>'; }
        function renderHealth() { return '<h1>Health Services</h1>'; }
        function renderCareer() { return '<h1>Career Services</h1>'; }
        function renderRequests() { return '<h1>My Requests</h1>'; }

        function processMpesaPayment() {
            const phone = document.getElementById('mpesaPhone').value;
            const amount = document.getElementById('mpesaAmount').value;

            if (!phone || !amount) {
                showToast('Please fill all fields', 'error');
                return;
            }

            showToast('STK Push sent. Please check your phone and enter PIN.', 'info');
            
            setTimeout(() => {
                showToast(`Payment of KES ${amount} successful!`, 'success');
                closeModal('mpesaModal');
                currentUser.feeBalance -= parseInt(amount);
                if (currentSection === 'fees') {
                    showSection('fees');
                }
            }, 3000);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 150px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAdminLogin() {
            alert('Admin login would redirect to admin panel');
        }

        function loadNotifications() {
            notifications = [
                { title: 'Registration period ends in 5 days', time: '1 hour ago' },
                { title: 'Fee payment deadline approaching', time: '2 hours ago' },
                { title: 'Exam timetable released', time: '1 day ago' },
                { title: 'Library books due soon', time: '2 days ago' }
            ];
        }

        // Initialize
        init();

        // Make functions global
        window.login = login;
        window.logout = logout;
        window.showSection = showSection;
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.confirmRegistration = confirmRegistration;
        window.downloadFeeStructure = downloadFeeStructure;
        window.downloadExamCard = downloadExamCard;
        window.downloadResultSlip = downloadResultSlip;
        window.downloadRegistrationSlip = downloadRegistrationSlip;
        window.downloadTranscript = downloadTranscript;
        window.downloadFeeStatement = downloadFeeStatement;
        window.downloadReceipt = downloadReceipt;
        window.downloadExamCardPDF = downloadExamCardPDF;
        window.printExamCard = printExamCard;
        window.processMpesaPayment = processMpesaPayment;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.showAdminLogin = showAdminLogin;
    </script>
</body>
</html>