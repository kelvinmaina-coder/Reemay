<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="Kagema School Management System - Enterprise Edition v10.0 - Complete School Administration Platform">
    <meta name="keywords" content="school management, CBC, Kenya education, student records, fee management, report cards, staff management, inventory, library, transport, hostel">
    <meta name="author" content="Kagema School Systems">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Kagema School Management System - Enterprise Edition v10.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* =====================================================
           RESET & BASE STYLES
           ===================================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Primary Colors */
            --primary: #2E7D32;
            --primary-dark: #1B5E20;
            --primary-light: #4CAF50;
            --primary-very-light: #E8F5E9;
            
            /* Secondary Colors */
            --secondary: #1565C0;
            --secondary-dark: #0D47A1;
            --secondary-light: #42A5F5;
            
            /* Accent Colors */
            --accent: #FFB300;
            --accent-dark: #FF6F00;
            --accent-light: #FFE082;
            
            /* Status Colors */
            --success: #4CAF50;
            --success-light: #C8E6C9;
            --warning: #FF9800;
            --warning-light: #FFE0B2;
            --danger: #F44336;
            --danger-light: #FFCDD2;
            --info: #2196F3;
            --info-light: #BBDEFB;
            
            /* Neutral Colors */
            --background: #F5F7FA;
            --surface: #FFFFFF;
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-disabled: #9E9E9E;
            --border: #E0E0E0;
            --border-light: #F0F0F0;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            --shadow-xl: 0 12px 24px rgba(0,0,0,0.15);
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-circle: 50%;
            
            /* Font Sizes */
            --text-xs: 12px;
            --text-sm: 14px;
            --text-md: 16px;
            --text-lg: 18px;
            --text-xl: 20px;
            --text-xxl: 24px;
            --text-h1: 32px;
            --text-h2: 28px;
            --text-h3: 24px;
            --text-h4: 20px;
            
            /* Transitions */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* Z-index layers */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
            --z-toast: 1080;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            line-height: 1.3;
            color: var(--text-primary);
        }

        /* =====================================================
           SCROLLBAR STYLES
           ===================================================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: var(--radius-md);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-light) var(--background);
        }

        /* =====================================================
           LOGIN PAGE STYLES
           ===================================================== */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            padding: var(--spacing-md);
            position: relative;
            overflow: hidden;
        }

        .login-page::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: moveBackground 20s linear infinite;
            opacity: 0.3;
        }

        @keyframes moveBackground {
            0% { transform: translate(-25%, -25%) rotate(0deg); }
            100% { transform: translate(-25%, -25%) rotate(360deg); }
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 500px;
            padding: var(--spacing-xxl);
            position: relative;
            z-index: 1;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-logo {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-header h1 {
            color: var(--primary);
            font-size: var(--text-h2);
            margin-bottom: var(--spacing-xs);
            font-weight: 700;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .login-header small {
            display: block;
            margin-top: var(--spacing-xs);
            color: var(--text-secondary);
            font-size: var(--text-xs);
        }

        .login-form {
            margin-bottom: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            font-size: var(--text-sm);
            color: var(--text-primary);
        }

        .form-group label i {
            color: var(--primary);
            margin-right: var(--spacing-xs);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: inherit;
            transition: all var(--transition-fast);
            background: var(--surface);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: var(--danger);
        }

        .password-field {
            position: relative;
        }

        .password-field input {
            padding-right: 50px !important;
        }

        .toggle-password {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-secondary);
            transition: color var(--transition-fast);
            z-index: 2;
        }

        .toggle-password:hover {
            color: var(--primary);
        }

        .login-btn {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(46, 125, 50, 0.3);
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .demo-credentials {
            background: var(--primary-very-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .demo-credentials p {
            margin: var(--spacing-xs) 0;
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .demo-credentials strong {
            color: var(--primary);
        }

        /* =====================================================
           MAIN DASHBOARD LAYOUT
           ===================================================== */
        .dashboard {
            display: none;
            min-height: 100vh;
            background: var(--background);
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* =====================================================
           SIDEBAR STYLES
           ===================================================== */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: var(--z-fixed);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-normal);
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: var(--spacing-lg);
        }

        .sidebar-header h2 {
            font-size: var(--text-h4);
            margin-bottom: var(--spacing-xs);
            color: white;
        }

        .sidebar-header p {
            font-size: var(--text-xs);
            opacity: 0.8;
        }

        .user-profile-sidebar {
            background: rgba(255,255,255,0.1);
            padding: var(--spacing-lg);
            margin: var(--spacing-md);
            border-radius: var(--radius-lg);
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xxl);
            font-weight: bold;
            margin: 0 auto var(--spacing-sm);
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }

        .user-name {
            font-size: var(--text-md);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .user-role-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-md);
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-sm);
        }

        .user-status-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
        }

        .user-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: var(--radius-circle);
            border: 2px solid white;
        }

        .status-online {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .status-away {
            background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }

        .status-busy {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .status-offline {
            background: var(--text-disabled);
        }

        .status-select {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs);
            font-size: var(--text-xs);
            cursor: pointer;
        }

        .status-select option {
            color: var(--text-primary);
        }

        /* Navigation Menu */
        .nav-menu {
            list-style: none;
            padding: 0 var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .nav-section {
            margin: var(--spacing-lg) 0 var(--spacing-sm);
            padding-left: var(--spacing-md);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            color: rgba(255,255,255,0.8);
        }

        .nav-item {
            margin: var(--spacing-xs) 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            cursor: pointer;
            font-size: var(--text-sm);
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent);
            transform: scaleY(0);
            transition: transform var(--transition-fast);
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            padding-left: calc(var(--spacing-md) + 5px);
        }

        .nav-link:hover::before {
            transform: scaleY(1);
        }

        .nav-link.active {
            background: rgba(255,255,255,0.15);
            font-weight: 600;
        }

        .nav-link.active::before {
            transform: scaleY(1);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
            font-size: var(--text-md);
        }

        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 20px;
            padding: 2px 6px;
            font-size: var(--text-xs);
            margin-left: auto;
            min-width: 20px;
            text-align: center;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: var(--spacing-lg);
            margin-top: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .logout-btn-sidebar {
            width: 100%;
            padding: var(--spacing-md);
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            font-size: var(--text-sm);
        }

        .logout-btn-sidebar:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--danger);
        }

        /* =====================================================
           MAIN CONTENT AREA
           ===================================================== */
        .main-content {
            flex: 1;
            margin-left: 300px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: margin-left var(--transition-normal);
        }

        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }

        /* =====================================================
           TOP HEADER
           ===================================================== */
        .top-header {
            background: var(--surface);
            padding: var(--spacing-md) var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            height: 70px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: var(--text-xl);
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .menu-toggle:hover {
            background: var(--background);
            color: var(--primary);
        }

        .page-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .global-search {
            display: flex;
            align-items: center;
            background: var(--background);
            border-radius: 50px;
            padding: var(--spacing-xs) var(--spacing-lg);
            width: 350px;
            transition: all var(--transition-fast);
            border: 2px solid transparent;
        }

        .global-search:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .global-search i {
            color: var(--text-secondary);
            margin-right: var(--spacing-sm);
        }

        .global-search input {
            border: none;
            background: transparent;
            padding: var(--spacing-sm) 0;
            width: 100%;
            outline: none;
            font-size: var(--text-sm);
        }

        .global-search input::placeholder {
            color: var(--text-disabled);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .notification-icon:hover {
            background: var(--background);
        }

        .notification-icon i {
            font-size: var(--text-xl);
            color: var(--text-secondary);
        }

        .notification-badge-header {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: var(--text-xs);
            min-width: 18px;
            text-align: center;
        }

        .user-info-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--background);
            padding: var(--spacing-xs) var(--spacing-lg);
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .user-info-header:hover {
            background: var(--primary-very-light);
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-circle);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: var(--text-sm);
        }

        .user-details {
            line-height: 1.3;
        }

        .user-details .name {
            font-weight: 600;
            font-size: var(--text-sm);
        }

        .user-details .role {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        /* =====================================================
           CONTENT AREA
           ===================================================== */
        .content-area {
            padding: var(--spacing-xl);
            flex: 1;
        }

        /* =====================================================
           ALERT CONTAINER
           ===================================================== */
        #alertContainer {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: var(--z-toast);
            max-width: 400px;
        }

        .alert {
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            box-shadow: var(--shadow-lg);
            animation: slideInRight 0.3s ease;
            border-left: 4px solid;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert i {
            font-size: var(--text-lg);
        }

        .alert-success {
            background: var(--success-light);
            color: var(--primary-dark);
            border-left-color: var(--success);
        }

        .alert-warning {
            background: var(--warning-light);
            color: var(--warning);
            border-left-color: var(--warning);
        }

        .alert-danger {
            background: var(--danger-light);
            color: var(--danger);
            border-left-color: var(--danger);
        }

        .alert-info {
            background: var(--info-light);
            color: var(--info);
            border-left-color: var(--info);
        }

        /* =====================================================
           SECTION CONTENT
           ===================================================== */
        .section-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-content.active {
            display: block;
        }

        /* =====================================================
           CARD STYLES
           ===================================================== */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
            transition: all var(--transition-normal);
            border: 1px solid var(--border-light);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--background);
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--primary);
        }

        .card-title i {
            margin-right: var(--spacing-sm);
        }

        /* =====================================================
           KPI GRID
           ===================================================== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .kpi-card {
            background: var(--surface);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border-left: 5px solid var(--primary);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 50%, rgba(46,125,50,0.1) 100%);
            border-radius: 0 0 0 100%;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-card.warning { border-left-color: var(--warning); }
        .kpi-card.danger { border-left-color: var(--danger); }
        .kpi-card.info { border-left-color: var(--info); }

        .kpi-label {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-xs);
        }

        .kpi-value {
            font-size: var(--text-h2);
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
            margin-bottom: var(--spacing-xs);
        }

        .kpi-trend {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* =====================================================
           DASHBOARD GRID
           ===================================================== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--spacing-lg);
        }

        /* =====================================================
           TABLE STYLES
           ===================================================== */
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius-md);
            margin: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
        }

        th {
            background: var(--background);
            padding: var(--spacing-md);
            text-align: left;
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        tr:hover td {
            background: var(--background);
        }

        /* =====================================================
           BUTTON STYLES
           ===================================================== */
        .btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: var(--text-sm);
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: var(--radius-circle);
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: var(--text-xs);
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: var(--text-md);
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: var(--radius-circle);
        }

        .btn-icon i {
            margin: 0;
        }

        /* =====================================================
           FORM STYLES
           ===================================================== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            font-size: var(--text-sm);
            color: var(--text-primary);
        }

        .form-group label i {
            margin-right: var(--spacing-xs);
            color: var(--primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: inherit;
            transition: all var(--transition-fast);
            background: var(--surface);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: var(--danger);
        }

        .form-group .help-text {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .form-group .error-text {
            font-size: var(--text-xs);
            color: var(--danger);
            margin-top: var(--spacing-xs);
        }

        /* =====================================================
           SEARCH BAR
           ===================================================== */
        .search-bar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            min-width: 250px;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            transition: all var(--transition-fast);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .search-bar select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            min-width: 200px;
            background: var(--surface);
        }

        .search-bar select:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* =====================================================
           BADGE STYLES
           ===================================================== */
        .badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .badge-info {
            background: var(--info-light);
            color: var(--info);
        }

        /* Role Badges */
        .role-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: var(--text-xs);
            font-weight: 600;
        }

        .role-admin { background: #fff3e0; color: #e65100; }
        .role-headteacher { background: #fce4ec; color: #c2185b; }
        .role-dht { background: #e8f5e9; color: #2e7d32; }
        .role-teacher { background: #e3f2fd; color: #1565c0; }
        .role-secretary { background: #f3e5f5; color: #8e24aa; }
        .role-bursar { background: #fff3e0; color: #e65100; }

        /* Grade Badges */
        .grade-excellent {
            background: var(--success-light);
            color: var(--success);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
            font-size: var(--text-xs);
            font-weight: 600;
        }

        .grade-good {
            background: var(--info-light);
            color: var(--info);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
        }

        .grade-fair {
            background: var(--warning-light);
            color: var(--warning);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
        }

        .grade-poor {
            background: var(--danger-light);
            color: var(--danger);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 20px;
        }

        /* =====================================================
           TAB STYLES
           ===================================================== */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-light);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all var(--transition-fast);
            font-size: var(--text-sm);
            position: relative;
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* =====================================================
           MODAL STYLES
           ===================================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: var(--z-modal-backdrop);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideUp 0.3s ease;
            position: relative;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-lg {
            max-width: 900px;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--border-light);
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 1;
        }

        .modal-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--primary);
        }

        .modal-title i {
            margin-right: var(--spacing-sm);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-circle);
        }

        .close-btn:hover {
            color: var(--danger);
            background: var(--danger-light);
        }

        .modal-body {
            margin-bottom: var(--spacing-lg);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--border-light);
        }

        /* =====================================================
           CHAT STYLES
           ===================================================== */
        .chat-container {
            display: flex;
            height: 600px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-light);
        }

        .chat-sidebar {
            width: 300px;
            border-right: 1px solid var(--border-light);
            background: var(--background);
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
        }

        .chat-search {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
        }

        .chat-search input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: 50px;
            font-size: var(--text-sm);
        }

        .chat-search input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chat-users {
            flex: 1;
            overflow-y: auto;
        }

        .chat-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .chat-user:hover {
            background: rgba(46, 125, 50, 0.05);
        }

        .chat-user.active {
            background: rgba(46, 125, 50, 0.1);
            border-left: 3px solid var(--primary);
        }

        .chat-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-circle);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: var(--text-md);
            position: relative;
            flex-shrink: 0;
        }

        .chat-user-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: var(--radius-circle);
            border: 2px solid var(--surface);
        }

        .chat-user-info {
            flex: 1;
            min-width: 0;
        }

        .chat-user-name {
            font-weight: 600;
            font-size: var(--text-sm);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-user-role {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .chat-user-lastmsg {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-user-meta {
            text-align: right;
            font-size: var(--text-xs);
        }

        .chat-user-time {
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .chat-user-unread {
            background: var(--primary);
            color: white;
            border-radius: 20px;
            padding: 2px 6px;
            font-size: var(--text-xs);
            min-width: 20px;
            text-align: center;
            display: inline-block;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface);
        }

        .chat-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
        }

        .chat-header-info h3 {
            font-size: var(--text-md);
            margin-bottom: 2px;
        }

        .chat-header-info p {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .chat-header-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
            background: var(--background);
            display: flex;
            flex-direction: column;
        }

        .message {
            display: flex;
            margin-bottom: var(--spacing-md);
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-content {
            background: var(--surface);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 4px;
        }

        .message-text {
            font-size: var(--text-sm);
            margin-bottom: 2px;
        }

        .message-time {
            font-size: var(--text-xs);
            opacity: 0.7;
            text-align: right;
        }

        .message-status {
            font-size: var(--text-xs);
            margin-left: 2px;
        }

        .chat-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--spacing-sm);
            background: var(--surface);
        }

        .chat-footer input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: 25px;
            outline: none;
            font-size: var(--text-sm);
            transition: all var(--transition-fast);
        }

        .chat-footer input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        .chat-footer button {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-circle);
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-footer button:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .chat-footer button i {
            font-size: var(--text-md);
        }

        /* =====================================================
           VIDEO MEETING STYLES
           ===================================================== */
        .meeting-container {
            background: #1a1a1a;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            color: white;
        }

        .meeting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .meeting-participant {
            background: #2d2d2d;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            position: relative;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }

        .meeting-participant.speaking {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        .participant-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

        .participant-info {
            position: relative;
            z-index: 1;
        }

        .participant-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-circle);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-h3);
            font-weight: bold;
            margin: 0 auto var(--spacing-sm);
            border: 3px solid white;
        }

        .participant-name {
            font-weight: 600;
            font-size: var(--text-md);
            margin-bottom: 2px;
        }

        .participant-role {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .participant-status {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            width: 12px;
            height: 12px;
            border-radius: var(--radius-circle);
            border: 2px solid white;
        }

        .participant-audio-indicator {
            position: absolute;
            bottom: var(--spacing-sm);
            left: var(--spacing-sm);
            width: 30px;
            height: 30px;
            border-radius: var(--radius-circle);
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .participant-audio-indicator i {
            font-size: var(--text-sm);
        }

        .participant-audio-indicator.muted i {
            color: var(--danger);
        }

        .meeting-controls {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: center;
            flex-wrap: wrap;
            padding: var(--spacing-md);
            background: rgba(0,0,0,0.5);
            border-radius: 50px;
        }

        .meeting-control {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-circle);
            background: #2d2d2d;
            color: white;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-lg);
        }

        .meeting-control:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .meeting-control.active {
            background: var(--success);
        }

        .meeting-control.danger {
            background: var(--danger);
        }

        .meeting-control.danger:hover {
            background: #d32f2f;
        }

        /* =====================================================
           ANNOUNCEMENT STYLES
           ===================================================== */
        .announcement {
            background: var(--surface);
            border-left: 4px solid var(--primary);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
        }

        .announcement:hover {
            box-shadow: var(--shadow-lg);
            transform: translateX(5px);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }

        .announcement-author {
            font-weight: 600;
            color: var(--primary);
            font-size: var(--text-sm);
        }

        .announcement-date {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .announcement-title {
            font-size: var(--text-md);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
        }

        .announcement-content {
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .announcement-attachments {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-sm);
        }

        .attachment {
            background: var(--background);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .attachment:hover {
            background: var(--primary-very-light);
        }

        .announcement-footer {
            display: flex;
            gap: var(--spacing-lg);
            color: var(--text-secondary);
            font-size: var(--text-xs);
        }

        .announcement-footer span {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .announcement-footer span:hover {
            color: var(--primary);
        }

        .announcement-footer i {
            font-size: var(--text-sm);
        }

        /* =====================================================
           FILE SHARING STYLES
           ===================================================== */
        .file-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }

        .file-item:hover {
            background: var(--background);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            background: var(--background);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xl);
            color: var(--primary);
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 600;
            font-size: var(--text-sm);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            display: flex;
            gap: var(--spacing-md);
        }

        .file-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-shrink: 0;
        }

        /* =====================================================
           STAFF DIRECTORY STYLES
           ===================================================== */
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }

        .staff-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .staff-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .staff-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .staff-avatar {
            width: 100px;
            height: 100px;
            border-radius: var(--radius-circle);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-h2);
            font-weight: bold;
            margin: 0 auto var(--spacing-md);
            border: 4px solid white;
            box-shadow: var(--shadow-md);
        }

        .staff-name {
            font-weight: 600;
            font-size: var(--text-md);
            margin-bottom: 2px;
        }

        .staff-role {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .staff-department {
            font-size: var(--text-xs);
            background: var(--background);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 20px;
            display: inline-block;
            margin-bottom: var(--spacing-md);
        }

        .staff-contact {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }

        .staff-actions {
            display: flex;
            gap: var(--spacing-xs);
            justify-content: center;
        }

        .staff-actions button {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-circle);
            border: none;
            background: var(--background);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .staff-actions button:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* =====================================================
           PROGRESS BAR
           ===================================================== */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--background);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        /* =====================================================
           LOADING SPINNER
           ===================================================== */
        .loading {
            text-align: center;
            padding: var(--spacing-xl);
        }

        .spinner {
            border: 4px solid var(--background);
            border-top: 4px solid var(--primary);
            border-radius: var(--radius-circle);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =====================================================
           PAGINATION
           ===================================================== */
        .pagination {
            display: flex;
            gap: var(--spacing-xs);
            justify-content: center;
            margin-top: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .page-item {
            padding: var(--spacing-xs) var(--spacing-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 36px;
            text-align: center;
            font-size: var(--text-sm);
        }

        .page-item:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* =====================================================
           DROPDOWN MENU
           ===================================================== */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: var(--z-dropdown);
            display: none;
            border: 1px solid var(--border-light);
        }

        .dropdown:hover .dropdown-menu {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-item {
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--text-sm);
        }

        .dropdown-item:hover {
            background: var(--background);
            color: var(--primary);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-light);
            margin: var(--spacing-xs) 0;
        }

        /* =====================================================
           TOOLTIP
           ===================================================== */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--text-primary);
            color: white;
            font-size: var(--text-xs);
            border-radius: var(--radius-sm);
            white-space: nowrap;
            display: none;
            z-index: var(--z-tooltip);
        }

        [data-tooltip]:hover:before {
            display: block;
        }

        /* =====================================================
           PRINT STYLES
           ===================================================== */
        @media print {
            .sidebar,
            .top-header,
            .btn,
            .modal,
            .search-bar,
            .nav-menu,
            .logout-btn,
            .pagination,
            .chat-container,
            .meeting-container,
            .staff-actions,
            .file-actions,
            .alert,
            .tabs {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .report-card,
            .receipt,
            .results-slip {
                border: none;
                box-shadow: none;
                page-break-after: always;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }

            body {
                background: white;
            }
        }

        /* =====================================================
           RESPONSIVE DESIGN
           ===================================================== */

        /* Extra large devices (1400px and up) */
        @media (min-width: 1400px) {
            .container {
                max-width: 1320px;
                margin: 0 auto;
            }
        }

        /* Large devices (1200px to 1399px) */
        @media (max-width: 1399.98px) {
            .sidebar {
                width: 280px;
            }
            
            .main-content {
                margin-left: 280px;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Medium devices (992px to 1199px) */
        @media (max-width: 1199.98px) {
            .sidebar {
                width: 260px;
            }
            
            .main-content {
                margin-left: 260px;
            }
            
            .global-search {
                width: 280px;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .staff-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Tablet devices (768px to 991px) */
        @media (max-width: 991.98px) {
            .sidebar {
                width: 240px;
            }
            
            .main-content {
                margin-left: 240px;
            }
            
            .global-search {
                width: 220px;
            }
            
            .header-right {
                gap: var(--spacing-md);
            }
            
            .user-info-header .user-details {
                display: none;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .staff-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 300px;
            }
            
            .meeting-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Mobile devices (576px to 767px) */
        @media (max-width: 767.98px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .top-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .global-search {
                display: none;
            }
            
            .header-left {
                gap: var(--spacing-sm);
            }
            
            .page-title {
                font-size: var(--text-md);
            }
            
            .content-area {
                padding: var(--spacing-md);
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .staff-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .meeting-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: var(--spacing-md);
                width: 95%;
            }
            
            .table-responsive {
                margin: 0 calc(-1 * var(--spacing-md));
                width: calc(100% + var(--spacing-xl));
                padding: 0 var(--spacing-md);
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-bar input,
            .search-bar select {
                width: 100%;
                min-width: auto;
            }
        }

        /* Small mobile devices (less than 576px) */
        @media (max-width: 575.98px) {
            .login-container {
                padding: var(--spacing-lg);
            }
            
            .login-header h1 {
                font-size: var(--text-h3);
            }
            
            .login-logo {
                font-size: 48px;
            }
            
            .card {
                padding: var(--spacing-md);
            }
            
            .card-header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: flex-start;
            }
            
            .kpi-value {
                font-size: var(--text-h3);
            }
            
            th, td {
                padding: var(--spacing-xs);
                font-size: var(--text-xs);
            }
            
            .btn {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--text-xs);
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .modal-header {
                padding-bottom: var(--spacing-sm);
            }
            
            .modal-title {
                font-size: var(--text-md);
            }
            
            .tabs {
                gap: 5px;
            }
            
            .tab-btn {
                padding: var(--spacing-xs) var(--spacing-sm);
                font-size: var(--text-xs);
            }
        }

        /* Handle landscape orientation on mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar {
                overflow-y: auto;
                max-height: 100vh;
            }
            
            .login-container {
                padding: var(--spacing-md);
            }
            
            .login-logo {
                font-size: 32px;
                margin-bottom: var(--spacing-xs);
            }
            
            .login-header {
                margin-bottom: var(--spacing-md);
            }
            
            .form-group {
                margin-bottom: var(--spacing-sm);
            }
            
            .modal-content {
                max-height: 95vh;
            }
        }

        /* Fix for notched phones */
        @supports (padding: max(0px)) {
            .sidebar {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
            
            .top-header {
                padding-left: max(25px, env(safe-area-inset-left));
                padding-right: max(25px, env(safe-area-inset-right));
            }
            
            .content-area {
                padding-left: max(25px, env(safe-area-inset-left));
                padding-right: max(25px, env(safe-area-inset-right));
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --primary: #006400;
                --primary-dark: #004d00;
                --border: #000;
                --text-primary: #000;
            }
            
            .btn,
            .badge,
            .role-badge {
                border: 2px solid currentColor;
            }
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo"></div>
                <h1>KAGEMA SCHOOL</h1>
                <p>Enterprise Management System v10.0</p>
                <small>KICD Compliant | CBC Ready | 2026 | Secure Session</small>
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <div class="password-field">
                        <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="off">
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('loginPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group" style="display: none;">
                    <label><i class="fas fa-server"></i> API Base URL</label>
                    <input type="text" id="apiBaseUrl" placeholder="http://localhost:5000/api" value="http://localhost:5000/api">
                </div>
                <button type="button" class="login-btn" onclick="handleLogin(event)"><i class="fas fa-sign-in-alt"></i> Login to Dashboard</button>
            </form>

            <div class="demo-credentials">
                <p><strong> System Credentials:</strong></p>
                <p> <strong>Admin:</strong> admin / admin123</p>
                <p> <strong>Head Teacher:</strong> headteacher / head123</p>
                <p> <strong>Deputy Head:</strong> dht / dht123</p>
                <p> <strong>Teacher:</strong> teacher / teacher123</p>
                <p> <strong>Secretary:</strong> secretary / sec123</p>
                <p> <strong>Bursar:</strong> bursar / bursar123</p>
                <p><em>Each role has unique access permissions</em></p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="dashboard">
        <div class="dashboard-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2> KAGEMA</h2>
                    <p>School System v10.0</p>
                </div>

                <div class="user-profile-sidebar">
                    <div class="user-avatar" id="sidebarUserAvatar">KA</div>
                    <div class="user-name" id="sidebarUserName">Loading...</div>
                    <div class="user-role-badge" id="sidebarUserRole">Loading...</div>
                    <div class="user-id" id="sidebarUserId" style="font-size: 11px; margin-top: 5px; opacity: 0.8;"></div>
                    <div class="user-status-container">
                        <span class="user-status status-online" id="userStatus" title="Online"></span>
                        <select class="status-select" id="userStatusSelect" onchange="updateUserStatus(this.value)">
                            <option value="online">Online</option>
                            <option value="away">Away</option>
                            <option value="busy">Busy</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                </div>

                <!-- Dynamic Menu -->
                <div id="dynamicMenu" class="nav-menu"></div>

                <!-- Sidebar Footer -->
                <div class="sidebar-footer">
                    <button class="logout-btn-sidebar" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Top Header -->
                <header class="top-header">
                    <div class="header-left">
                        <button class="menu-toggle" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="page-title" id="pageTitle">Dashboard</div>
                    </div>
                    <div class="header-right">
                        <div class="global-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="globalSearch" placeholder="Search students, staff, messages...">
                        </div>
                        <div class="header-actions">
                            <div class="notification-icon" onclick="showNotifications()">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge-header" id="notificationCount">0</span>
                            </div>
                            <div class="user-info-header dropdown">
                                <div class="user-avatar-small" id="headerUserAvatar">KA</div>
                                <div class="user-details">
                                    <div class="name" id="headerUserName">Loading...</div>
                                    <div class="role" id="headerUserRole">Loading...</div>
                                </div>
                                <div class="dropdown-menu">
                                    <div class="dropdown-item" onclick="showSection('profile')">
                                        <i class="fas fa-user"></i> My Profile
                                    </div>
                                    <div class="dropdown-item" onclick="showSection('settings')">
                                        <i class="fas fa-cog"></i> Settings
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-item" onclick="logout()">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Content Area -->
                <div class="content-area">
                    <div id="alertContainer"></div>

                    <!-- Dashboard Section -->
                    <section id="dashboard" class="section-content active">
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-label"><i class="fas fa-users"></i> Total Students</div>
                                <div class="kpi-value" id="totalStudents">0</div>
                                <div class="kpi-trend" id="studentTrend">Loading...</div>
                            </div>
                            <div class="kpi-card info">
                                <div class="kpi-label"><i class="fas fa-chalkboard-teacher"></i> Active Staff</div>
                                <div class="kpi-value" id="totalStaff">0</div>
                                <div class="kpi-trend">Teachers & Admin</div>
                            </div>
                            <div class="kpi-card warning">
                                <div class="kpi-label"><i class="fas fa-coins"></i> Fee Collection</div>
                                <div class="kpi-value" id="feeCollection">0%</div>
                                <div class="progress-bar" style="margin-top: 10px;">
                                    <div class="progress-fill" id="feeProgress" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="kpi-card danger">
                                <div class="kpi-label"><i class="fas fa-exclamation-triangle"></i> Below Expectations</div>
                                <div class="kpi-value" id="belowExpectations">0</div>
                                <div class="kpi-trend">Need Intervention</div>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-user-graduate"></i> Recent Students</h3>
                                    <button class="btn btn-primary btn-sm" onclick="showSection('students')">
                                        <i class="fas fa-plus"></i> Add Student
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Adm No</th>
                                                <th>Name</th>
                                                <th>Grade</th>
                                                <th>Stream</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentStudents"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Fee Collection Status</h3>
                                    <button class="btn btn-primary btn-sm" onclick="showSection('finance')">
                                        <i class="fas fa-eye"></i> View All
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>Balance</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="feeStatus"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-exclamation-circle"></i> Performance Alerts</h3>
                                </div>
                                <div class="table-responsive">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>Subject</th>
                                                <th>Score</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="performanceAlerts"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-bolt"></i> Quick Actions</h3>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <button class="btn btn-primary" onclick="showSection('gradeEntry')">
                                        <i class="fas fa-pen"></i> Enter Marks
                                    </button>
                                    <button class="btn btn-success" onclick="showSection('finance')">
                                        <i class="fas fa-money-bill"></i> Record Payment
                                    </button>
                                    <button class="btn btn-info" onclick="showSection('reports')">
                                        <i class="fas fa-file-pdf"></i> Generate Reports
                                    </button>
                                    <button class="btn btn-warning" onclick="showSection('communication')">
                                        <i class="fas fa-comments"></i> Send Message
                                    </button>
                                    <button class="btn btn-secondary" onclick="showSection('internalChat')">
                                        <i class="fas fa-comment-dots"></i> Staff Chat
                                    </button>
                                    <button class="btn btn-danger" onclick="showSection('videoMeeting')">
                                        <i class="fas fa-video"></i> Start Meeting
                                    </button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Upcoming Events</h3>
                                </div>
                                <div id="upcomingEvents" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Events will be loaded here -->
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-bullhorn"></i> Recent Announcements</h3>
                                    <button class="btn btn-primary btn-sm" onclick="showSection('announcements')">
                                        <i class="fas fa-eye"></i> View All
                                    </button>
                                </div>
                                <div id="recentAnnouncements" style="max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </section>

                    <!-- User Management Section -->
                    <section id="userManagement" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-users-cog"></i> User Management</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-users"></i> System Users</h3>
                                <button class="btn btn-primary" onclick="openModal('addUserModal')">
                                    <i class="fas fa-plus"></i> Register New User
                                </button>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="userSearch" placeholder="Search by name, username, or role..." onkeyup="filterUsers()">
                                <select id="roleFilter" onchange="filterUsers()">
                                    <option value="">All Roles</option>
                                    <option value="admin">Administrator</option>
                                    <option value="headteacher">Head Teacher</option>
                                    <option value="dht">Deputy Head Teacher</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="secretary">Secretary</option>
                                    <option value="bursar">Bursar</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Name</th>
                                            <th>Role</th>
                                            <th>Professional ID</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody"></tbody>
                                </table>
                            </div>

                            <div class="pagination" id="userPagination"></div>
                        </div>
                    </section>

                    <!-- Students Section -->
                    <section id="students" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-user-graduate"></i> Student Management</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-list"></i> All Students</h3>
                                <div>
                                    <button class="btn btn-success btn-sm" onclick="exportData('students')">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="openModal('addStudentModal')">
                                        <i class="fas fa-plus"></i> Register Student
                                    </button>
                                </div>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="studentSearch" placeholder="Search by name, admission, or UPI..." onkeyup="filterStudents()">
                                <select id="gradeFilter" onchange="filterStudents()">
                                    <option value="">All Grades</option>
                                    <option value="Grade 1">Grade 1</option>
                                    <option value="Grade 2">Grade 2</option>
                                    <option value="Grade 3">Grade 3</option>
                                    <option value="Grade 4">Grade 4</option>
                                    <option value="Grade 5">Grade 5</option>
                                    <option value="Grade 6">Grade 6</option>
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                    <option value="Grade 9">Grade 9</option>
                                </select>
                                <select id="streamFilter" onchange="filterStudents()">
                                    <option value="">All Streams</option>
                                    <option value="East">East</option>
                                    <option value="West">West</option>
                                    <option value="North">North</option>
                                    <option value="South">South</option>
                                </select>
                                <select id="statusFilter" onchange="filterStudents()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="graduated">Graduated</option>
                                    <option value="transferred">Transferred</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table id="studentsTable">
                                    <thead>
                                        <tr>
                                            <th>Adm No</th>
                                            <th>Name</th>
                                            <th>Grade</th>
                                            <th>Stream</th>
                                            <th>UPI</th>
                                            <th>Parent Phone</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody"></tbody>
                                </table>
                            </div>

                            <div class="pagination" id="studentPagination"></div>
                        </div>
                    </section>

                    <!-- Grade Entry Section -->
                    <section id="gradeEntry" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-pen-fancy"></i> Enter Student Marks</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-filter"></i> Select Assessment Details</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label><i class="fas fa-layer-group"></i> Grade</label>
                                    <select id="gradeSelect" class="form-control" onchange="loadClassStreams()">
                                        <option value="">Select Grade</option>
                                        <option value="Grade 1">Grade 1</option>
                                        <option value="Grade 2">Grade 2</option>
                                        <option value="Grade 3">Grade 3</option>
                                        <option value="Grade 4">Grade 4</option>
                                        <option value="Grade 5">Grade 5</option>
                                        <option value="Grade 6">Grade 6</option>
                                        <option value="Grade 7">Grade 7</option>
                                        <option value="Grade 8">Grade 8</option>
                                        <option value="Grade 9">Grade 9</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-stream"></i> Stream</label>
                                    <select id="streamSelect" class="form-control" onchange="loadSubjectStudents()">
                                        <option value="">Select Stream</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-book"></i> Subject</label>
                                    <select id="subjectSelect" class="form-control" onchange="loadSubjectStudents()">
                                        <option value="">Select Subject</option>
                                        <option value="Mathematics">Mathematics</option>
                                        <option value="English">English</option>
                                        <option value="Kiswahili">Kiswahili</option>
                                        <option value="Science">Integrated Science</option>
                                        <option value="Social Studies">Social Studies</option>
                                        <option value="CRE">CRE</option>
                                        <option value="IRE">IRE</option>
                                        <option value="HRE">HRE</option>
                                        <option value="Agriculture">Agriculture</option>
                                        <option value="Computer">Computer Science</option>
                                        <option value="Business">Business Studies</option>
                                        <option value="Home Science">Home Science</option>
                                        <option value="French">French</option>
                                        <option value="German">German</option>
                                        <option value="PE">PE & Sports</option>
                                        <option value="Performing Arts">Performing Arts</option>
                                        <option value="Visual Arts">Visual Arts</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label><i class="fas fa-clipboard-list"></i> Assessment Type</label>
                                    <select id="assessmentType" class="form-control">
                                        <option value="cat1">CAT 1</option>
                                        <option value="cat2">CAT 2</option>
                                        <option value="cat3">CAT 3</option>
                                        <option value="endterm">End Term Exam</option>
                                        <option value="project">Project</option>
                                        <option value="assignment">Assignment</option>
                                        <option value="practical">Practical</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-calendar-alt"></i> Term</label>
                                    <select id="termSelect" class="form-control">
                                        <option value="Term 1, 2026">Term 1, 2026</option>
                                        <option value="Term 2, 2026">Term 2, 2026</option>
                                        <option value="Term 3, 2026">Term 3, 2026</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-sync"></i> </label>
                                    <button class="btn btn-primary btn-block" onclick="loadSubjectStudents()" style="margin-top: 24px;">
                                        <i class="fas fa-sync"></i> Load Students
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card" id="gradeEntryCard" style="display: none;">
                            <div class="card-header">
                                <h3 class="card-title" id="gradeEntryTitle">Enter Scores</h3>
                                <div>
                                    <button class="btn btn-success" onclick="saveAllGrades()">
                                        <i class="fas fa-save"></i> Save All
                                    </button>
                                    <button class="btn btn-info" onclick="downloadGradeTemplate()">
                                        <i class="fas fa-download"></i> Template
                                    </button>
                                    <button class="btn btn-warning" onclick="uploadGrades()">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="score-entry-table">
                                    <thead>
                                        <tr>
                                            <th>Adm No</th>
                                            <th>Student Name</th>
                                            <th>Score (0-100)</th>
                                            <th>Grade</th>
                                            <th>Descriptor</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gradeEntryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Finance Section -->
                    <section id="finance" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-coins"></i> Finance Management</h2>
                        
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-label">Total Expected Fees</div>
                                <div class="kpi-value" id="totalExpected">KES 0</div>
                            </div>
                            <div class="kpi-card info">
                                <div class="kpi-label">Collected</div>
                                <div class="kpi-value" id="totalCollected">KES 0</div>
                            </div>
                            <div class="kpi-card warning">
                                <div class="kpi-label">Outstanding</div>
                                <div class="kpi-value" id="totalOutstanding">KES 0</div>
                            </div>
                            <div class="kpi-card">
                                <div class="kpi-label">Collection Rate</div>
                                <div class="kpi-value" id="collectionRate">0%</div>
                                <div class="progress-bar" style="margin-top: 10px;">
                                    <div class="progress-fill" id="collectionProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-file-invoice"></i> Fee Structure</h3>
                                <button class="btn btn-primary" onclick="openModal('feeStructureModal')">
                                    <i class="fas fa-plus"></i> Add Fee Structure
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Grade</th>
                                            <th>Tuition</th>
                                            <th>Boarding</th>
                                            <th>Transport</th>
                                            <th>Uniform</th>
                                            <th>Activities</th>
                                            <th>Levies</th>
                                            <th>Total</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feeStructureBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-receipt"></i> Fee Records</h3>
                                <button class="btn btn-primary" onclick="openModal('recordPaymentModal')">
                                    <i class="fas fa-plus"></i> Record Payment
                                </button>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="feeSearch" placeholder="Search by student name or admission..." onkeyup="filterFeeRecords()">
                                <select id="feeStatusFilter" onchange="filterFeeRecords()">
                                    <option value="">All Status</option>
                                    <option value="paid">Paid</option>
                                    <option value="partial">Partial</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table id="feeTable">
                                    <thead>
                                        <tr>
                                            <th>Adm No</th>
                                            <th>Student Name</th>
                                            <th>Grade</th>
                                            <th>Total Fee</th>
                                            <th>Paid</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feeTableBody"></tbody>
                                </table>
                            </div>

                            <div class="pagination" id="feePagination"></div>
                        </div>
                    </section>

                    <!-- Reports Section -->
                    <section id="reports" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> Reports Generation</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-file-pdf"></i> Generate Report Card</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Select Student</label>
                                    <select id="reportStudent" class="form-control">
                                        <option value="">-- Select Student --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Term</label>
                                    <select id="reportTerm" class="form-control">
                                        <option value="Term 1, 2026">Term 1, 2026</option>
                                        <option value="Term 2, 2026">Term 2, 2026</option>
                                        <option value="Term 3, 2026">Term 3, 2026</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-block" onclick="generateStudentReportCard()">
                                <i class="fas fa-file-pdf"></i> Generate Report Card
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-layer-group"></i> Bulk Report Cards by Class</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Grade</label>
                                    <select id="bulkGrade" class="form-control">
                                        <option value="">Select Grade</option>
                                        <option value="Grade 1">Grade 1</option>
                                        <option value="Grade 2">Grade 2</option>
                                        <option value="Grade 3">Grade 3</option>
                                        <option value="Grade 4">Grade 4</option>
                                        <option value="Grade 5">Grade 5</option>
                                        <option value="Grade 6">Grade 6</option>
                                        <option value="Grade 7">Grade 7</option>
                                        <option value="Grade 8">Grade 8</option>
                                        <option value="Grade 9">Grade 9</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Stream</label>
                                    <select id="bulkStream" class="form-control">
                                        <option value="">Select Stream</option>
                                        <option value="East">East</option>
                                        <option value="West">West</option>
                                        <option value="North">North</option>
                                        <option value="South">South</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Term</label>
                                    <select id="bulkTerm" class="form-control">
                                        <option value="Term 1, 2026">Term 1, 2026</option>
                                        <option value="Term 2, 2026">Term 2, 2026</option>
                                        <option value="Term 3, 2026">Term 3, 2026</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-block" onclick="generateBulkReportCards()">
                                <i class="fas fa-file-pdf"></i> Generate All Report Cards
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-file-invoice"></i> Generate Fee Statement</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Select Student</label>
                                    <select id="statementStudent" class="form-control">
                                        <option value="">-- Select Student --</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-block" onclick="generateFeeStatement()">
                                <i class="fas fa-file-invoice"></i> Generate Fee Statement
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-line"></i> Class Performance Summary</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Grade</label>
                                    <select id="summaryGrade" class="form-control">
                                        <option value="">Select Grade</option>
                                        <option value="Grade 1">Grade 1</option>
                                        <option value="Grade 2">Grade 2</option>
                                        <option value="Grade 3">Grade 3</option>
                                        <option value="Grade 4">Grade 4</option>
                                        <option value="Grade 5">Grade 5</option>
                                        <option value="Grade 6">Grade 6</option>
                                        <option value="Grade 7">Grade 7</option>
                                        <option value="Grade 8">Grade 8</option>
                                        <option value="Grade 9">Grade 9</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Stream</label>
                                    <select id="summaryStream" class="form-control">
                                        <option value="">Select Stream</option>
                                        <option value="East">East</option>
                                        <option value="West">West</option>
                                        <option value="North">North</option>
                                        <option value="South">South</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Term</label>
                                    <select id="summaryTerm" class="form-control">
                                        <option value="Term 1, 2026">Term 1, 2026</option>
                                        <option value="Term 2, 2026">Term 2, 2026</option>
                                        <option value="Term 3, 2026">Term 3, 2026</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-info btn-block" onclick="generateClassSummary()">
                                <i class="fas fa-chart-bar"></i> Generate Class Summary
                            </button>
                        </div>

                        <div id="reportContainer" style="margin-top: 20px;"></div>
                    </section>

                    <!-- Communication Section -->
                    <section id="communication" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-comments"></i> Parent Communication</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-paper-plane"></i> Send Message to Parents</h3>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="parentSearch" placeholder="Search student by name or admission..." onkeyup="searchParents()">
                                <button class="btn btn-primary" onclick="searchParents()"><i class="fas fa-search"></i> Search</button>
                                <button class="btn btn-secondary" onclick="loadAllParents()"><i class="fas fa-users"></i> Load All</button>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-user-check"></i> Select Students</label>
                                <select id="messageStudents" multiple class="form-control" style="height: 200px;"></select>
                                <small class="help-text">Hold Ctrl/Cmd to select multiple. Parent phone numbers shown.</small>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-bolt"></i> Quick Select</label>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-sm btn-info" onclick="selectAllStudents()">Select All Students</button>
                                    <button class="btn btn-sm btn-info" onclick="selectClassStudents()">Select My Class</button>
                                    <button class="btn btn-sm btn-info" onclick="selectGradeStudents()">Select Whole Grade</button>
                                    <button class="btn btn-sm btn-info" onclick="selectStreamStudents()">Select Whole Stream</button>
                                    <button class="btn btn-sm btn-warning" onclick="clearSelection()">Clear Selection</button>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label><i class="fas fa-comment-dots"></i> Message Type</label>
                                    <select id="messageType" class="form-control" onchange="updateMessageTemplate()">
                                        <option value="sms">SMS</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="email">Email</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label><i class="fas fa-file-alt"></i> Template</label>
                                    <select id="messageTemplate" class="form-control" onchange="loadMessageTemplate()">
                                        <option value="fee">Fee Reminder</option>
                                        <option value="exam">Exam Notice</option>
                                        <option value="meeting">Parent Meeting</option>
                                        <option value="performance">Performance Alert</option>
                                        <option value="graduation">Graduation</option>
                                        <option value="report">Report Card Ready</option>
                                        <option value="holiday">Holiday Notice</option>
                                        <option value="emergency">Emergency Alert</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-envelope"></i> Message</label>
                                <textarea id="messageContent" class="form-control" rows="6"></textarea>
                                <div class="help-text" id="messageCharCount">0 characters</div>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="includeBothParents"> Include both parents where available
                                </label>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Recipients Count: <span id="recipientCount">0</span> parents</label>
                            </div>

                            <button class="btn btn-primary btn-lg btn-block" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i> Send Message
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history"></i> Message History</h3>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Recipients</th>
                                            <th>Message</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="messageHistory"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="messagePagination"></div>
                        </div>
                    </section>

                    <!-- Internal Chat Section -->
                    <section id="internalChat" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-comment-dots"></i> Staff Communication</h2>
                        
                        <div class="chat-container">
                            <div class="chat-sidebar">
                                <div class="chat-sidebar-header">
                                    <h4><i class="fas fa-users"></i> Online Staff</h4>
                                </div>
                                <div class="chat-search">
                                    <input type="text" id="chatSearch" placeholder="Search staff..." onkeyup="searchChatUsers()">
                                </div>
                                <div class="chat-users" id="chatUsers"></div>
                            </div>
                            <div class="chat-main">
                                <div class="chat-header">
                                    <div class="chat-header-info">
                                        <h3 id="chatUserName">Select a user to start chatting</h3>
                                        <p id="chatUserStatus"></p>
                                    </div>
                                    <div class="chat-header-actions">
                                        <button class="btn btn-sm btn-info" onclick="startVideoCall()" title="Start Video Call" data-tooltip="Start Video Call">
                                            <i class="fas fa-video"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="shareFile()" title="Share File" data-tooltip="Share File">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="viewChatHistory()" title="View History" data-tooltip="View History">
                                            <i class="fas fa-history"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="chat-messages" id="chatMessages"></div>
                                <div class="chat-footer">
                                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                                    <button onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Video Meeting Section -->
                    <section id="videoMeeting" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-video"></i> Video Meeting</h2>
                        
                        <div class="meeting-container">
                            <div class="meeting-grid" id="meetingParticipants">
                                <!-- Participants will be added here -->
                            </div>
                            <div class="meeting-controls">
                                <button class="meeting-control" onclick="toggleMic()" title="Mute/Unmute" data-tooltip="Mute/Unmute">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="meeting-control" onclick="toggleCamera()" title="Start/Stop Camera" data-tooltip="Start/Stop Camera">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button class="meeting-control" onclick="shareScreen()" title="Share Screen" data-tooltip="Share Screen">
                                    <i class="fas fa-desktop"></i>
                                </button>
                                <button class="meeting-control" onclick="inviteParticipants()" title="Invite" data-tooltip="Invite">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                <button class="meeting-control" onclick="toggleChat()" title="Chat" data-tooltip="Chat">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button class="meeting-control" onclick="recordMeeting()" title="Record" data-tooltip="Record">
                                    <i class="fas fa-record-vinyl"></i>
                                </button>
                                <button class="meeting-control" onclick="toggleParticipants()" title="Participants" data-tooltip="Participants">
                                    <i class="fas fa-users"></i>
                                </button>
                                <button class="meeting-control" onclick="shareWhiteboard()" title="Whiteboard" data-tooltip="Whiteboard">
                                    <i class="fas fa-chalkboard"></i>
                                </button>
                                <button class="meeting-control danger" onclick="endMeeting()" title="End Meeting" data-tooltip="End Meeting">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                            </div>
                            <div id="meetingChat" style="display: none; margin-top: 20px;">
                                <div class="chat-messages" style="height: 200px; background: #2d2d2d;"></div>
                                <div class="chat-footer" style="background: #2d2d2d;">
                                    <input type="text" placeholder="Type message..." style="background: #3d3d3d; color: white;">
                                    <button style="background: var(--primary);">Send</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Announcements Section -->
                    <section id="announcements" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-bullhorn"></i> Announcements</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-plus-circle"></i> Create Announcement</h3>
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="announcementTitle" class="form-control" placeholder="Enter announcement title">
                            </div>
                            <div class="form-group">
                                <label>Content</label>
                                <textarea id="announcementContent" class="form-control" rows="4" placeholder="Write your announcement..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Audience</label>
                                    <select id="announcementAudience" class="form-control">
                                        <option value="all">All Staff</option>
                                        <option value="teachers">Teachers Only</option>
                                        <option value="admin">Admin Only</option>
                                        <option value="headteacher">Head Teacher & Deputy</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select id="announcementPriority" class="form-control">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Attachments</label>
                                <input type="file" id="announcementFiles" multiple class="form-control">
                            </div>
                            <button class="btn btn-primary btn-block" onclick="postAnnouncement()">
                                <i class="fas fa-bullhorn"></i> Post Announcement
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-list"></i> Recent Announcements</h3>
                                <div>
                                    <select id="announcementFilter" onchange="filterAnnouncements()">
                                        <option value="all">All</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month">This Month</option>
                                    </select>
                                </div>
                            </div>
                            <div id="announcementsList"></div>
                            <div class="pagination" id="announcementPagination"></div>
                        </div>
                    </section>

                    <!-- Staff Directory Section -->
                    <section id="staffDirectory" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-address-book"></i> Staff Directory</h2>
                        
                        <div class="search-bar">
                            <input type="text" id="directorySearch" placeholder="Search by name, role, department..." onkeyup="filterDirectory()">
                            <select id="departmentFilter" onchange="filterDirectory()">
                                <option value="">All Departments</option>
                                <option value="Administration">Administration</option>
                                <option value="Academics">Academics</option>
                                <option value="Finance">Finance</option>
                                <option value="Support">Support</option>
                            </select>
                        </div>

                        <div class="staff-grid" id="staffDirectoryGrid"></div>
                        <div class="pagination" id="directoryPagination"></div>
                    </section>

                    <!-- Staff Management Section -->
                    <section id="staffManagement" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-chalkboard-teacher"></i> Staff Management</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-list"></i> All Staff Members</h3>
                                <button class="btn btn-primary" onclick="openModal('addStaffModal')">
                                    <i class="fas fa-plus"></i> Add Staff
                                </button>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="staffSearch" placeholder="Search by name, TSC, role..." onkeyup="filterStaff()">
                                <select id="staffRoleFilter" onchange="filterStaff()">
                                    <option value="">All Roles</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="headteacher">Head Teacher</option>
                                    <option value="dht">Deputy Head</option>
                                    <option value="secretary">Secretary</option>
                                    <option value="bursar">Bursar</option>
                                    <option value="librarian">Librarian</option>
                                    <option value="driver">Driver</option>
                                    <option value="matron">Matron</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>TSC No</th>
                                            <th>Name</th>
                                            <th>Role</th>
                                            <th>Department</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staffTableBody"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="staffPagination"></div>
                        </div>
                    </section>

                    <!-- Alumni Section -->
                    <section id="alumni" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-graduation-cap"></i> Alumni & Transferred Students</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history"></i> Former Students</h3>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="alumniSearch" placeholder="Search by name or admission..." onkeyup="filterAlumni()">
                                <select id="alumniYearFilter" onchange="filterAlumni()">
                                    <option value="">All Years</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Adm No</th>
                                            <th>Name</th>
                                            <th>Last Grade</th>
                                            <th>Stream</th>
                                            <th>Year Left</th>
                                            <th>Reason</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alumniTableBody"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="alumniPagination"></div>
                        </div>
                    </section>

                    <!-- Inventory Section -->
                    <section id="inventory" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-boxes"></i> Inventory Management</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-list"></i> School Inventory</h3>
                                <button class="btn btn-primary" onclick="openModal('addInventoryModal')">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="inventorySearch" placeholder="Search items..." onkeyup="filterInventory()">
                                <select id="categoryFilter" onchange="filterInventory()">
                                    <option value="">All Categories</option>
                                    <option value="Furniture">Furniture</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Books">Books</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Stationery">Stationery</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Item Code</th>
                                            <th>Item Name</th>
                                            <th>Category</th>
                                            <th>Quantity</th>
                                            <th>Unit</th>
                                            <th>Location</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody"></tbody>
                                </table>
                            </div>
                            <div class="pagination" id="inventoryPagination"></div>
                        </div>
                    </section>

                    <!-- Transport Section -->
                    <section id="transport" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-bus"></i> Transport Management</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-route"></i> Routes & Vehicles</h3>
                                <button class="btn btn-primary" onclick="openModal('addRouteModal')">
                                    <i class="fas fa-plus"></i> Add Route
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Route</th>
                                            <th>Vehicle</th>
                                            <th>Driver</th>
                                            <th>Students</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transportTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-map-marked-alt"></i> Route Map</h3>
                            </div>
                            <div id="routeMap" style="height: 400px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                <p>Route map will be displayed here</p>
                            </div>
                        </div>
                    </section>

                    <!-- Hostel Section -->
                    <section id="hostel" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-bed"></i> Hostel Management</h2>
                        
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-label">Total Capacity</div>
                                <div class="kpi-value" id="totalCapacity">240</div>
                            </div>
                            <div class="kpi-card info">
                                <div class="kpi-label">Occupied</div>
                                <div class="kpi-value" id="occupiedBeds">180</div>
                            </div>
                            <div class="kpi-card success">
                                <div class="kpi-label">Available</div>
                                <div class="kpi-value" id="availableBeds">60</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-door-open"></i> Room Allocations</h3>
                                <button class="btn btn-primary" onclick="openModal('allocateRoomModal')">
                                    <i class="fas fa-plus"></i> Allocate Room
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Hostel</th>
                                            <th>Room</th>
                                            <th>Bed</th>
                                            <th>Student</th>
                                            <th>Adm No</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hostelTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Library Section -->
                    <section id="library" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-book"></i> Library Management</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-book-open"></i> Books & Resources</h3>
                                <button class="btn btn-primary" onclick="openModal('addBookModal')">
                                    <i class="fas fa-plus"></i> Add Book
                                </button>
                            </div>

                            <div class="search-bar">
                                <input type="text" id="bookSearch" placeholder="Search by title, author, ISBN..." onkeyup="filterBooks()">
                                <select id="bookCategoryFilter" onchange="filterBooks()">
                                    <option value="">All Categories</option>
                                    <option value="Textbook">Textbook</option>
                                    <option value="Story Book">Story Book</option>
                                    <option value="Reference">Reference</option>
                                    <option value="Novel">Novel</option>
                                </select>
                            </div>

                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ISBN</th>
                                            <th>Title</th>
                                            <th>Author</th>
                                            <th>Category</th>
                                            <th>Total Copies</th>
                                            <th>Available</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="libraryTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-hand-holding-heart"></i> Borrowed Books</h3>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Book</th>
                                            <th>Borrower</th>
                                            <th>Date Borrowed</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="borrowedBooksBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Profile Section -->
                    <section id="profile" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-user-circle"></i> My Profile</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-id-card"></i> Personal Information</h3>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="profileName" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Username</label>
                                    <input type="text" id="profileUsername" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="profileEmail" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="profilePhone" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Role</label>
                                    <input type="text" id="profileRole" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Professional ID</label>
                                    <input type="text" id="profileProfId" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="profileDept" class="form-control">
                            </div>
                            
                            <button class="btn btn-primary" onclick="updateProfile()">
                                <i class="fas fa-save"></i> Update Profile
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-key"></i> Change Password</h3>
                            </div>
                            
                            <div class="form-group">
                                <label>Current Password</label>
                                <div class="password-field">
                                    <input type="password" id="currentPassword" class="form-control">
                                    <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('currentPassword', this)"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>New Password</label>
                                <div class="password-field">
                                    <input type="password" id="newPassword" class="form-control">
                                    <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('newPassword', this)"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <div class="password-field">
                                    <input type="password" id="confirmPassword" class="form-control">
                                    <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('confirmPassword', this)"></i>
                                </div>
                            </div>
                            
                            <button class="btn btn-warning" onclick="changePassword()">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </div>
                    </section>

                    <!-- Settings Section -->
                    <section id="settings" class="section-content">
                        <h2 style="margin-bottom: 20px;"><i class="fas fa-cogs"></i> System Settings</h2>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-school"></i> School Information</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>School Name</label>
                                    <input type="text" id="schoolName" class="form-control" value="Kagema Primary Junior Secondary">
                                </div>
                                <div class="form-group">
                                    <label>NEMIS Code</label>
                                    <input type="text" id="nemisCode" class="form-control" value="14720001" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="text" id="schoolPhone" class="form-control" value="0722 123456">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="schoolEmail" class="form-control" value="info@kagema.ac.ke">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="schoolAddress" class="form-control" value="P.O. Box 1234 - 00100 Nairobi">
                                </div>
                                <div class="form-group">
                                    <label>County</label>
                                    <input type="text" id="schoolCounty" class="form-control" value="Nairobi">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Current Academic Year</label>
                                    <select id="academicYear" class="form-control">
                                        <option value="2026" selected>2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Current Term</label>
                                    <select id="currentTerm" class="form-control">
                                        <option value="Term 1" selected>Term 1</option>
                                        <option value="Term 2">Term 2</option>
                                        <option value="Term 3">Term 3</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-block" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-database"></i> System Backup</h3>
                            </div>

                            <div class="form-group">
                                <p><strong>Last backup:</strong> <span id="lastBackup">10/04/2026 11:30 PM</span></p>
                                <p><strong>Database size:</strong> <span id="dbSize">245 MB</span></p>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-success" onclick="backupSystem()">
                                        <i class="fas fa-database"></i> Create Backup
                                    </button>
                                    <button class="btn btn-info" onclick="restoreBackup()">
                                        <i class="fas fa-undo"></i> Restore
                                    </button>
                                    <button class="btn btn-warning" onclick="exportAllData()">
                                        <i class="fas fa-download"></i> Export All
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-palette"></i> Theme Settings</h3>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Primary Color</label>
                                    <input type="color" id="primaryColor" class="form-control" value="#2E7D32">
                                </div>
                                <div class="form-group">
                                    <label>Accent Color</label>
                                    <input type="color" id="accentColor" class="form-control" value="#FFB300">
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="applyTheme()">
                                <i class="fas fa-paint-brush"></i> Apply Theme
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================================== -->
    <!-- MODALS SECTION - ALL MODALS ARE DEFINED HERE          -->
    <!-- ===================================================== -->

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-plus"></i> Register New User</h3>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form onsubmit="saveUser(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="userUsername" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <div class="password-field">
                            <input type="password" id="userPassword" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('userPassword', this)"></i>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="userRole" required>
                            <option value="">-- Select Role --</option>
                            <option value="admin">Administrator</option>
                            <option value="headteacher">Head Teacher</option>
                            <option value="dht">Deputy Head Teacher</option>
                            <option value="teacher">Teacher</option>
                            <option value="secretary">Secretary</option>
                            <option value="bursar">Bursar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Professional ID *</label>
                        <input type="text" id="userProfId" placeholder="TSC/Bursar/Admin ID" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="userPhone" placeholder="07XX XXX XXX">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="userDept" placeholder="e.g., Mathematics, Admin">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Register</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-graduate"></i> Register New Student</h3>
                <button class="close-btn" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form onsubmit="saveStudent(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" id="studentDob" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Admission Number *</label>
                        <input type="text" id="admissionNo" placeholder="e.g., 2026/001" required>
                    </div>
                    <div class="form-group">
                        <label>UPI Number *</label>
                        <input type="text" id="upiNumber" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Grade *</label>
                        <select id="studentGrade" required>
                            <option value="">-- Select Grade --</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stream *</label>
                        <select id="studentStream" required>
                            <option value="">-- Select Stream --</option>
                            <option value="East">East</option>
                            <option value="West">West</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birth Certificate No</label>
                        <input type="text" id="birthCert">
                    </div>
                    <div class="form-group">
                        <label>Birth Place</label>
                        <input type="text" id="birthPlace">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>County</label>
                        <input type="text" id="county" placeholder="e.g., Nairobi, Kisumu">
                    </div>
                    <div class="form-group">
                        <label>Sub-County</label>
                        <input type="text" id="subCounty">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Religion</label>
                        <select id="religion">
                            <option value="Christian (CRE)">Christian (CRE)</option>
                            <option value="Muslim (IRE)">Muslim (IRE)</option>
                            <option value="Hindu (HRE)">Hindu (HRE)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Blood Group</label>
                        <select id="bloodGroup">
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                </div>
                <h4 style="margin: 20px 0 10px;">Parent/Guardian Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Father's Name</label>
                        <input type="text" id="fatherName">
                    </div>
                    <div class="form-group">
                        <label>Father's Phone</label>
                        <input type="tel" id="fatherPhone" placeholder="07XX XXX XXX">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Mother's Name</label>
                        <input type="text" id="motherName">
                    </div>
                    <div class="form-group">
                        <label>Mother's Phone</label>
                        <input type="tel" id="motherPhone" placeholder="07XX XXX XXX">
                    </div>
                </div>
                <div class="form-group">
                    <label>Emergency Contact</label>
                    <input type="tel" id="emergencyPhone" placeholder="07XX XXX XXX">
                </div>
                <div class="form-group">
                    <label>Medical Notes / Allergies</label>
                    <textarea id="medicalNotes" rows="3" placeholder="e.g., Asthma, Penicillin allergy, Special needs..."></textarea>
                </div>
                <div class="form-group">
                    <label>Previous School</label>
                    <input type="text" id="prevSchool">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Register</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div id="addStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-tie"></i> Add Staff Member</h3>
                <button class="close-btn" onclick="closeModal('addStaffModal')">&times;</button>
            </div>
            <form onsubmit="saveStaff(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="staffName" required>
                    </div>
                    <div class="form-group">
                        <label>TSC Number *</label>
                        <input type="text" id="staffTsc" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="staffRole" required>
                            <option value="">-- Select Role --</option>
                            <option value="teacher">Teacher</option>
                            <option value="headteacher">Head Teacher</option>
                            <option value="dht">Deputy Head Teacher</option>
                            <option value="secretary">Secretary</option>
                            <option value="bursar">Bursar</option>
                            <option value="librarian">Librarian</option>
                            <option value="driver">Driver</option>
                            <option value="matron">Matron/Patron</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="staffDept" placeholder="e.g., Mathematics, Admin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="staffPhone" placeholder="07XX XXX XXX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="staffEmail">
                    </div>
                </div>
                <div class="form-group">
                    <label>Qualification</label>
                    <input type="text" id="staffQualification" placeholder="e.g., B.Ed, Diploma">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStaffModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Add Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="recordPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> Record Payment</h3>
                <button class="close-btn" onclick="closeModal('recordPaymentModal')">&times;</button>
            </div>
            <form onsubmit="recordPayment(event)">
                <div class="form-group">
                    <label>Student *</label>
                    <select id="paymentStudent" class="form-control" required>
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount (KES) *</label>
                    <input type="number" id="paymentAmount" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label>Payment Method *</label>
                    <select id="paymentMethod" class="form-control" onchange="togglePaymentFields()" required>
                        <option value="cash">Cash</option>
                        <option value="bank_deposit">Bank Deposit</option>
                        <option value="cheque">Cheque</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="mpesa">M-Pesa</option>
                    </select>
                </div>
                <div id="paymentMethodFields"></div>
                <div class="form-group">
                    <label>Payment Date *</label>
                    <input type="date" id="paymentDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Received By</label>
                    <input type="text" id="receivedBy" class="form-control" value="Current User" readonly>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('recordPaymentModal')">Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Record Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Fee Structure Modal -->
    <div id="feeStructureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-invoice"></i> Add Fee Structure</h3>
                <button class="close-btn" onclick="closeModal('feeStructureModal')">&times;</button>
            </div>
            <form onsubmit="saveFeeStructure(event)">
                <div class="form-group">
                    <label>Grade *</label>
                    <select id="feeGrade" class="form-control" required>
                        <option value="">-- Select Grade --</option>
                        <option value="Grade 1">Grade 1</option>
                        <option value="Grade 2">Grade 2</option>
                        <option value="Grade 3">Grade 3</option>
                        <option value="Grade 4">Grade 4</option>
                        <option value="Grade 5">Grade 5</option>
                        <option value="Grade 6">Grade 6</option>
                        <option value="Grade 7">Grade 7</option>
                        <option value="Grade 8">Grade 8</option>
                        <option value="Grade 9">Grade 9</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tuition (KES)</label>
                        <input type="number" id="feeTuition" class="form-control" min="0" value="25000">
                    </div>
                    <div class="form-group">
                        <label>Boarding (KES)</label>
                        <input type="number" id="feeBoarding" class="form-control" min="0" value="18000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transport (KES)</label>
                        <input type="number" id="feeTransport" class="form-control" min="0" value="5000">
                    </div>
                    <div class="form-group">
                        <label>Uniform (KES)</label>
                        <input type="number" id="feeUniform" class="form-control" min="0" value="3500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Activities (KES)</label>
                        <input type="number" id="feeActivities" class="form-control" min="0" value="2000">
                    </div>
                    <div class="form-group">
                        <label>Levies (KES)</label>
                        <input type="number" id="feeLevies" class="form-control" min="0" value="1500">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('feeStructureModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div id="addInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-box"></i> Add Inventory Item</h3>
                <button class="close-btn" onclick="closeModal('addInventoryModal')">&times;</button>
            </div>
            <form onsubmit="saveInventory(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Item Code *</label>
                        <input type="text" id="itemCode" required>
                    </div>
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" id="itemName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="itemCategory">
                            <option value="Furniture">Furniture</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Books">Books</option>
                            <option value="Sports">Sports</option>
                            <option value="Stationery">Stationery</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="itemQuantity" min="0" value="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Unit</label>
                        <input type="text" id="itemUnit" value="pcs">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="itemLocation" placeholder="e.g., Store Room, Library">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addInventoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="addRouteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-route"></i> Add Transport Route</h3>
                <button class="close-btn" onclick="closeModal('addRouteModal')">&times;</button>
            </div>
            <form onsubmit="saveRoute(event)">
                <div class="form-group">
                    <label>Route Name *</label>
                    <input type="text" id="routeName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle Registration</label>
                        <input type="text" id="vehicleReg">
                    </div>
                    <div class="form-group">
                        <label>Driver Name</label>
                        <input type="text" id="driverName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Driver Phone</label>
                        <input type="tel" id="driverPhone">
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="vehicleCapacity" value="40">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addRouteModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Add Route</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Allocate Room Modal -->
    <div id="allocateRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-door-open"></i> Allocate Hostel Room</h3>
                <button class="close-btn" onclick="closeModal('allocateRoomModal')">&times;</button>
            </div>
            <form onsubmit="allocateRoom(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Hostel *</label>
                        <select id="hostelName" required>
                            <option value="">-- Select Hostel --</option>
                            <option value="Boys Hostel A">Boys Hostel A</option>
                            <option value="Boys Hostel B">Boys Hostel B</option>
                            <option value="Girls Hostel A">Girls Hostel A</option>
                            <option value="Girls Hostel B">Girls Hostel B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Room Number *</label>
                        <input type="text" id="roomNumber" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bed Number</label>
                        <input type="text" id="bedNumber">
                    </div>
                    <div class="form-group">
                        <label>Student</label>
                        <select id="roomStudent" class="form-control">
                            <option value="">-- Select Student --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('allocateRoomModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Allocate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div id="addBookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-book"></i> Add Book</h3>
                <button class="close-btn" onclick="closeModal('addBookModal')">&times;</button>
            </div>
            <form onsubmit="saveBook(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>ISBN</label>
                        <input type="text" id="bookIsbn">
                    </div>
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" id="bookAuthor">
                    </div>
                    <div class="form-group">
                        <label>Publisher</label>
                        <input type="text" id="bookPublisher">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="bookCategory">
                            <option value="Textbook">Textbook</option>
                            <option value="Story Book">Story Book</option>
                            <option value="Reference">Reference</option>
                            <option value="Novel">Novel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Copies</label>
                        <input type="number" id="bookCopies" value="1" min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addBookModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Add Book</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-receipt"></i> Payment Receipt</h3>
                <button class="close-btn" onclick="closeModal('receiptModal')">&times;</button>
            </div>
            <div id="receiptContent" class="receipt"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="printReceipt()" style="flex: 1;">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
                <button class="btn btn-success" onclick="downloadReceipt()" style="flex: 1;">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="btn btn-info" onclick="emailReceipt()" style="flex: 1;">
                    <i class="fas fa-envelope"></i> Email
                </button>
            </div>
        </div>
    </div>

    <!-- Report Card Modal -->
    <div id="reportCardModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-alt"></i> Student Report Card</h3>
                <button class="close-btn" onclick="closeModal('reportCardModal')">&times;</button>
            </div>
            <div id="reportCardContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="printReportCard()" style="flex: 1;">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-success" onclick="downloadReportCard()" style="flex: 1;">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button class="btn btn-info" onclick="emailReportCard()" style="flex: 1;">
                    <i class="fas fa-envelope"></i> Email
                </button>
            </div>
        </div>
    </div>

    <!-- Results Slip Modal -->
    <div id="resultsSlipModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-clipboard-list"></i> Student Results Slip</h3>
                <button class="close-btn" onclick="closeModal('resultsSlipModal')">&times;</button>
            </div>
            <div id="resultsSlipContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="printResultsSlip()" style="flex: 1;">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-success" onclick="downloadResultsSlip()" style="flex: 1;">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h3>
                <button class="close-btn" onclick="closeModal('deleteConfirmModal')">&times;</button>
            </div>
            <p style="margin: 20px 0;">Are you sure you want to delete this record? This action cannot be undone.</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">Yes, Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Message Modal -->
    <div id="bulkMessageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-envelope"></i> Send Bulk Message</h3>
                <button class="close-btn" onclick="closeModal('bulkMessageModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Select Recipients</label>
                <select id="bulkRecipientType" class="form-control" onchange="updateBulkRecipients()">
                    <option value="all_students">All Students</option>
                    <option value="all_parents">All Parents</option>
                    <option value="all_staff">All Staff</option>
                    <option value="all_teachers">All Teachers</option>
                    <option value="grade">Specific Grade</option>
                    <option value="stream">Specific Stream</option>
                </select>
            </div>
            <div id="bulkRecipientOptions"></div>
            <div class="form-group">
                <label>Message Type</label>
                <select id="bulkMessageType" class="form-control">
                    <option value="sms">SMS</option>
                    <option value="email">Email</option>
                    <option value="whatsapp">WhatsApp</option>
                </select>
            </div>
            <div class="form-group">
                <label>Subject (for Email)</label>
                <input type="text" id="bulkSubject" class="form-control">
            </div>
            <div class="form-group">
                <label>Message</label>
                <textarea id="bulkMessage" class="form-control" rows="6"></textarea>
            </div>
            <div class="form-group">
                <label>Recipients: <span id="bulkRecipientCount">0</span></label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bulkMessageModal')">Cancel</button>
                <button class="btn btn-primary" onclick="sendBulkMessage()"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="importDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-upload"></i> Import Data</h3>
                <button class="close-btn" onclick="closeModal('importDataModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Data Type</label>
                <select id="importDataType" class="form-control">
                    <option value="students">Students</option>
                    <option value="staff">Staff</option>
                    <option value="fees">Fees</option>
                    <option value="assessments">Assessments</option>
                </select>
            </div>
            <div class="form-group">
                <label>Import Format</label>
                <select id="importFormat" class="form-control">
                    <option value="csv">CSV</option>
                    <option value="excel">Excel</option>
                    <option value="json">JSON</option>
                </select>
            </div>
            <div class="form-group">
                <label>Upload File</label>
                <input type="file" id="importFile" class="form-control" accept=".csv,.xlsx,.xls,.json">
            </div>
            <div class="form-group">
                <label>Import Options</label>
                <div>
                    <label><input type="checkbox" id="importSkipDuplicates"> Skip Duplicates</label>
                </div>
                <div>
                    <label><input type="checkbox" id="importUpdateExisting"> Update Existing</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importDataModal')">Cancel</button>
                <button class="btn btn-success" onclick="importData()"><i class="fas fa-upload"></i> Import</button>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-chart-line"></i> Analytics Dashboard</h3>
                <button class="close-btn" onclick="closeModal('analyticsModal')">&times;</button>
            </div>
            <div class="analytics-dashboard" id="analyticsContent">
                <!-- Analytics charts will be loaded here -->
            </div>
        </div>
    </div>

    <!-- ===================================================== -->
    <!-- JAVASCRIPT - COMPLETE APPLICATION LOGIC                -->
    <!-- ===================================================== -->
    <script>
        // =====================================================
        // GLOBAL CONFIGURATION
        // =====================================================
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // =====================================================
        // SESSION MANAGEMENT - NEW TAB LOGIN REQUIREMENT
        // =====================================================
        (function() {
            // Check if this is a new tab
            const sessionId = sessionStorage.getItem('sessionId');
            const token = localStorage.getItem('token');
            
            // If we have a token but no sessionId, this is a new tab
            if (token && !sessionId) {
                // Clear the token to force re-login
                localStorage.removeItem('token');
                if (typeof showAlert === 'function') {
                    showAlert('New tab detected. Please login again for security.', 'info');
                }
            }
            
            // Generate a new session ID for this tab
            const newSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('sessionId', newSessionId);
        })();

        // =====================================================
        // DATA LAYER - COMPLETE DATABASE STRUCTURE
        // =====================================================
        const AppData = {
            currentUser: null,
            deleteCallback: null,
            userStatus: 'online',
            selectedChatUser: null,
            chatMessages: {},
            notifications: [],
            announcements: [],
            meetings: [],
            events: [],
            
            // Users database
            users: [
                { id: 1, username: 'admin', password: 'admin123', name: 'System Administrator', role: 'admin', professionalId: 'ADMIN001', email: 'admin@kagema.ac.ke', phone: '0722000001', department: 'Administration', status: 'active', online: false, lastSeen: new Date().toISOString() },
                { id: 2, username: 'headteacher', password: 'head123', name: 'Mr. Omondi', role: 'headteacher', professionalId: 'TSC001234', email: 'omondi@kagema.ac.ke', phone: '0722000002', department: 'Administration', status: 'active', online: false, lastSeen: new Date().toISOString() },
                { id: 3, username: 'dht', password: 'dht123', name: 'Ms. Achieng', role: 'dht', professionalId: 'TSC001235', email: 'achieng@kagema.ac.ke', phone: '0722000003', department: 'Academics', status: 'active', online: false, lastSeen: new Date().toISOString() },
                { id: 4, username: 'teacher', password: 'teacher123', name: 'Mrs. Atieno', role: 'teacher', professionalId: 'TSC001236', email: 'atieno@kagema.ac.ke', phone: '0722000004', department: 'Grade 7', status: 'active', online: false, lastSeen: new Date().toISOString() },
                { id: 5, username: 'secretary', password: 'sec123', name: 'Ms. Wambui', role: 'secretary', professionalId: 'SEC001', email: 'wambui@kagema.ac.ke', phone: '0722000005', department: 'Administration', status: 'active', online: false, lastSeen: new Date().toISOString() },
                { id: 6, username: 'bursar', password: 'bursar123', name: 'Mr. Otieno', role: 'bursar', professionalId: 'BUR001', email: 'otieno@kagema.ac.ke', phone: '0722000006', department: 'Finance', status: 'active', online: false, lastSeen: new Date().toISOString() }
            ],

            // Students database
            students: [],

            // Staff database
            staff: [],

            // Fee structures
            feeStructures: [
                { grade: 'Grade 1', tuition: 20000, boarding: 15000, transport: 4000, uniform: 3000, activities: 1500, levies: 1000, total: 44500 },
                { grade: 'Grade 2', tuition: 20000, boarding: 15000, transport: 4000, uniform: 3000, activities: 1500, levies: 1000, total: 44500 },
                { grade: 'Grade 3', tuition: 20000, boarding: 15000, transport: 4000, uniform: 3000, activities: 1500, levies: 1000, total: 44500 },
                { grade: 'Grade 4', tuition: 22000, boarding: 16000, transport: 4500, uniform: 3200, activities: 1800, levies: 1200, total: 48700 },
                { grade: 'Grade 5', tuition: 22000, boarding: 16000, transport: 4500, uniform: 3200, activities: 1800, levies: 1200, total: 48700 },
                { grade: 'Grade 6', tuition: 22000, boarding: 16000, transport: 4500, uniform: 3200, activities: 1800, levies: 1200, total: 48700 },
                { grade: 'Grade 7', tuition: 25000, boarding: 18000, transport: 5000, uniform: 3500, activities: 2000, levies: 1500, total: 55000 },
                { grade: 'Grade 8', tuition: 25000, boarding: 18000, transport: 5000, uniform: 3500, activities: 2000, levies: 1500, total: 55000 },
                { grade: 'Grade 9', tuition: 25000, boarding: 18000, transport: 5000, uniform: 3500, activities: 2000, levies: 1500, total: 55000 }
            ],

            // Fee records
            fees: [],

            // Assessments
            assessments: [],

            // Messages
            messages: [],

            // Alumni
            alumni: [],

            // Inventory
            inventory: [],

            // Transport
            transport: [],

            // Hostel
            hostel: [],

            // Library
            library: [],

            // Events
            events: [
                { id: 1, title: 'Staff Meeting', date: '2026-04-15', time: '14:00', location: 'Staff Room', description: 'Monthly staff meeting' },
                { id: 2, title: 'Parents Day', date: '2026-04-20', time: '09:00', location: 'School Hall', description: 'Annual parents day celebration' },
                { id: 3, title: 'End Term Exams', date: '2026-04-25', time: '08:00', location: 'Various', description: 'End of term examinations' }
            ]
        };

        // =====================================================
        // INITIALIZATION FUNCTIONS
        // =====================================================
        function initializeSampleData() {
            if (AppData.students.length === 0) {
                AppData.students.push(
                    {
                        id: '2023/001',
                        name: 'Akinyi Otieno',
                        dob: '2012-06-12',
                        upi: '4567890123',
                        grade: 'Grade 7',
                        stream: 'East',
                        birthCert: 'BC123456',
                        birthPlace: 'Kisumu',
                        county: 'Kisumu',
                        subCounty: 'Kisumu East',
                        religion: 'Christian (CRE)',
                        bloodGroup: 'O+',
                        fatherName: 'Otieno John',
                        fatherPhone: '0722123456',
                        motherName: 'Otieno Mary',
                        motherPhone: '0723123456',
                        emergencyPhone: '0722123456',
                        medicalNotes: 'Asthma, uses inhaler',
                        prevSchool: 'Kisumu Junior Academy',
                        admissionDate: '2023-01-15',
                        status: 'active'
                    },
                    {
                        id: '2023/002',
                        name: 'Kamau James',
                        dob: '2012-03-08',
                        upi: '4567890124',
                        grade: 'Grade 7',
                        stream: 'West',
                        birthCert: 'BC123457',
                        birthPlace: 'Kiambu',
                        county: 'Kiambu',
                        subCounty: 'Kiambu Town',
                        religion: 'Christian (CRE)',
                        bloodGroup: 'A+',
                        fatherName: 'Kamau Peter',
                        fatherPhone: '0722123457',
                        motherName: 'Kamau Mary',
                        motherPhone: '0723123457',
                        emergencyPhone: '0722123457',
                        medicalNotes: '',
                        prevSchool: 'Kiambu Primary School',
                        admissionDate: '2023-01-15',
                        status: 'active'
                    },
                    {
                        id: '2023/003',
                        name: 'Mwangi Grace',
                        dob: '2011-09-20',
                        upi: '4567890125',
                        grade: 'Grade 8',
                        stream: 'East',
                        birthCert: 'BC123458',
                        birthPlace: 'Nakuru',
                        county: 'Nakuru',
                        subCounty: 'Nakuru East',
                        religion: 'Christian (CRE)',
                        bloodGroup: 'B+',
                        fatherName: 'Mwangi David',
                        fatherPhone: '0722123458',
                        motherName: 'Mwangi Jane',
                        motherPhone: '0723123458',
                        emergencyPhone: '0722123458',
                        medicalNotes: '',
                        prevSchool: 'Nakuru Primary',
                        admissionDate: '2023-01-20',
                        status: 'active'
                    }
                );

                AppData.fees.push(
                    { studentId: '2023/001', total: 55000, paid: 50000, balance: 5000 },
                    { studentId: '2023/002', total: 37000, paid: 37000, balance: 0 },
                    { studentId: '2023/003', total: 55000, paid: 25000, balance: 30000 }
                );

                AppData.assessments.push(
                    { studentId: '2023/001', subject: 'Mathematics', type: 'cat1', score: 45, term: 'Term 1, 2026' },
                    { studentId: '2023/001', subject: 'English', type: 'cat1', score: 72, term: 'Term 1, 2026' },
                    { studentId: '2023/001', subject: 'Science', type: 'cat1', score: 81, term: 'Term 1, 2026' },
                    { studentId: '2023/002', subject: 'Mathematics', type: 'cat1', score: 85, term: 'Term 1, 2026' },
                    { studentId: '2023/002', subject: 'English', type: 'cat1', score: 78, term: 'Term 1, 2026' },
                    { studentId: '2023/003', subject: 'Mathematics', type: 'cat1', score: 35, term: 'Term 1, 2026' }
                );

                AppData.staff.push(
                    { id: 1, tsc: 'TSC001236', name: 'Mrs. Atieno', role: 'teacher', department: 'Grade 7', phone: '0722123456', email: 'atieno@kagema.ac.ke', qualification: 'B.Ed English', status: 'active' },
                    { id: 2, tsc: 'TSC001237', name: 'Mr. Kipchoge', role: 'teacher', department: 'Mathematics', phone: '0722123457', email: 'kipchoge@kagema.ac.ke', qualification: 'B.Ed Math', status: 'active' },
                    { id: 3, tsc: 'TSC001238', name: 'Ms. Akinyi', role: 'teacher', department: 'Science', phone: '0722123458', email: 'akinyi@kagema.ac.ke', qualification: 'B.Sc Education', status: 'active' }
                );

                AppData.announcements.push({
                    id: 1,
                    title: 'Staff Meeting',
                    content: 'There will be a staff meeting tomorrow at 2:00 PM in the staffroom.',
                    author: 'Mr. Omondi',
                    authorRole: 'headteacher',
                    date: new Date().toLocaleDateString(),
                    priority: 'high',
                    audience: 'all',
                    likes: 5,
                    comments: 2,
                    views: 15
                });
            }
        }

        // =====================================================
        // API UTILITY FUNCTIONS
        // =====================================================
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const baseUrl = document.getElementById('apiBaseUrl')?.value || API_BASE_URL;
            
            try {
                const response = await fetch(`${baseUrl}${url}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : '',
                        'X-Session-ID': sessionStorage.getItem('sessionId') || '',
                        ...options.headers
                    }
                });
                return response;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // =====================================================
        // PASSWORD TOGGLE FUNCTION
        // =====================================================
        function togglePasswordVisibility(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            }
        }

        // =====================================================
        // AUTHENTICATION FUNCTIONS
        // =====================================================
        async function handleLogin(event) {
            if (event) event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showAlert('Please enter both username and password', 'warning');
                return;
            }

            try {
                // Try backend login first
                const baseUrl = document.getElementById('apiBaseUrl')?.value || API_BASE_URL;
                const response = await fetch(`${baseUrl}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                }).catch(() => null);

                if (response && response.ok) {
                    const data = await response.json();
                    
                    // Store the token
                    localStorage.setItem('token', data.token);
                    
                    // Set current user
                    AppData.currentUser = data.user;
                    
                    // Hide login page, show dashboard
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainDashboard').classList.add('active');
                    
                    // Update UI
                    updateUserDisplay();
                    generateMenu();
                    
                    showAlert(`Welcome back, ${data.user.name}! You are logged in as ${getRoleDisplay(data.user.role)}.`, 'success');
                    
                    // Load all data from backend
                    await Promise.all([
                        loadStudentsFromBackend(),
                        loadUsersFromBackend(),
                        loadFeesFromBackend(),
                        loadStaffFromBackend(),
                        loadAssessmentsFromBackend(),
                        loadInventoryFromBackend(),
                        loadTransportFromBackend(),
                        loadHostelFromBackend(),
                        loadLibraryFromBackend(),
                        loadAlumniFromBackend()
                    ]);
                } else {
                    // If backend fails, try fallback authentication
                    const user = AppData.users.find(u => u.username === username && u.password === password);
                    if (user) {
                        // Create a mock token
                        const mockToken = btoa(JSON.stringify({ 
                            username: user.username, 
                            role: user.role,
                            sessionId: sessionStorage.getItem('sessionId')
                        }));
                        localStorage.setItem('token', mockToken);
                        
                        // Set current user (don't store password)
                        const { password: pwd, ...userWithoutPassword } = user;
                        AppData.currentUser = userWithoutPassword;
                        
                        // Hide login page, show dashboard
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainDashboard').classList.add('active');
                        
                        // Update UI
                        updateUserDisplay();
                        generateMenu();
                        
                        showAlert(`Welcome back, ${user.name}! You are logged in as ${getRoleDisplay(user.role)}. (Offline Mode)`, 'info');
                        
                        // Load local data
                        loadAllLocalData();
                    } else {
                        showAlert('Invalid username or password', 'danger');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Try fallback authentication when backend is not available
                const user = AppData.users.find(u => u.username === username && u.password === password);
                if (user) {
                    // Create a mock token
                    const mockToken = btoa(JSON.stringify({ 
                        username: user.username, 
                        role: user.role,
                        sessionId: sessionStorage.getItem('sessionId')
                    }));
                    localStorage.setItem('token', mockToken);
                    
                    // Set current user (don't store password)
                    const { password: pwd, ...userWithoutPassword } = user;
                    AppData.currentUser = userWithoutPassword;
                    
                    // Hide login page, show dashboard
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainDashboard').classList.add('active');
                    
                    // Update UI
                    updateUserDisplay();
                    generateMenu();
                    
                    showAlert(`Welcome back, ${user.name}! You are logged in as ${getRoleDisplay(user.role)}. (Offline Mode)`, 'info');
                    
                    // Load local data
                    loadAllLocalData();
                } else {
                    showAlert('Invalid username or password', 'danger');
                }
            }
        }

        function logout() {
            // Clear storage
            localStorage.removeItem('token');
            sessionStorage.removeItem('sessionId');
            AppData.currentUser = null;
            
            // Show login page
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainDashboard').classList.remove('active');
            
            showAlert('You have been logged out successfully', 'info');
        }

        function updateUserDisplay() {
            const user = AppData.currentUser;
            if (!user) return;
            
            // Update sidebar
            document.getElementById('sidebarUserName').textContent = user.name;
            document.getElementById('sidebarUserRole').textContent = getRoleDisplay(user.role);
            document.getElementById('sidebarUserId').textContent = user.professionalId || user.professional_id || '';
            
            // Update header
            document.getElementById('headerUserName').textContent = user.name;
            document.getElementById('headerUserRole').textContent = getRoleDisplay(user.role);
            document.getElementById('headerUserId').textContent = user.professionalId || user.professional_id || '';
            
            // Update avatars
            const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('sidebarUserAvatar').textContent = initials;
            document.getElementById('headerUserAvatar').textContent = initials;
        }

        function updateUserStatus(status) {
            AppData.userStatus = status;
            const statusDot = document.getElementById('userStatus');
            statusDot.className = `user-status status-${status}`;
            showAlert(`Your status has been updated to ${status}`, 'success');
        }

        function getRoleDisplay(role) {
            const roles = {
                'admin': 'Administrator',
                'headteacher': 'Head Teacher',
                'dht': 'Deputy Head Teacher',
                'teacher': 'Teacher',
                'secretary': 'Secretary',
                'bursar': 'Bursar',
                'librarian': 'Librarian',
                'driver': 'Driver',
                'matron': 'Matron'
            };
            return roles[role] || role;
        }

        function generateMenu() {
            const role = AppData.currentUser?.role;
            if (!role) return;
            
            const menu = document.getElementById('dynamicMenu');
            let html = '';

            // Common features for all roles
            html = `
                <div class="nav-section">Dashboard</div>
                <div class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
            `;

            if (role === 'admin') {
                html += `
                    <div class="nav-section">Administration</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('userManagement')"><i class="fas fa-users-cog"></i> User Management</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('staffManagement')"><i class="fas fa-chalkboard-teacher"></i> Staff</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('alumni')"><i class="fas fa-graduation-cap"></i> Alumni</a></div>
                    
                    <div class="nav-section">Academics</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('gradeEntry')"><i class="fas fa-pen"></i> Enter Marks</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                    
                    <div class="nav-section">Finance</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('finance')"><i class="fas fa-coins"></i> Finance</a></div>
                    
                    <div class="nav-section">Support Services</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('inventory')"><i class="fas fa-box"></i> Inventory</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('transport')"><i class="fas fa-bus"></i> Transport</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('hostel')"><i class="fas fa-bed"></i> Hostel</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('library')"><i class="fas fa-book"></i> Library</a></div>
                `;
            } else if (role === 'headteacher' || role === 'dht') {
                html += `
                    <div class="nav-section">Management</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('staffDirectory')"><i class="fas fa-address-book"></i> Staff Directory</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('staffManagement')"><i class="fas fa-chalkboard-teacher"></i> Staff</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('alumni')"><i class="fas fa-graduation-cap"></i> Alumni</a></div>
                    
                    <div class="nav-section">Academics</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('gradeEntry')"><i class="fas fa-pen"></i> Enter Marks</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                    
                    <div class="nav-section">Finance</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('finance')"><i class="fas fa-coins"></i> Finance</a></div>
                `;
            } else if (role === 'teacher') {
                html += `
                    <div class="nav-section">Teaching</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> My Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('gradeEntry')"><i class="fas fa-pen"></i> Enter Marks</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments"></i> Parent Communication</a></div>
                `;
            } else if (role === 'secretary') {
                html += `
                    <div class="nav-section">Administration</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('alumni')"><i class="fas fa-graduation-cap"></i> Alumni</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('communication')"><i class="fas fa-envelope"></i> Parent Communication</a></div>
                `;
            } else if (role === 'bursar') {
                html += `
                    <div class="nav-section">Finance</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('finance')"><i class="fas fa-coins"></i> Finance</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                `;
            }

            // Add internal communication for all roles
            html += `
                <div class="nav-section">Communication</div>
                <div class="nav-item"><a class="nav-link" onclick="showSection('internalChat')"><i class="fas fa-comment-dots"></i> Staff Chat <span class="notification-badge" id="chatNotification" style="display: none;">0</span></a></div>
                <div class="nav-item"><a class="nav-link" onclick="showSection('videoMeeting')"><i class="fas fa-video"></i> Video Meeting</a></div>
                <div class="nav-item"><a class="nav-link" onclick="showSection('announcements')"><i class="fas fa-bullhorn"></i> Announcements</a></div>
                <div class="nav-item"><a class="nav-link" onclick="showSection('staffDirectory')"><i class="fas fa-address-book"></i> Staff Directory</a></div>
            `;

            if (role === 'admin') {
                html += `
                    <div class="nav-section">Settings</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('profile')"><i class="fas fa-user-circle"></i> My Profile</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog"></i> System Settings</a></div>
                `;
            } else {
                html += `
                    <div class="nav-section">Account</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('profile')"><i class="fas fa-user-circle"></i> My Profile</a></div>
                `;
            }

            menu.innerHTML = html;
        }

        // =====================================================
        // SECTION NAVIGATION
        // =====================================================
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            const titles = {
                'dashboard': 'Dashboard',
                'userManagement': 'User Management',
                'students': 'Student Management',
                'gradeEntry': 'Enter Marks',
                'finance': 'Finance Management',
                'reports': 'Reports Generation',
                'communication': 'Parent Communication',
                'internalChat': 'Staff Chat',
                'videoMeeting': 'Video Meeting',
                'announcements': 'Announcements',
                'staffDirectory': 'Staff Directory',
                'staffManagement': 'Staff Management',
                'alumni': 'Alumni Records',
                'inventory': 'Inventory Management',
                'transport': 'Transport Management',
                'hostel': 'Hostel Management',
                'library': 'Library Management',
                'profile': 'My Profile',
                'settings': 'System Settings'
            };
            
            document.getElementById('pageTitle').textContent = titles[sectionId] || sectionId;
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');

            // Load section data
            switch(sectionId) {
                case 'userManagement': loadUsers(); break;
                case 'students': loadStudents(); break;
                case 'staffManagement': loadStaff(); break;
                case 'finance': loadFinance(); break;
                case 'communication': loadCommunication(); break;
                case 'alumni': loadAlumni(); break;
                case 'inventory': loadInventory(); break;
                case 'transport': loadTransport(); break;
                case 'hostel': loadHostel(); break;
                case 'library': loadLibrary(); break;
                case 'reports': loadReportsDropdown(); break;
                case 'internalChat': loadChatUsers(); break;
                case 'staffDirectory': loadStaffDirectory(); break;
                case 'announcements': loadAnnouncements(); break;
                case 'videoMeeting': loadVideoMeeting(); break;
                case 'profile': loadProfile(); break;
                case 'settings': loadSettings(); break;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        // =====================================================
        // DASHBOARD FUNCTIONS
        // =====================================================
        function loadDashboardData() {
            document.getElementById('totalStudents').textContent = AppData.students.length;
            document.getElementById('totalStaff').textContent = AppData.staff.length;
            
            const totalFee = AppData.fees.reduce((sum, f) => sum + (f.total || 0), 0);
            const totalPaid = AppData.fees.reduce((sum, f) => sum + (f.paid || 0), 0);
            const collectionRate = totalFee > 0 ? Math.round((totalPaid / totalFee) * 100) : 0;
            
            document.getElementById('feeCollection').textContent = collectionRate + '%';
            document.getElementById('feeProgress').style.width = collectionRate + '%';
            
            const belowExpectations = AppData.assessments.filter(a => a.score < 50).length;
            document.getElementById('belowExpectations').textContent = belowExpectations;
            document.getElementById('studentTrend').textContent = AppData.students.length > 0 ? ` ${Math.round(AppData.students.length / 10)}% from last term` : 'No data';

            // Recent Students
            const recent = AppData.students.slice(-5).reverse();
            document.getElementById('recentStudents').innerHTML = recent.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.stream}</td>
                    <td><button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s.id}')"><i class="fas fa-eye"></i></button></td>
                </tr>
            `).join('');

            // Fee Status
            const feeStatus = AppData.fees.slice(0, 3);
            document.getElementById('feeStatus').innerHTML = feeStatus.map(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                if (!student) return '';
                const balance = f.balance || (f.total - f.paid) || 0;
                const statusClass = balance === 0 ? 'badge-success' : balance < 10000 ? 'badge-warning' : 'badge-danger';
                const statusText = balance === 0 ? 'Paid' : balance < 10000 ? 'Partial' : 'Overdue';
                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>KES ${balance.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td><button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${student.id}')"><i class="fas fa-money-bill"></i></button></td>
                    </tr>
                `;
            }).join('');

            // Performance Alerts
            const alerts = AppData.assessments.filter(a => a.score < 50).slice(0, 3);
            document.getElementById('performanceAlerts').innerHTML = alerts.map(a => {
                const student = AppData.students.find(s => s.id === a.studentId);
                if (!student) return '';
                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>${a.subject}</td>
                        <td>${a.score}%</td>
                        <td><button class="btn btn-sm btn-warning" onclick="notifyParent('${student.id}')"><i class="fas fa-bell"></i></button></td>
                    </tr>
                `;
            }).join('');

            // Upcoming Events
            const upcomingEvents = AppData.events.slice(0, 3);
            document.getElementById('upcomingEvents').innerHTML = upcomingEvents.map(e => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border-light);">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>${e.title}</strong>
                        <span class="badge badge-info">${e.date}</span>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${e.time} - ${e.location}</div>
                </div>
            `).join('');

            // Recent Announcements
            const recentAnnouncements = AppData.announcements.slice(-3).reverse();
            document.getElementById('recentAnnouncements').innerHTML = recentAnnouncements.map(a => `
                <div class="announcement">
                    <div class="announcement-header">
                        <span class="announcement-author">${a.author}</span>
                        <span class="announcement-date">${a.date}</span>
                    </div>
                    <div class="announcement-title">${a.title}</div>
                    <div class="announcement-content">${a.content.substring(0, 100)}...</div>
                </div>
            `).join('');
        }

        function loadAllLocalData() {
            loadUsers();
            loadStudents();
            loadStaff();
            loadFinance();
            loadCommunication();
            loadAlumni();
            loadInventory();
            loadTransport();
            loadHostel();
            loadLibrary();
            loadReportsDropdown();
            loadDashboardData();
        }

        async function loadAllFromBackend() {
            await Promise.all([
                loadStudentsFromBackend(),
                loadUsersFromBackend(),
                loadFeesFromBackend(),
                loadStaffFromBackend(),
                loadAssessmentsFromBackend(),
                loadInventoryFromBackend(),
                loadTransportFromBackend(),
                loadHostelFromBackend(),
                loadLibraryFromBackend(),
                loadAlumniFromBackend()
            ]);
        }

        // =====================================================
        // BACKEND DATA LOADING FUNCTIONS
        // =====================================================
        async function loadStudentsFromBackend() {
            try {
                const response = await fetchWithAuth('/students');
                if (response.ok) {
                    const students = await response.json();
                    AppData.students = students;
                    loadStudents();
                    loadDashboardData();
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        async function loadUsersFromBackend() {
            try {
                const response = await fetchWithAuth('/users');
                if (response.ok) {
                    const users = await response.json();
                    AppData.users = users;
                    loadUsers();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadFeesFromBackend() {
            try {
                const response = await fetchWithAuth('/fees');
                if (response.ok) {
                    const fees = await response.json();
                    AppData.fees = fees;
                    loadFinance();
                }
            } catch (error) {
                console.error('Error loading fees:', error);
            }
        }

        async function loadStaffFromBackend() {
            try {
                const response = await fetchWithAuth('/staff');
                if (response.ok) {
                    const staff = await response.json();
                    AppData.staff = staff;
                    loadStaff();
                }
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        async function loadAssessmentsFromBackend() {
            try {
                const response = await fetchWithAuth('/assessments');
                if (response.ok) {
                    const assessments = await response.json();
                    AppData.assessments = assessments;
                }
            } catch (error) {
                console.error('Error loading assessments:', error);
            }
        }

        async function loadInventoryFromBackend() {
            try {
                const response = await fetchWithAuth('/inventory');
                if (response.ok) {
                    const inventory = await response.json();
                    AppData.inventory = inventory;
                    loadInventory();
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        async function loadTransportFromBackend() {
            try {
                const response = await fetchWithAuth('/transport');
                if (response.ok) {
                    const transport = await response.json();
                    AppData.transport = transport;
                    loadTransport();
                }
            } catch (error) {
                console.error('Error loading transport:', error);
            }
        }

        async function loadHostelFromBackend() {
            try {
                const response = await fetchWithAuth('/hostel');
                if (response.ok) {
                    const hostel = await response.json();
                    AppData.hostel = hostel;
                    loadHostel();
                }
            } catch (error) {
                console.error('Error loading hostel:', error);
            }
        }

        async function loadLibraryFromBackend() {
            try {
                const response = await fetchWithAuth('/library');
                if (response.ok) {
                    const library = await response.json();
                    AppData.library = library;
                    loadLibrary();
                }
            } catch (error) {
                console.error('Error loading library:', error);
            }
        }

        async function loadAlumniFromBackend() {
            try {
                const response = await fetchWithAuth('/alumni');
                if (response.ok) {
                    const alumni = await response.json();
                    AppData.alumni = alumni;
                    loadAlumni();
                }
            } catch (error) {
                console.error('Error loading alumni:', error);
            }
        }

        // =====================================================
        // USER MANAGEMENT FUNCTIONS
        // =====================================================
        function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = AppData.users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.name}</td>
                    <td><span class="role-badge role-${u.role}">${getRoleDisplay(u.role)}</span></td>
                    <td>${u.professionalId || u.professional_id || ''}</td>
                    <td>${u.email || ''}</td>
                    <td><span class="badge badge-success">${u.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editUser('${u.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            
            const filtered = AppData.users.filter(u => 
                (u.name.toLowerCase().includes(search) || u.username.toLowerCase().includes(search)) &&
                (!role || u.role === role)
            );

            document.getElementById('usersTableBody').innerHTML = filtered.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.name}</td>
                    <td><span class="role-badge role-${u.role}">${getRoleDisplay(u.role)}</span></td>
                    <td>${u.professionalId || u.professional_id || ''}</td>
                    <td>${u.email || ''}</td>
                    <td><span class="badge badge-success">${u.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editUser('${u.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveUser(event) {
            event.preventDefault();
            
            const newUser = {
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value,
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                professional_id: document.getElementById('userProfId').value,
                phone: document.getElementById('userPhone').value,
                department: document.getElementById('userDept').value
            };

            try {
                const response = await fetchWithAuth('/users', {
                    method: 'POST',
                    body: JSON.stringify(newUser)
                });

                if (response.ok) {
                    closeModal('addUserModal');
                    await loadUsersFromBackend();
                    showAlert(`User ${newUser.name} registered successfully!`, 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error creating user', 'danger');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function editUser(username) {
            const user = AppData.users.find(u => u.username === username);
            if (!user) return;

            document.getElementById('userName').value = user.name;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userRole').value = user.role;
            document.getElementById('userProfId').value = user.professionalId || user.professional_id || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userDept').value = user.department || '';

            const form = document.querySelector('#addUserModal form');
            form.onsubmit = (e) => updateUser(e, username);
            
            openModal('addUserModal');
        }

        async function updateUser(event, username) {
            event.preventDefault();
            
            const userData = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                professional_id: document.getElementById('userProfId').value,
                phone: document.getElementById('userPhone').value,
                department: document.getElementById('userDept').value
            };

            const newPassword = document.getElementById('userPassword').value;
            if (newPassword) {
                userData.password = newPassword;
            }

            try {
                const response = await fetchWithAuth(`/users/${username}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    closeModal('addUserModal');
                    await loadUsersFromBackend();
                    showAlert('User updated successfully!', 'success');
                    
                    document.querySelector('#addUserModal form').reset();
                    document.querySelector('#addUserModal form').onsubmit = saveUser;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating user', 'danger');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteUser(username) {
            if (username === AppData.currentUser?.username) {
                showAlert('You cannot delete your own account', 'warning');
                return;
            }
            
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/users/${username}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadUsersFromBackend();
                        showAlert('User deleted successfully', 'success');
                    } else {
                        showAlert('Error deleting user', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // STUDENT MANAGEMENT FUNCTIONS
        // =====================================================
        function loadStudents() {
            const sorted = [...AppData.students].sort((a, b) => {
                if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                return a.stream.localeCompare(b.stream);
            });

            document.getElementById('studentsTableBody').innerHTML = sorted.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.stream}</td>
                    <td>${s.upi}</td>
                    <td>${s.fatherPhone || s.motherPhone || s.emergencyPhone || 'N/A'}</td>
                    <td><span class="badge badge-success">${s.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-success" onclick="viewResultsSlip('${s.id}')"><i class="fas fa-file-alt"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${s.id}')"><i class="fas fa-money-bill"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            updateStudentDropdowns();
        }

        function filterStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const grade = document.getElementById('gradeFilter').value;
            const stream = document.getElementById('streamFilter').value;
            const status = document.getElementById('statusFilter')?.value || '';
            
            const filtered = AppData.students.filter(s => 
                (s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search) || s.upi.toLowerCase().includes(search)) &&
                (!grade || s.grade === grade) &&
                (!stream || s.stream === stream) &&
                (!status || s.status === status)
            );

            document.getElementById('studentsTableBody').innerHTML = filtered.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.stream}</td>
                    <td>${s.upi}</td>
                    <td>${s.fatherPhone || s.motherPhone || s.emergencyPhone || 'N/A'}</td>
                    <td><span class="badge badge-success">${s.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-success" onclick="viewResultsSlip('${s.id}')"><i class="fas fa-file-alt"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${s.id}')"><i class="fas fa-money-bill"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStudentDropdowns() {
            const reportStudent = document.getElementById('reportStudent');
            const statementStudent = document.getElementById('statementStudent');
            const messageStudents = document.getElementById('messageStudents');
            const roomStudent = document.getElementById('roomStudent');
            const paymentStudent = document.getElementById('paymentStudent');
            
            const options = AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            
            if (reportStudent) reportStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
            if (statementStudent) statementStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
            if (roomStudent) roomStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
            if (paymentStudent) paymentStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
            
            if (messageStudents) {
                messageStudents.innerHTML = AppData.students.map(s => 
                    `<option value="${s.id}">${s.name} - ${s.grade} ${s.stream} (F:${s.fatherPhone || 'N/A'}, M:${s.motherPhone || 'N/A'})</option>`
                ).join('');
            }
        }

        async function saveStudent(event) {
            event.preventDefault();
            
            const newStudent = {
                id: document.getElementById('admissionNo').value,
                name: document.getElementById('studentName').value,
                dob: document.getElementById('studentDob').value,
                upi: document.getElementById('upiNumber').value,
                grade: document.getElementById('studentGrade').value,
                stream: document.getElementById('studentStream').value,
                birth_cert: document.getElementById('birthCert').value,
                birth_place: document.getElementById('birthPlace').value,
                county: document.getElementById('county').value,
                sub_county: document.getElementById('subCounty').value,
                religion: document.getElementById('religion').value,
                blood_group: document.getElementById('bloodGroup').value,
                father_name: document.getElementById('fatherName').value,
                father_phone: document.getElementById('fatherPhone').value,
                mother_name: document.getElementById('motherName').value,
                mother_phone: document.getElementById('motherPhone').value,
                emergency_phone: document.getElementById('emergencyPhone').value,
                medical_notes: document.getElementById('medicalNotes').value,
                prev_school: document.getElementById('prevSchool').value,
                status: 'active',
                admission_date: new Date().toISOString().split('T')[0]
            };

            try {
                const response = await fetchWithAuth('/students', {
                    method: 'POST',
                    body: JSON.stringify(newStudent)
                });

                if (response.ok) {
                    closeModal('addStudentModal');
                    await loadStudentsFromBackend();
                    await loadFeesFromBackend();
                    showAlert(`Student ${newStudent.name} registered successfully!`, 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error creating student', 'danger');
                }
            } catch (error) {
                console.error('Error saving student:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function editStudent(studentId) {
            const student = AppData.students.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('studentName').value = student.name;
            document.getElementById('studentDob').value = student.dob;
            document.getElementById('admissionNo').value = student.id;
            document.getElementById('upiNumber').value = student.upi;
            document.getElementById('studentGrade').value = student.grade;
            document.getElementById('studentStream').value = student.stream;
            document.getElementById('birthCert').value = student.birthCert || student.birth_cert || '';
            document.getElementById('birthPlace').value = student.birthPlace || student.birth_place || '';
            document.getElementById('county').value = student.county || '';
            document.getElementById('subCounty').value = student.subCounty || student.sub_county || '';
            document.getElementById('religion').value = student.religion || 'Christian (CRE)';
            document.getElementById('bloodGroup').value = student.bloodGroup || student.blood_group || 'O+';
            document.getElementById('fatherName').value = student.fatherName || student.father_name || '';
            document.getElementById('fatherPhone').value = student.fatherPhone || student.father_phone || '';
            document.getElementById('motherName').value = student.motherName || student.mother_name || '';
            document.getElementById('motherPhone').value = student.motherPhone || student.mother_phone || '';
            document.getElementById('emergencyPhone').value = student.emergencyPhone || student.emergency_phone || '';
            document.getElementById('medicalNotes').value = student.medicalNotes || student.medical_notes || '';
            document.getElementById('prevSchool').value = student.prevSchool || student.prev_school || '';

            const form = document.querySelector('#addStudentModal form');
            form.onsubmit = (e) => updateStudent(e, studentId);
            
            openModal('addStudentModal');
        }

        async function updateStudent(event, studentId) {
            event.preventDefault();
            
            const updatedStudent = {
                name: document.getElementById('studentName').value,
                dob: document.getElementById('studentDob').value,
                grade: document.getElementById('studentGrade').value,
                stream: document.getElementById('studentStream').value,
                father_name: document.getElementById('fatherName').value,
                father_phone: document.getElementById('fatherPhone').value,
                mother_name: document.getElementById('motherName').value,
                mother_phone: document.getElementById('motherPhone').value,
                emergency_phone: document.getElementById('emergencyPhone').value,
                medical_notes: document.getElementById('medicalNotes').value
            };

            try {
                const response = await fetchWithAuth(`/students/${studentId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedStudent)
                });

                if (response.ok) {
                    closeModal('addStudentModal');
                    await loadStudentsFromBackend();
                    showAlert('Student updated successfully!', 'success');
                    
                    document.querySelector('#addStudentModal form').reset();
                    document.querySelector('#addStudentModal form').onsubmit = saveStudent;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating student', 'danger');
                }
            } catch (error) {
                console.error('Error updating student:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteStudent(studentId) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/students/${studentId}`, {
                        method: 'DELETE',
                        body: JSON.stringify({ reason: 'Transferred/Deleted' })
                    });

                    if (response.ok) {
                        await loadStudentsFromBackend();
                        await loadAlumniFromBackend();
                        await loadFeesFromBackend();
                        showAlert('Student moved to alumni records', 'success');
                    } else {
                        showAlert('Error deleting student', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        function viewStudentProfile(studentId) {
            const student = AppData.students.find(s => s.id === studentId);
            if (!student) return;

            const fee = AppData.fees.find(f => f.studentId === studentId);
            const assessments = AppData.assessments.filter(a => a.studentId === studentId);

            const content = document.getElementById('reportCardContent');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>${student.name}</h3>
                    <p>Admission: ${student.id} | Grade: ${student.grade} ${student.stream}</p>
                </div>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchProfileTab(event, 'personal')">Personal</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'parents')">Parents</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'medical')">Medical</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'academic')">Academic</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'fees')">Fees</button>
                </div>

                <div id="personal" class="tab-pane active">
                    <p><strong>Name:</strong> ${student.name}</p>
                    <p><strong>Admission:</strong> ${student.id}</p>
                    <p><strong>UPI:</strong> ${student.upi}</p>
                    <p><strong>Grade:</strong> ${student.grade} ${student.stream}</p>
                    <p><strong>DOB:</strong> ${student.dob}</p>
                    <p><strong>Birth Cert:</strong> ${student.birthCert || student.birth_cert || 'N/A'}</p>
                    <p><strong>Birth Place:</strong> ${student.birthPlace || student.birth_place || 'N/A'}</p>
                    <p><strong>County:</strong> ${student.county || 'N/A'}</p>
                    <p><strong>Religion:</strong> ${student.religion || 'N/A'}</p>
                </div>

                <div id="parents" class="tab-pane">
                    <p><strong>Father:</strong> ${student.fatherName || student.father_name || 'N/A'} (${student.fatherPhone || student.father_phone || 'N/A'})</p>
                    <p><strong>Mother:</strong> ${student.motherName || student.mother_name || 'N/A'} (${student.motherPhone || student.mother_phone || 'N/A'})</p>
                    <p><strong>Emergency:</strong> ${student.emergencyPhone || student.emergency_phone || 'N/A'}</p>
                </div>

                <div id="medical" class="tab-pane">
                    <p><strong>Blood Group:</strong> ${student.bloodGroup || student.blood_group || 'N/A'}</p>
                    <p><strong>Medical Notes:</strong> ${student.medicalNotes || student.medical_notes || 'None'}</p>
                </div>

                <div id="academic" class="tab-pane">
                    <p><strong>Admission Date:</strong> ${student.admissionDate || student.admission_date || 'N/A'}</p>
                    <p><strong>Previous School:</strong> ${student.prevSchool || student.prev_school || 'N/A'}</p>
                </div>

                <div id="fees" class="tab-pane">
                    ${fee ? `
                        <p><strong>Total Fee:</strong> KES ${(fee.total || 0).toLocaleString()}</p>
                        <p><strong>Paid:</strong> KES ${(fee.paid || 0).toLocaleString()}</p>
                        <p><strong>Balance:</strong> KES ${(fee.balance || (fee.total - fee.paid) || 0).toLocaleString()}</p>
                    ` : '<p>No fee records</p>'}
                </div>
            `;

            openModal('reportCardModal');
        }

        function viewResultsSlip(studentId) {
            const student = AppData.students.find(s => s.id === studentId);
            if (!student) return;

            const subjects = ['Mathematics', 'English', 'Kiswahili', 'Science', 'Social Studies', 'CRE'];
            const results = subjects.map(subject => {
                const cat1 = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'cat1')?.score || '-';
                const cat2 = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'cat2')?.score || '-';
                const endterm = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'endterm')?.score || '-';
                
                let avg = '-', grade = '-', descriptor = '-', gradeClass = '';
                if (cat1 !== '-' && cat2 !== '-' && endterm !== '-') {
                    avg = Math.round((parseFloat(cat1) + parseFloat(cat2) + parseFloat(endterm)) / 3);
                    if (avg >= 80) { grade = '4'; descriptor = 'Exceeds'; gradeClass = 'grade-excellent'; }
                    else if (avg >= 65) { grade = '3'; descriptor = 'Meets'; gradeClass = 'grade-good'; }
                    else if (avg >= 50) { grade = '2'; descriptor = 'Approaching'; gradeClass = 'grade-fair'; }
                    else { grade = '1'; descriptor = 'Below'; gradeClass = 'grade-poor'; }
                }
                
                return `<tr>
                    <td>${subject}</td>
                    <td>${cat1}%</td>
                    <td>${cat2}%</td>
                    <td>${endterm}%</td>
                    <td>${avg}%</td>
                    <td><span class="${gradeClass}">${grade}</span></td>
                    <td>${descriptor}</td>
                </tr>`;
            }).join('');

            const content = document.getElementById('resultsSlipContent');
            content.innerHTML = `
                <div class="results-slip">
                    <div class="results-slip-header">
                        <h3>KAGEMA PRIMARY SCHOOL - RESULTS SLIP</h3>
                        <p>Term 1, 2026</p>
                    </div>
                    
                    <div class="student-info">
                        <p><strong>Name:</strong> ${student.name}</p>
                        <p><strong>Admission:</strong> ${student.id}</p>
                        <p><strong>Class:</strong> ${student.grade} ${student.stream}</p>
                        <p><strong>UPI:</strong> ${student.upi}</p>
                    </div>

                    <table style="width: 100%; margin: 20px 0;">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>CAT 1</th>
                                <th>CAT 2</th>
                                <th>End Term</th>
                                <th>Average</th>
                                <th>Grade</th>
                                <th>Descriptor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results}
                        </tbody>
                    </table>

                    <div style="margin-top: 20px; text-align: right;">
                        <p><strong>Class Teacher:</strong> _________________</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            `;

            openModal('resultsSlipModal');
        }

        function switchProfileTab(event, tabId) {
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // =====================================================
        // GRADE ENTRY FUNCTIONS
        // =====================================================
        function loadClassStreams() {
            const grade = document.getElementById('gradeSelect').value;
            const streamSelect = document.getElementById('streamSelect');
            
            if (grade) {
                const streams = ['East', 'West', 'North', 'South'];
                streamSelect.innerHTML = '<option value="">Select Stream</option>' + 
                    streams.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        function loadSubjectStudents() {
            const grade = document.getElementById('gradeSelect').value;
            const stream = document.getElementById('streamSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const type = document.getElementById('assessmentType').value;
            const term = document.getElementById('termSelect').value;

            if (!grade || !stream || !subject) {
                showAlert('Please select grade, stream, and subject', 'warning');
                return;
            }

            const students = AppData.students.filter(s => s.grade === grade && s.stream === stream);
            
            if (students.length === 0) {
                showAlert('No students found in this class', 'warning');
                return;
            }

            document.getElementById('gradeEntryTitle').textContent = `${subject} - ${grade} ${stream} (${type.toUpperCase()})`;
            document.getElementById('gradeEntryCard').style.display = 'block';

            const tbody = document.getElementById('gradeEntryBody');
            tbody.innerHTML = students.map(student => {
                const existing = AppData.assessments.find(a => 
                    a.studentId === student.id && 
                    a.subject === subject && 
                    a.type === type && 
                    a.term === term
                );
                const score = existing?.score || '';
                const gradeInfo = calculateGrade(score);
                
                return `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td><input type="number" min="0" max="100" class="score-input" data-student="${student.id}" value="${score}" onchange="updateGradeDisplay(this)"></td>
                        <td class="grade-cell">${gradeInfo.grade}</td>
                        <td class="descriptor-cell">${gradeInfo.descriptor}</td>
                        <td><button class="btn btn-success btn-sm" onclick="saveGrade('${student.id}')"><i class="fas fa-save"></i> Save</button></td>
                    </tr>
                `;
            }).join('');
        }

        function calculateGrade(score) {
            if (!score || score === '') return { grade: '-', descriptor: '-' };
            const num = parseFloat(score);
            if (isNaN(num)) return { grade: '-', descriptor: '-' };
            
            if (num >= 80) return { grade: '4', descriptor: 'Exceeds Expectations' };
            if (num >= 65) return { grade: '3', descriptor: 'Meets Expectations' };
            if (num >= 50) return { grade: '2', descriptor: 'Approaching Expectations' };
            return { grade: '1', descriptor: 'Below Expectations' };
        }

        function updateGradeDisplay(input) {
            const row = input.closest('tr');
            const score = input.value;
            const grade = calculateGrade(score);
            row.querySelector('.grade-cell').innerHTML = grade.grade;
            row.querySelector('.descriptor-cell').textContent = grade.descriptor;
        }

        async function saveGrade(studentId) {
            const row = document.querySelector(`input[data-student="${studentId}"]`).closest('tr');
            const score = row.querySelector('input').value;
            const subject = document.getElementById('subjectSelect').value;
            const type = document.getElementById('assessmentType').value;
            const term = document.getElementById('termSelect').value;

            if (!score) {
                showAlert('Please enter a score', 'warning');
                return;
            }

            const assessment = {
                student_id: studentId,
                subject,
                type,
                term,
                score: parseFloat(score)
            };

            try {
                const response = await fetchWithAuth('/assessments', {
                    method: 'POST',
                    body: JSON.stringify(assessment)
                });

                if (response.ok) {
                    // Update local data
                    const existingIndex = AppData.assessments.findIndex(a => 
                        a.studentId === studentId && 
                        a.subject === subject && 
                        a.type === type && 
                        a.term === term
                    );

                    if (existingIndex >= 0) {
                        AppData.assessments[existingIndex].score = parseFloat(score);
                    } else {
                        AppData.assessments.push(assessment);
                    }

                    showAlert('Score saved', 'success');
                } else {
                    showAlert('Error saving score', 'danger');
                }
            } catch (error) {
                console.error('Error saving grade:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function saveAllGrades() {
            const inputs = document.querySelectorAll('.score-input');
            let saveCount = 0;
            
            inputs.forEach(input => {
                if (input.value) {
                    const studentId = input.dataset.student;
                    saveGrade(studentId);
                    saveCount++;
                }
            });
            
            if (saveCount > 0) {
                showAlert(`${saveCount} scores saved successfully!`, 'success');
            }
        }

        function downloadGradeTemplate() {
            showAlert('Grade template downloaded', 'success');
        }

        function uploadGrades() {
            showAlert('Grades uploaded successfully', 'success');
        }

        // =====================================================
        // FINANCE FUNCTIONS
        // =====================================================
        function loadFinance() {
            const totalExpected = AppData.fees.reduce((sum, f) => sum + (f.total || 0), 0);
            const totalPaid = AppData.fees.reduce((sum, f) => sum + (f.paid || 0), 0);
            const totalOutstanding = totalExpected - totalPaid;
            const collectionRate = totalExpected > 0 ? Math.round((totalPaid / totalExpected) * 100) : 0;

            document.getElementById('totalExpected').textContent = `KES ${totalExpected.toLocaleString()}`;
            document.getElementById('totalCollected').textContent = `KES ${totalPaid.toLocaleString()}`;
            document.getElementById('totalOutstanding').textContent = `KES ${totalOutstanding.toLocaleString()}`;
            document.getElementById('collectionRate').textContent = collectionRate + '%';
            document.getElementById('collectionProgress').style.width = collectionRate + '%';

            document.getElementById('feeStructureBody').innerHTML = AppData.feeStructures.map(f => `
                <tr>
                    <td>${f.grade}</td>
                    <td>KES ${f.tuition.toLocaleString()}</td>
                    <td>KES ${f.boarding.toLocaleString()}</td>
                    <td>KES ${f.transport.toLocaleString()}</td>
                    <td>KES ${f.uniform.toLocaleString()}</td>
                    <td>KES ${f.activities.toLocaleString()}</td>
                    <td>KES ${f.levies.toLocaleString()}</td>
                    <td>KES ${f.total.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editFeeStructure('${f.grade}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('feeTableBody').innerHTML = AppData.fees.map(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                if (!student) return '';
                const balance = f.balance || (f.total - f.paid) || 0;
                const statusClass = balance === 0 ? 'badge-success' : balance < 10000 ? 'badge-warning' : 'badge-danger';
                const statusText = balance === 0 ? 'Paid' : balance < 10000 ? 'Partial' : 'Overdue';
                return `
                    <tr>
                        <td>${f.studentId}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>KES ${(f.total || 0).toLocaleString()}</td>
                        <td>KES ${(f.paid || 0).toLocaleString()}</td>
                        <td>KES ${balance.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${student.id}')"><i class="fas fa-money-bill"></i></button>
                            <button class="btn btn-sm btn-info" onclick="generateFeeStatement('${student.id}')"><i class="fas fa-file-invoice"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStudentDropdowns();
        }

        function filterFeeRecords() {
            const search = document.getElementById('feeSearch').value.toLowerCase();
            const status = document.getElementById('feeStatusFilter').value;
            
            const filtered = AppData.fees.filter(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                const balance = f.balance || (f.total - f.paid) || 0;
                const statusText = balance === 0 ? 'paid' : balance < 10000 ? 'partial' : 'overdue';
                return (student?.name.toLowerCase().includes(search) || f.studentId.toLowerCase().includes(search)) &&
                       (!status || status === statusText);
            });

            document.getElementById('feeTableBody').innerHTML = filtered.map(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                if (!student) return '';
                const balance = f.balance || (f.total - f.paid) || 0;
                const statusClass = balance === 0 ? 'badge-success' : balance < 10000 ? 'badge-warning' : 'badge-danger';
                const statusText = balance === 0 ? 'Paid' : balance < 10000 ? 'Partial' : 'Overdue';
                return `
                    <tr>
                        <td>${f.studentId}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>KES ${(f.total || 0).toLocaleString()}</td>
                        <td>KES ${(f.paid || 0).toLocaleString()}</td>
                        <td>KES ${balance.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${student.id}')"><i class="fas fa-money-bill"></i></button>
                            <button class="btn btn-sm btn-info" onclick="generateFeeStatement('${student.id}')"><i class="fas fa-file-invoice"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function recordPaymentForStudent(studentId) {
            const select = document.getElementById('paymentStudent');
            if (select) select.value = studentId;
            openModal('recordPaymentModal');
        }

        function togglePaymentFields() {
            const method = document.getElementById('paymentMethod').value;
            const fields = document.getElementById('paymentMethodFields');
            
            const html = {
                cash: `
                    <div class="form-group"><label>Receipt Number</label><input type="text" id="receiptNumber" class="form-control" placeholder="e.g., RCP-001"></div>
                    <div class="form-group"><label>Teller Name</label><input type="text" id="tellerName" class="form-control"></div>
                `,
                bank_deposit: `
                    <div class="form-group"><label>Bank Name</label><input type="text" id="bankName" class="form-control" placeholder="e.g., Equity"></div>
                    <div class="form-group"><label>Branch</label><input type="text" id="branch" class="form-control"></div>
                    <div class="form-group"><label>Deposit Slip No</label><input type="text" id="depositSlip" class="form-control"></div>
                `,
                cheque: `
                    <div class="form-group"><label>Cheque Number</label><input type="text" id="chequeNumber" class="form-control"></div>
                    <div class="form-group"><label>Bank</label><input type="text" id="chequeBank" class="form-control"></div>
                    <div class="form-group"><label>Drawer Name</label><input type="text" id="drawerName" class="form-control"></div>
                `,
                bank_transfer: `
                    <div class="form-group"><label>Reference Number</label><input type="text" id="referenceNumber" class="form-control"></div>
                    <div class="form-group"><label>Sender Name</label><input type="text" id="senderName" class="form-control"></div>
                    <div class="form-group"><label>Bank</label><input type="text" id="transferBank" class="form-control"></div>
                `,
                mpesa: `
                    <div class="form-group"><label>M-Pesa Transaction Code</label><input type="text" id="mpesaCode" class="form-control" placeholder="e.g., OK123ABC"></div>
                    <div class="form-group"><label>Phone Number</label><input type="text" id="mpesaPhone" class="form-control" placeholder="07XX XXX XXX"></div>
                `
            };

            fields.innerHTML = html[method] || '';
        }

        async function recordPayment(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('paymentStudent').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const paymentDate = document.getElementById('paymentDate').value;
            
            if (!studentId || !amount) {
                showAlert('Please select student and enter amount', 'warning');
                return;
            }

            const payment = {
                student_id: studentId,
                amount,
                payment_method: method,
                payment_date: paymentDate || new Date().toISOString().split('T')[0]
            };

            try {
                const response = await fetchWithAuth('/payments', {
                    method: 'POST',
                    body: JSON.stringify(payment)
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Update local data
                    const fee = AppData.fees.find(f => f.studentId === studentId);
                    if (fee) {
                        fee.paid = (fee.paid || 0) + amount;
                        fee.balance = (fee.total || 0) - fee.paid;
                    }

                    // Generate receipt
                    const student = AppData.students.find(s => s.id === studentId);
                    const receiptNo = result.receipt_number || 'RCP' + Date.now().toString().slice(-8);
                    
                    const receiptContent = document.getElementById('receiptContent');
                    receiptContent.innerHTML = `
                        <div class="receipt-header">
                            <h3>KAGEMA PRIMARY SCHOOL</h3>
                            <p>P.O. Box 1234 - 00100 Nairobi</p>
                            <p>Tel: 0722 123456 | Email: info@kagema.ac.ke</p>
                        </div>
                        <div style="margin: 20px 0;">
                            <h4>OFFICIAL RECEIPT</h4>
                            <p><strong>Receipt No:</strong> ${receiptNo}</p>
                            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                            <p><strong>Student:</strong> ${student.name} (${studentId})</p>
                            <p><strong>Class:</strong> ${student.grade} ${student.stream}</p>
                            <p><strong>Amount:</strong> KES ${amount.toLocaleString()}</p>
                            <p><strong>Payment Method:</strong> ${method.replace('_', ' ').toUpperCase()}</p>
                            <p><strong>Balance:</strong> KES ${(fee.balance || 0).toLocaleString()}</p>
                        </div>
                        <div style="border-top: 1px solid #ddd; padding-top: 10px;">
                            <p><strong>Received By:</strong> ${AppData.currentUser?.name || 'Current User'}</p>
                            <p style="margin-top: 30px;">_________________________</p>
                            <p>Authorized Signature</p>
                        </div>
                    `;

                    closeModal('recordPaymentModal');
                    openModal('receiptModal');
                    await loadFeesFromBackend();
                    loadDashboardData();
                    showAlert(`Payment of KES ${amount.toLocaleString()} recorded successfully!`, 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error recording payment', 'danger');
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function saveFeeStructure(event) {
            event.preventDefault();
            
            const grade = document.getElementById('feeGrade').value;
            const tuition = parseFloat(document.getElementById('feeTuition').value) || 0;
            const boarding = parseFloat(document.getElementById('feeBoarding').value) || 0;
            const transport = parseFloat(document.getElementById('feeTransport').value) || 0;
            const uniform = parseFloat(document.getElementById('feeUniform').value) || 0;
            const activities = parseFloat(document.getElementById('feeActivities').value) || 0;
            const levies = parseFloat(document.getElementById('feeLevies').value) || 0;
            const total = tuition + boarding + transport + uniform + activities + levies;

            const existing = AppData.feeStructures.findIndex(f => f.grade === grade);
            if (existing >= 0) {
                AppData.feeStructures[existing] = { grade, tuition, boarding, transport, uniform, activities, levies, total };
            } else {
                AppData.feeStructures.push({ grade, tuition, boarding, transport, uniform, activities, levies, total });
            }

            closeModal('feeStructureModal');
            loadFinance();
            showAlert('Fee structure saved successfully', 'success');
        }

        function editFeeStructure(grade) {
            const fee = AppData.feeStructures.find(f => f.grade === grade);
            if (!fee) return;

            document.getElementById('feeGrade').value = fee.grade;
            document.getElementById('feeTuition').value = fee.tuition;
            document.getElementById('feeBoarding').value = fee.boarding;
            document.getElementById('feeTransport').value = fee.transport;
            document.getElementById('feeUniform').value = fee.uniform;
            document.getElementById('feeActivities').value = fee.activities;
            document.getElementById('feeLevies').value = fee.levies;

            openModal('feeStructureModal');
        }

        // =====================================================
        // REPORTS FUNCTIONS
        // =====================================================
        function loadReportsDropdown() {
            const reportStudent = document.getElementById('reportStudent');
            const statementStudent = document.getElementById('statementStudent');
            
            if (reportStudent) {
                reportStudent.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            }
            
            if (statementStudent) {
                statementStudent.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            }
        }

        function generateStudentReportCard() {
            const studentId = document.getElementById('reportStudent').value;
            const term = document.getElementById('reportTerm').value;
            
            if (!studentId) {
                showAlert('Please select a student', 'warning');
                return;
            }

            const student = AppData.students.find(s => s.id === studentId);
            if (!student) return;

            const subjects = ['Mathematics', 'English', 'Kiswahili', 'Science', 'Social Studies', 'CRE', 'Agriculture', 'Computer'];
            const results = subjects.map(subject => {
                const cat1 = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'cat1' && a.term === term)?.score || '-';
                const cat2 = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'cat2' && a.term === term)?.score || '-';
                const endterm = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'endterm' && a.term === term)?.score || '-';
                
                let avg = '-', grade = '-', descriptor = '-', gradeClass = '';
                if (cat1 !== '-' && cat2 !== '-' && endterm !== '-') {
                    avg = Math.round((parseFloat(cat1) + parseFloat(cat2) + parseFloat(endterm)) / 3);
                    if (avg >= 80) { grade = '4'; descriptor = 'Exceeds'; gradeClass = 'grade-excellent'; }
                    else if (avg >= 65) { grade = '3'; descriptor = 'Meets'; gradeClass = 'grade-good'; }
                    else if (avg >= 50) { grade = '2'; descriptor = 'Approaching'; gradeClass = 'grade-fair'; }
                    else { grade = '1'; descriptor = 'Below'; gradeClass = 'grade-poor'; }
                }
                
                return `<tr>
                    <td>${subject}</td>
                    <td>${cat1}%</td>
                    <td>${cat2}%</td>
                    <td>${endterm}%</td>
                    <td>${avg}%</td>
                    <td><span class="${gradeClass}">${grade}</span></td>
                    <td>${descriptor}</td>
                </tr>`;
            }).join('');

            const reportContent = document.getElementById('reportCardContent');
            reportContent.innerHTML = `
                <div class="report-card">
                    <div class="report-header">
                        <div class="school-name">KAGEMA PRIMARY JUNIOR SECONDARY</div>
                        <div class="school-info">NEMIS: 14720001 | P.O. Box 1234 - 00100 Nairobi</div>
                        <h3>LEARNER'S PROGRESS REPORT</h3>
                        <p>${term}</p>
                    </div>
                    
                    <div class="student-info">
                        <div><strong>NAME:</strong> ${student.name}</div>
                        <div><strong>ADM NO:</strong> ${student.id}</div>
                        <div><strong>CLASS:</strong> ${student.grade} ${student.stream}</div>
                        <div><strong>UPI:</strong> ${student.upi}</div>
                    </div>

                    <table style="width: 100%; margin: 20px 0;">
                        <thead>
                            <tr>
                                <th>LEARNING AREA</th>
                                <th>CAT 1</th>
                                <th>CAT 2</th>
                                <th>END TERM</th>
                                <th>AVERAGE</th>
                                <th>GRADE</th>
                                <th>DESCRIPTOR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results}
                        </tbody>
                    </table>

                    <div style="margin-top: 20px;">
                        <p><strong>TEACHER'S COMMENTS:</strong> Good progress this term. Keep working hard.</p>
                        <p><strong>PRINCIPAL'S REMARKS:</strong> Well done. Continue with the same spirit.</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <p>NEXT TERM BEGINS: 08/05/2026</p>
                        <p>REPORT GENERATED: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            `;

            openModal('reportCardModal');
        }

        function generateBulkReportCards() {
            const grade = document.getElementById('bulkGrade').value;
            const stream = document.getElementById('bulkStream').value;
            const term = document.getElementById('bulkTerm').value;

            if (!grade || !stream) {
                showAlert('Please select grade and stream', 'warning');
                return;
            }

            const students = AppData.students.filter(s => s.grade === grade && s.stream === stream);
            if (students.length === 0) {
                showAlert('No students found in this class', 'warning');
                return;
            }

            let allReports = '';
            students.forEach(student => {
                const subjects = ['Mathematics', 'English', 'Kiswahili', 'Science', 'Social Studies', 'CRE'];
                const results = subjects.map(subject => {
                    const cat1 = AppData.assessments.find(a => a.studentId === student.id && a.subject === subject && a.type === 'cat1' && a.term === term)?.score || '-';
                    const cat2 = AppData.assessments.find(a => a.studentId === student.id && a.subject === subject && a.type === 'cat2' && a.term === term)?.score || '-';
                    const endterm = AppData.assessments.find(a => a.studentId === student.id && a.subject === subject && a.type === 'endterm' && a.term === term)?.score || '-';
                    
                    let avg = '-', grade = '-', descriptor = '-', gradeClass = '';
                    if (cat1 !== '-' && cat2 !== '-' && endterm !== '-') {
                        avg = Math.round((parseFloat(cat1) + parseFloat(cat2) + parseFloat(endterm)) / 3);
                        if (avg >= 80) { grade = '4'; descriptor = 'Exceeds'; gradeClass = 'grade-excellent'; }
                        else if (avg >= 65) { grade = '3'; descriptor = 'Meets'; gradeClass = 'grade-good'; }
                        else if (avg >= 50) { grade = '2'; descriptor = 'Approaching'; gradeClass = 'grade-fair'; }
                        else { grade = '1'; descriptor = 'Below'; gradeClass = 'grade-poor'; }
                    }
                    
                    return `<tr>
                        <td>${subject}</td>
                        <td>${cat1}%</td>
                        <td>${cat2}%</td>
                        <td>${endterm}%</td>
                        <td>${avg}%</td>
                        <td><span class="${gradeClass}">${grade}</span></td>
                        <td>${descriptor}</td>
                    </tr>`;
                }).join('');

                allReports += `
                    <div class="report-card" style="page-break-after: always; margin-bottom: 30px;">
                        <div class="report-header">
                            <div class="school-name">KAGEMA PRIMARY JUNIOR SECONDARY</div>
                            <h3>LEARNER'S PROGRESS REPORT</h3>
                            <p>${term}</p>
                        </div>
                        
                        <div class="student-info">
                            <div><strong>NAME:</strong> ${student.name}</div>
                            <div><strong>ADM NO:</strong> ${student.id}</div>
                            <div><strong>CLASS:</strong> ${student.grade} ${student.stream}</div>
                        </div>

                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>SUBJECT</th>
                                    <th>CAT 1</th>
                                    <th>CAT 2</th>
                                    <th>END TERM</th>
                                    <th>AVG</th>
                                    <th>GRADE</th>
                                </tr>
                            </thead>
                            <tbody>${results}</tbody>
                        </table>
                    </div>
                `;
            });

            document.getElementById('reportContainer').innerHTML = allReports;
            showAlert(`Generated ${students.length} report cards`, 'success');
        }

        function generateFeeStatement() {
            const studentId = document.getElementById('statementStudent').value;
            if (!studentId) {
                showAlert('Please select a student', 'warning');
                return;
            }

            const student = AppData.students.find(s => s.id === studentId);
            const fee = AppData.fees.find(f => f.studentId === studentId);
            
            if (!student || !fee) return;

            const receiptContent = document.getElementById('receiptContent');
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <h3>KAGEMA PRIMARY SCHOOL</h3>
                    <p>FEE STATEMENT</p>
                </div>
                <div style="margin: 20px 0;">
                    <p><strong>Student:</strong> ${student.name}</p>
                    <p><strong>Admission No:</strong> ${student.id}</p>
                    <p><strong>Class:</strong> ${student.grade} ${student.stream}</p>
                    <p><strong>UPI:</strong> ${student.upi}</p>
                    
                    <table style="width: 100%; margin: 20px 0;">
                        <tr><td><strong>Total Fee Charged:</strong></td><td>KES ${(fee.total || 0).toLocaleString()}</td></tr>
                        <tr><td><strong>Total Paid:</strong></td><td>KES ${(fee.paid || 0).toLocaleString()}</td></tr>
                        <tr><td><strong>Balance:</strong></td><td>KES ${(fee.balance || (fee.total - fee.paid) || 0).toLocaleString()}</td></tr>
                    </table>
                    
                    <p><strong>As at:</strong> ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            openModal('receiptModal');
        }

        function generateClassSummary() {
            const grade = document.getElementById('summaryGrade').value;
            const stream = document.getElementById('summaryStream').value;
            const term = document.getElementById('summaryTerm').value;

            if (!grade || !stream) {
                showAlert('Please select grade and stream', 'warning');
                return;
            }

            const students = AppData.students.filter(s => s.grade === grade && s.stream === stream);
            if (students.length === 0) {
                showAlert('No students found in this class', 'warning');
                return;
            }

            const subjects = ['Mathematics', 'English', 'Kiswahili', 'Science', 'Social Studies', 'CRE'];
            const summary = subjects.map(subject => {
                let totalScore = 0;
                let count = 0;
                students.forEach(student => {
                    const avg = calculateStudentAverage(student.id, subject, term);
                    if (avg > 0) {
                        totalScore += avg;
                        count++;
                    }
                });
                const classAvg = count > 0 ? Math.round(totalScore / count) : 0;
                return { subject, classAvg };
            });

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3>Class Summary - ${grade} ${stream} (${term})</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Class Average</th>
                                    <th>Performance</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            summary.forEach(s => {
                const performanceClass = s.classAvg >= 70 ? 'badge-success' : s.classAvg >= 50 ? 'badge-warning' : 'badge-danger';
                html += `
                    <tr>
                        <td>${s.subject}</td>
                        <td>${s.classAvg}%</td>
                        <td><span class="badge ${performanceClass}">${s.classAvg >= 70 ? 'Good' : s.classAvg >= 50 ? 'Average' : 'Needs Improvement'}</span></td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('reportContainer').innerHTML = html;
            showAlert(`Class summary generated for ${grade} ${stream}`, 'success');
        }

        function calculateStudentAverage(studentId, subject, term) {
            const cat1 = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'cat1' && a.term === term)?.score;
            const cat2 = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'cat2' && a.term === term)?.score;
            const endterm = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.type === 'endterm' && a.term === term)?.score;
            
            if (cat1 && cat2 && endterm) {
                return Math.round((cat1 + cat2 + endterm) / 3);
            }
            return 0;
        }

        // =====================================================
        // COMMUNICATION FUNCTIONS
        // =====================================================
        function loadCommunication() {
            const history = document.getElementById('messageHistory');
            history.innerHTML = AppData.messages.map(m => `
                <tr>
                    <td>${m.date}</td>
                    <td>${m.type}</td>
                    <td>${m.recipients} parents</td>
                    <td>${m.message.substring(0, 50)}...</td>
                    <td><span class="badge badge-success">${m.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewMessage('${m.id}')"><i class="fas fa-eye"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function searchParents() {
            const search = document.getElementById('parentSearch').value.toLowerCase();
            const filtered = AppData.students.filter(s => 
                s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search)
            );

            const select = document.getElementById('messageStudents');
            select.innerHTML = filtered.map(s => 
                `<option value="${s.id}">${s.name} - ${s.grade} ${s.stream} (F:${s.fatherPhone || s.father_phone || 'N/A'}, M:${s.motherPhone || s.mother_phone || 'N/A'})</option>`
            ).join('');

            updateRecipientCount();
        }

        function loadAllParents() {
            const select = document.getElementById('messageStudents');
            select.innerHTML = AppData.students.map(s => 
                `<option value="${s.id}">${s.name} - ${s.grade} ${s.stream} (F:${s.fatherPhone || s.father_phone || 'N/A'}, M:${s.motherPhone || s.mother_phone || 'N/A'})</option>`
            ).join('');
            updateRecipientCount();
        }

        function selectAllStudents() {
            const select = document.getElementById('messageStudents');
            for (let option of select.options) {
                option.selected = true;
            }
            updateRecipientCount();
        }

        function selectClassStudents() {
            const teacher = AppData.currentUser;
            if (teacher?.role !== 'teacher' && teacher?.role !== 'headteacher' && teacher?.role !== 'dht') {
                showAlert('This feature is for teachers only', 'warning');
                return;
            }

            const teacherClass = 'Grade 7';
            const teacherStream = 'East';

            const select = document.getElementById('messageStudents');
            for (let option of select.options) {
                const studentId = option.value;
                const student = AppData.students.find(s => s.id === studentId);
                option.selected = student?.grade === teacherClass && student?.stream === teacherStream;
            }
            updateRecipientCount();
        }

        function selectGradeStudents() {
            const grade = prompt('Enter grade (e.g., Grade 7):');
            if (!grade) return;

            const select = document.getElementById('messageStudents');
            for (let option of select.options) {
                const studentId = option.value;
                const student = AppData.students.find(s => s.id === studentId);
                option.selected = student?.grade === grade;
            }
            updateRecipientCount();
        }

        function selectStreamStudents() {
            const stream = prompt('Enter stream (e.g., East):');
            if (!stream) return;

            const select = document.getElementById('messageStudents');
            for (let option of select.options) {
                const studentId = option.value;
                const student = AppData.students.find(s => s.id === studentId);
                option.selected = student?.stream === stream;
            }
            updateRecipientCount();
        }

        function clearSelection() {
            const select = document.getElementById('messageStudents');
            for (let option of select.options) {
                option.selected = false;
            }
            updateRecipientCount();
        }

        function updateRecipientCount() {
            const select = document.getElementById('messageStudents');
            const selected = Array.from(select.selectedOptions).length;
            document.getElementById('recipientCount').textContent = selected;
            
            // Update character count
            const message = document.getElementById('messageContent').value;
            document.getElementById('messageCharCount').textContent = message.length + ' characters';
        }

        function updateMessageTemplate() {
            const type = document.getElementById('messageType').value;
            const template = document.getElementById('messageTemplate');
            const options = {
                sms: ['Fee Reminder', 'Exam Notice', 'Meeting', 'Performance Alert', 'Graduation', 'Report Card', 'Holiday', 'Emergency'],
                whatsapp: ['Fee Reminder', 'Exam Notice', 'Meeting', 'Report Card', 'Graduation', 'Performance Alert', 'Emergency'],
                email: ['Fee Statement', 'Report Card', 'Newsletter', 'Meeting', 'Graduation', 'Emergency']
            };
            template.innerHTML = options[type].map(opt => `<option value="${opt.toLowerCase().replace(' ', '')}">${opt}</option>`).join('');
            loadMessageTemplate();
        }

        function loadMessageTemplate() {
            const template = document.getElementById('messageTemplate').value;
            const content = document.getElementById('messageContent');
            
            const templates = {
                fee: 'Dear Parent, this is a reminder that school fees balance of KES [amount] is due. Please clear at your earliest convenience.\n\nPayment Methods: Cash, Bank Deposit, Cheque, Bank Transfer, M-Pesa\n\nThank you.\n- Kagema School',
                exam: 'EXAM NOTICE: End term examinations will begin on [date]. Please ensure your child is well prepared and attends all papers.\n\nExamination Timetable is available at the school notice board.\n\n- Kagema School',
                meeting: 'PARENT-TEACHER MEETING\n\nDear Parent,\n\nThere will be a parent-teacher conference on:\n Date: [date]\n Time: [time]\n Venue: School Hall\n\nYour attendance is important to discuss your child\'s progress.\n\n- Kagema School',
                performance: 'PERFORMANCE ALERT\n\nDear Parent,\n\nWe have noticed that your child needs improvement in [subject]. Current grade: [grade].\n\nPlease arrange a meeting with the subject teacher to discuss support strategies.\n\n- Kagema School',
                graduation: 'GRADUATION CEREMONY\n\nDear Parent,\n\nCongratulations! Your child has successfully completed [grade]. The graduation ceremony will be held on [date] at [time] in the school compound.\n\nWe look forward to celebrating with you.\n\n- Kagema School',
                report: 'REPORT CARD READY\n\nDear Parent,\n\nYour child\'s report card for Term [term] is ready. You can:\n1. Collect from the school\n2. Download from the parent portal\n3. Receive via WhatsApp\n\nPlease contact the school for more information.\n\n- Kagema School',
                holiday: 'HOLIDAY NOTICE\n\nDear Parent,\n\nSchools will close for holidays on [date] and re-open on [date]. Please make appropriate arrangements for your child.\n\nHave a blessed holiday.\n\n- Kagema School',
                emergency: ' EMERGENCY NOTICE \n\nDear Parent,\n\nDue to unforeseen circumstances, school will be closed today. Please pick up your child by [time].\n\nWe apologize for any inconvenience.\n\n- Kagema School'
            };
            
            content.value = templates[template] || 'Type your message here...';
            updateRecipientCount();
        }

        function sendMessage() {
            const students = document.getElementById('messageStudents').selectedOptions;
            const type = document.getElementById('messageType').value;
            const message = document.getElementById('messageContent').value;
            const includeBoth = document.getElementById('includeBothParents').checked;
            
            if (students.length === 0) {
                showAlert('Please select at least one student', 'warning');
                return;
            }
            
            if (!message) {
                showAlert('Please enter a message', 'warning');
                return;
            }
            
            let totalRecipients = 0;
            Array.from(students).forEach(option => {
                const student = AppData.students.find(s => s.id === option.value);
                if (student) {
                    if (student.fatherPhone || student.father_phone) totalRecipients++;
                    if (includeBoth && (student.motherPhone || student.mother_phone)) totalRecipients++;
                }
            });
            
            const messageId = Date.now();
            AppData.messages.unshift({
                id: messageId,
                date: new Date().toLocaleDateString(),
                type: type.toUpperCase(),
                recipients: totalRecipients,
                message: message,
                status: 'Sent'
            });
            
            showAlert(`Message sent to ${students.length} student(s) (${totalRecipients} parent(s)) via ${type.toUpperCase()}!`, 'success');
            loadCommunication();
            
            // Clear selection
            clearSelection();
            document.getElementById('messageContent').value = '';
        }

        function openBulkMessage() {
            openModal('bulkMessageModal');
        }

        function updateBulkRecipients() {
            const type = document.getElementById('bulkRecipientType').value;
            const options = document.getElementById('bulkRecipientOptions');
            
            if (type === 'grade') {
                options.innerHTML = `
                    <div class="form-group">
                        <label>Select Grade</label>
                        <select id="bulkGradeSelect" class="form-control">
                            <option value="">-- Select Grade --</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                        </select>
                    </div>
                `;
            } else if (type === 'stream') {
                options.innerHTML = `
                    <div class="form-group">
                        <label>Select Stream</label>
                        <select id="bulkStreamSelect" class="form-control">
                            <option value="">-- Select Stream --</option>
                            <option value="East">East</option>
                            <option value="West">West</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                        </select>
                    </div>
                `;
            } else {
                options.innerHTML = '';
            }
            
            updateBulkRecipientCount();
        }

        function updateBulkRecipientCount() {
            const type = document.getElementById('bulkRecipientType').value;
            let count = 0;
            
            switch(type) {
                case 'all_students':
                    count = AppData.students.length;
                    break;
                case 'all_parents':
                    count = AppData.students.reduce((sum, s) => {
                        let c = 0;
                        if (s.fatherPhone || s.father_phone) c++;
                        if (s.motherPhone || s.mother_phone) c++;
                        return sum + c;
                    }, 0);
                    break;
                case 'all_staff':
                    count = AppData.staff.length;
                    break;
                case 'all_teachers':
                    count = AppData.staff.filter(s => s.role === 'teacher').length;
                    break;
                case 'grade':
                    const grade = document.getElementById('bulkGradeSelect')?.value;
                    if (grade) {
                        count = AppData.students.filter(s => s.grade === grade).length;
                    }
                    break;
                case 'stream':
                    const stream = document.getElementById('bulkStreamSelect')?.value;
                    if (stream) {
                        count = AppData.students.filter(s => s.stream === stream).length;
                    }
                    break;
            }
            
            document.getElementById('bulkRecipientCount').textContent = count;
        }

        function sendBulkMessage() {
            const type = document.getElementById('bulkRecipientType').value;
            const messageType = document.getElementById('bulkMessageType').value;
            const subject = document.getElementById('bulkSubject').value;
            const message = document.getElementById('bulkMessage').value;
            
            if (!message) {
                showAlert('Please enter a message', 'warning');
                return;
            }
            
            let count = parseInt(document.getElementById('bulkRecipientCount').textContent);
            showAlert(`Bulk message sent to ${count} recipients via ${messageType.toUpperCase()}!`, 'success');
            closeModal('bulkMessageModal');
        }

        function viewMessage(messageId) {
            const message = AppData.messages.find(m => m.id == messageId);
            if (message) {
                showAlert(`Message: ${message.message}`, 'info');
            }
        }

        // =====================================================
        // INTERNAL CHAT FUNCTIONS
        // =====================================================
        function loadChatUsers() {
            const users = AppData.users.filter(u => u.id !== AppData.currentUser?.id);
            const chatUsers = document.getElementById('chatUsers');
            
            chatUsers.innerHTML = users.map(user => {
                const lastMsg = getLastMessage(user.id);
                const unread = getUnreadCount(user.id);
                const status = user.online ? 'online' : 'offline';
                
                return `
                    <div class="chat-user" onclick="selectChatUser(${user.id})">
                        <div class="chat-user-avatar">
                            ${user.name.charAt(0)}
                            <span class="chat-user-status status-${status}"></span>
                        </div>
                        <div class="chat-user-info">
                            <div class="chat-user-name">${user.name}</div>
                            <div class="chat-user-role">${getRoleDisplay(user.role)}</div>
                            <div class="chat-user-lastmsg">${lastMsg}</div>
                        </div>
                        <div class="chat-user-meta">
                            <div class="chat-user-time">${getLastMessageTime(user.id)}</div>
                            ${unread > 0 ? `<div class="chat-user-unread">${unread}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectChatUser(userId) {
            AppData.selectedChatUser = userId;
            const user = AppData.users.find(u => u.id === userId);
            
            document.getElementById('chatUserName').textContent = user.name;
            document.getElementById('chatUserStatus').textContent = user.online ? 'Online' : 'Offline';
            
            loadChatMessages(userId);
            
            // Mark messages as read
            document.querySelectorAll('.chat-user').forEach(el => el.classList.remove('active'));
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
        }

        function loadChatMessages(userId) {
            const messages = AppData.chatMessages[userId] || [];
            const chatMessages = document.getElementById('chatMessages');
            
            chatMessages.innerHTML = messages.map(msg => `
                <div class="message ${msg.senderId === AppData.currentUser?.id ? 'sent' : 'received'}">
                    <div class="message-content">
                        <div class="message-text">${msg.text}</div>
                        <div class="message-time">${msg.time} ${msg.senderId === AppData.currentUser?.id ? '<span class="message-status"><i class="fas fa-check-double"></i></span>' : ''}</div>
                    </div>
                </div>
            `).join('');
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !AppData.selectedChatUser) return;
            
            const message = {
                senderId: AppData.currentUser.id,
                receiverId: AppData.selectedChatUser,
                text: text,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };
            
            if (!AppData.chatMessages[AppData.selectedChatUser]) {
                AppData.chatMessages[AppData.selectedChatUser] = [];
            }
            
            AppData.chatMessages[AppData.selectedChatUser].push(message);
            loadChatMessages(AppData.selectedChatUser);
            input.value = '';
            
            // Simulate reply after 2 seconds
            setTimeout(() => {
                const reply = {
                    senderId: AppData.selectedChatUser,
                    receiverId: AppData.currentUser.id,
                    text: 'Thanks for your message!',
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                if (!AppData.chatMessages[AppData.currentUser.id]) {
                    AppData.chatMessages[AppData.currentUser.id] = [];
                }
                AppData.chatMessages[AppData.currentUser.id].push(reply);
                if (AppData.selectedChatUser === AppData.currentUser.id) {
                    loadChatMessages(AppData.selectedChatUser);
                }
            }, 2000);
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function getLastMessage(userId) {
            const messages = AppData.chatMessages[userId];
            if (!messages || messages.length === 0) return 'No messages';
            return messages[messages.length - 1].text.substring(0, 30) + (messages[messages.length - 1].text.length > 30 ? '...' : '');
        }

        function getLastMessageTime(userId) {
            const messages = AppData.chatMessages[userId];
            if (!messages || messages.length === 0) return '';
            return messages[messages.length - 1].time;
        }

        function getUnreadCount(userId) {
            // Simple implementation - in real app would track read status
            return 0;
        }

        function searchChatUsers() {
            const search = document.getElementById('chatSearch').value.toLowerCase();
            const users = AppData.users.filter(u => 
                u.id !== AppData.currentUser?.id && 
                u.name.toLowerCase().includes(search)
            );
            
            const chatUsers = document.getElementById('chatUsers');
            chatUsers.innerHTML = users.map(user => {
                const lastMsg = getLastMessage(user.id);
                const unread = getUnreadCount(user.id);
                const status = user.online ? 'online' : 'offline';
                
                return `
                    <div class="chat-user" onclick="selectChatUser(${user.id})">
                        <div class="chat-user-avatar">
                            ${user.name.charAt(0)}
                            <span class="chat-user-status status-${status}"></span>
                        </div>
                        <div class="chat-user-info">
                            <div class="chat-user-name">${user.name}</div>
                            <div class="chat-user-role">${getRoleDisplay(user.role)}</div>
                            <div class="chat-user-lastmsg">${lastMsg}</div>
                        </div>
                        <div class="chat-user-meta">
                            <div class="chat-user-time">${getLastMessageTime(user.id)}</div>
                            ${unread > 0 ? `<div class="chat-user-unread">${unread}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startVideoCall() {
            if (!AppData.selectedChatUser) {
                showAlert('Please select a user to start a video call', 'warning');
                return;
            }
            
            showSection('videoMeeting');
            const user = AppData.users.find(u => u.id === AppData.selectedChatUser);
            showAlert(`Video call started with ${user.name}`, 'success');
        }

        function shareFile() {
            if (!AppData.selectedChatUser) {
                showAlert('Please select a user to share a file', 'warning');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = (e) => {
                const file = e.target.files[0];
                showAlert(`File "${file.name}" shared successfully`, 'success');
                
                // Add file message to chat
                const message = {
                    senderId: AppData.currentUser.id,
                    receiverId: AppData.selectedChatUser,
                    text: ` Shared file: ${file.name}`,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                
                if (!AppData.chatMessages[AppData.selectedChatUser]) {
                    AppData.chatMessages[AppData.selectedChatUser] = [];
                }
                
                AppData.chatMessages[AppData.selectedChatUser].push(message);
                if (AppData.selectedChatUser === AppData.currentUser?.id) {
                    loadChatMessages(AppData.selectedChatUser);
                }
            };
            input.click();
        }

        function viewChatHistory() {
            showAlert('Chat history feature coming soon', 'info');
        }

        // =====================================================
        // VIDEO MEETING FUNCTIONS
        // =====================================================
        function loadVideoMeeting() {
            const participants = document.getElementById('meetingParticipants');
            const users = AppData.users.filter(u => u.id !== AppData.currentUser?.id).slice(0, 3);
            
            participants.innerHTML = `
                <div class="meeting-participant speaking">
                    <div class="participant-info">
                        <div class="participant-avatar">${AppData.currentUser.name.charAt(0)}</div>
                        <div class="participant-name">${AppData.currentUser.name} (You)</div>
                        <div class="participant-role">${getRoleDisplay(AppData.currentUser.role)}</div>
                    </div>
                    <span class="participant-status" style="background: var(--success);"></span>
                    <div class="participant-audio-indicator">
                        <i class="fas fa-microphone"></i>
                    </div>
                </div>
                ${users.map(user => `
                    <div class="meeting-participant">
                        <div class="participant-info">
                            <div class="participant-avatar">${user.name.charAt(0)}</div>
                            <div class="participant-name">${user.name}</div>
                            <div class="participant-role">${getRoleDisplay(user.role)}</div>
                        </div>
                        <span class="participant-status" style="background: ${user.online ? 'var(--success)' : 'var(--offline)'};"></span>
                        <div class="participant-audio-indicator muted">
                            <i class="fas fa-microphone-slash"></i>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function toggleMic() {
            const micBtn = document.querySelector('.meeting-control:first-child');
            micBtn.classList.toggle('active');
            showAlert(micBtn.classList.contains('active') ? 'Microphone unmuted' : 'Microphone muted', 'info');
        }

        function toggleCamera() {
            const cameraBtn = document.querySelectorAll('.meeting-control')[1];
            cameraBtn.classList.toggle('active');
            showAlert(cameraBtn.classList.contains('active') ? 'Camera turned on' : 'Camera turned off', 'info');
        }

        function shareScreen() {
            const screenBtn = document.querySelectorAll('.meeting-control')[2];
            screenBtn.classList.toggle('active');
            showAlert(screenBtn.classList.contains('active') ? 'Screen sharing started' : 'Screen sharing stopped', 'info');
        }

        function inviteParticipants() {
            showAlert('Invitation sent to selected staff members', 'success');
        }

        function toggleChat() {
            const chatDiv = document.getElementById('meetingChat');
            chatDiv.style.display = chatDiv.style.display === 'none' ? 'block' : 'none';
        }

        function recordMeeting() {
            const recordBtn = document.querySelectorAll('.meeting-control')[5];
            recordBtn.classList.toggle('active');
            showAlert(recordBtn.classList.contains('active') ? 'Recording started' : 'Recording stopped', 'info');
        }

        function toggleParticipants() {
            showAlert('Participant list toggled', 'info');
        }

        function shareWhiteboard() {
            showAlert('Whiteboard shared', 'info');
        }

        function endMeeting() {
            if (confirm('Are you sure you want to end the meeting?')) {
                showSection('dashboard');
                showAlert('Meeting ended', 'info');
            }
        }

        // =====================================================
        // ANNOUNCEMENT FUNCTIONS
        // =====================================================
        function loadAnnouncements() {
            const list = document.getElementById('announcementsList');
            list.innerHTML = AppData.announcements.map(a => `
                <div class="announcement">
                    <div class="announcement-header">
                        <span class="announcement-author">${a.author}</span>
                        <span class="announcement-date">${a.date}</span>
                    </div>
                    <div class="announcement-title">${a.title}</div>
                    <div class="announcement-content">${a.content}</div>
                    <div class="announcement-footer">
                        <span><i class="far fa-heart"></i> ${a.likes || 0}</span>
                        <span><i class="far fa-comment"></i> ${a.comments || 0}</span>
                        <span><i class="far fa-eye"></i> ${a.views || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        function filterAnnouncements() {
            const filter = document.getElementById('announcementFilter').value;
            let filtered = AppData.announcements;
            
            const now = new Date();
            if (filter === 'today') {
                filtered = AppData.announcements.filter(a => {
                    const date = new Date(a.date);
                    return date.toDateString() === now.toDateString();
                });
            } else if (filter === 'week') {
                const weekAgo = new Date(now.setDate(now.getDate() - 7));
                filtered = AppData.announcements.filter(a => new Date(a.date) >= weekAgo);
            } else if (filter === 'month') {
                const monthAgo = new Date(now.setMonth(now.getMonth() - 1));
                filtered = AppData.announcements.filter(a => new Date(a.date) >= monthAgo);
            }
            
            document.getElementById('announcementsList').innerHTML = filtered.map(a => `
                <div class="announcement">
                    <div class="announcement-header">
                        <span class="announcement-author">${a.author}</span>
                        <span class="announcement-date">${a.date}</span>
                    </div>
                    <div class="announcement-title">${a.title}</div>
                    <div class="announcement-content">${a.content}</div>
                    <div class="announcement-footer">
                        <span><i class="far fa-heart"></i> ${a.likes || 0}</span>
                        <span><i class="far fa-comment"></i> ${a.comments || 0}</span>
                        <span><i class="far fa-eye"></i> ${a.views || 0}</span>
                    </div>
                </div>
            `).join('');
        }

        function postAnnouncement() {
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            const audience = document.getElementById('announcementAudience').value;
            const priority = document.getElementById('announcementPriority').value;
            
            if (!title || !content) {
                showAlert('Please enter title and content', 'warning');
                return;
            }
            
            AppData.announcements.unshift({
                id: Date.now(),
                title,
                content,
                author: AppData.currentUser.name,
                authorRole: AppData.currentUser.role,
                date: new Date().toLocaleDateString(),
                audience,
                priority,
                likes: 0,
                comments: 0,
                views: 0
            });
            
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            
            loadAnnouncements();
            loadDashboardData();
            showAlert('Announcement posted successfully!', 'success');
        }

        // =====================================================
        // STAFF DIRECTORY FUNCTIONS
        // =====================================================
        function loadStaffDirectory() {
            const grid = document.getElementById('staffDirectoryGrid');
            grid.innerHTML = AppData.users.map(user => `
                <div class="staff-card">
                    <div class="staff-avatar">${user.name.charAt(0)}</div>
                    <div class="staff-name">${user.name}</div>
                    <div class="staff-role">${getRoleDisplay(user.role)}</div>
                    <div class="staff-department">${user.department || 'General'}</div>
                    <div class="staff-contact"><i class="fas fa-phone"></i> ${user.phone || 'N/A'}</div>
                    <div class="staff-actions">
                        <button onclick="startChatWithUser(${user.id})" title="Chat"><i class="fas fa-comment"></i></button>
                        <button onclick="startVideoCallWithUser(${user.id})" title="Video Call"><i class="fas fa-video"></i></button>
                        <button onclick="callUser(${user.id})" title="Call"><i class="fas fa-phone"></i></button>
                        <button onclick="emailUser(${user.id})" title="Email"><i class="fas fa-envelope"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function filterDirectory() {
            const search = document.getElementById('directorySearch').value.toLowerCase();
            const department = document.getElementById('departmentFilter').value;
            
            const filtered = AppData.users.filter(u => 
                u.name.toLowerCase().includes(search) && 
                (!department || u.department === department)
            );
            
            const grid = document.getElementById('staffDirectoryGrid');
            grid.innerHTML = filtered.map(user => `
                <div class="staff-card">
                    <div class="staff-avatar">${user.name.charAt(0)}</div>
                    <div class="staff-name">${user.name}</div>
                    <div class="staff-role">${getRoleDisplay(user.role)}</div>
                    <div class="staff-department">${user.department || 'General'}</div>
                    <div class="staff-contact"><i class="fas fa-phone"></i> ${user.phone || 'N/A'}</div>
                    <div class="staff-actions">
                        <button onclick="startChatWithUser(${user.id})" title="Chat"><i class="fas fa-comment"></i></button>
                        <button onclick="startVideoCallWithUser(${user.id})" title="Video Call"><i class="fas fa-video"></i></button>
                        <button onclick="callUser(${user.id})" title="Call"><i class="fas fa-phone"></i></button>
                        <button onclick="emailUser(${user.id})" title="Email"><i class="fas fa-envelope"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function startChatWithUser(userId) {
            showSection('internalChat');
            selectChatUser(userId);
        }

        function startVideoCallWithUser(userId) {
            showSection('videoMeeting');
            const user = AppData.users.find(u => u.id === userId);
            showAlert(`Video call started with ${user.name}`, 'success');
        }

        function callUser(userId) {
            const user = AppData.users.find(u => u.id === userId);
            showAlert(`Calling ${user.name}... (Demo - No actual call placed)`, 'info');
        }

        function emailUser(userId) {
            const user = AppData.users.find(u => u.id === userId);
            window.location.href = `mailto:${user.email}`;
        }

        // =====================================================
        // STAFF MANAGEMENT FUNCTIONS
        // =====================================================
        function loadStaff() {
            document.getElementById('staffTableBody').innerHTML = AppData.staff.map(s => `
                <tr>
                    <td>${s.tsc || s.tsc_number || ''}</td>
                    <td>${s.name}</td>
                    <td><span class="role-badge role-${s.role === 'teacher' ? 'teacher' : 'staff'}">${getRoleDisplay(s.role)}</span></td>
                    <td>${s.department || ''}</td>
                    <td>${s.phone || ''}</td>
                    <td>${s.email || ''}</td>
                    <td><span class="badge badge-success">${s.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editStaff('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStaff('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterStaff() {
            const search = document.getElementById('staffSearch').value.toLowerCase();
            const role = document.getElementById('staffRoleFilter').value;
            
            const filtered = AppData.staff.filter(s => 
                s.name.toLowerCase().includes(search) && 
                (!role || s.role === role)
            );

            document.getElementById('staffTableBody').innerHTML = filtered.map(s => `
                <tr>
                    <td>${s.tsc || s.tsc_number || ''}</td>
                    <td>${s.name}</td>
                    <td><span class="role-badge role-${s.role === 'teacher' ? 'teacher' : 'staff'}">${getRoleDisplay(s.role)}</span></td>
                    <td>${s.department || ''}</td>
                    <td>${s.phone || ''}</td>
                    <td>${s.email || ''}</td>
                    <td><span class="badge badge-success">${s.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editStaff('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStaff('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveStaff(event) {
            event.preventDefault();
            
            const newStaff = {
                tsc_number: document.getElementById('staffTsc').value,
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                department: document.getElementById('staffDept').value,
                phone: document.getElementById('staffPhone').value,
                email: document.getElementById('staffEmail').value,
                qualification: document.getElementById('staffQualification').value
            };

            try {
                const response = await fetchWithAuth('/staff', {
                    method: 'POST',
                    body: JSON.stringify(newStaff)
                });

                if (response.ok) {
                    closeModal('addStaffModal');
                    await loadStaffFromBackend();
                    showAlert(`Staff member ${newStaff.name} added successfully!`, 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error adding staff', 'danger');
                }
            } catch (error) {
                console.error('Error saving staff:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function editStaff(staffId) {
            const staff = AppData.staff.find(s => s.id == staffId);
            if (!staff) return;

            document.getElementById('staffName').value = staff.name;
            document.getElementById('staffTsc').value = staff.tsc || staff.tsc_number || '';
            document.getElementById('staffRole').value = staff.role;
            document.getElementById('staffDept').value = staff.department || '';
            document.getElementById('staffPhone').value = staff.phone || '';
            document.getElementById('staffEmail').value = staff.email || '';
            document.getElementById('staffQualification').value = staff.qualification || '';

            const form = document.querySelector('#addStaffModal form');
            form.onsubmit = (e) => updateStaff(e, staffId);
            
            openModal('addStaffModal');
        }

        async function updateStaff(event, staffId) {
            event.preventDefault();
            
            const updatedStaff = {
                name: document.getElementById('staffName').value,
                tsc_number: document.getElementById('staffTsc').value,
                role: document.getElementById('staffRole').value,
                department: document.getElementById('staffDept').value,
                phone: document.getElementById('staffPhone').value,
                email: document.getElementById('staffEmail').value,
                qualification: document.getElementById('staffQualification').value
            };

            try {
                const response = await fetchWithAuth(`/staff/${staffId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedStaff)
                });

                if (response.ok) {
                    closeModal('addStaffModal');
                    await loadStaffFromBackend();
                    showAlert('Staff updated successfully', 'success');
                    
                    document.querySelector('#addStaffModal form').reset();
                    document.querySelector('#addStaffModal form').onsubmit = saveStaff;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating staff', 'danger');
                }
            } catch (error) {
                console.error('Error updating staff:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteStaff(staffId) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/staff/${staffId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadStaffFromBackend();
                        showAlert('Staff record deleted', 'success');
                    } else {
                        showAlert('Error deleting staff', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting staff:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // ALUMNI FUNCTIONS
        // =====================================================
        function loadAlumni() {
            document.getElementById('alumniTableBody').innerHTML = AppData.alumni.map(a => `
                <tr>
                    <td>${a.student_id || a.id}</td>
                    <td>${a.name}</td>
                    <td>${a.last_grade || a.grade}</td>
                    <td>${a.last_stream || a.stream}</td>
                    <td>${a.year_left || ''}</td>
                    <td>${a.reason || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewAlumni('${a.student_id || a.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAlumni('${a.student_id || a.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterAlumni() {
            const search = document.getElementById('alumniSearch').value.toLowerCase();
            const year = document.getElementById('alumniYearFilter').value;
            
            const filtered = AppData.alumni.filter(a => 
                a.name.toLowerCase().includes(search) && 
                (!year || a.year_left === year)
            );

            document.getElementById('alumniTableBody').innerHTML = filtered.map(a => `
                <tr>
                    <td>${a.student_id || a.id}</td>
                    <td>${a.name}</td>
                    <td>${a.last_grade || a.grade}</td>
                    <td>${a.last_stream || a.stream}</td>
                    <td>${a.year_left || ''}</td>
                    <td>${a.reason || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewAlumni('${a.student_id || a.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAlumni('${a.student_id || a.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function viewAlumni(alumniId) {
            showAlert(`View alumni: ${alumniId}`, 'info');
        }

        function deleteAlumni(alumniId) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/alumni/${alumniId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadAlumniFromBackend();
                        showAlert('Alumni record deleted', 'success');
                    } else {
                        showAlert('Error deleting alumni', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting alumni:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // INVENTORY FUNCTIONS
        // =====================================================
        function loadInventory() {
            document.getElementById('inventoryTableBody').innerHTML = AppData.inventory.map(i => `
                <tr>
                    <td>${i.code || i.item_code}</td>
                    <td>${i.name || i.item_name}</td>
                    <td>${i.category}</td>
                    <td>${i.quantity}</td>
                    <td>${i.unit}</td>
                    <td>${i.location}</td>
                    <td><span class="badge badge-success">${i.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editInventory('${i.code || i.item_code}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventory('${i.code || i.item_code}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterInventory() {
            const search = document.getElementById('inventorySearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            
            const filtered = AppData.inventory.filter(i => 
                (i.name || i.item_name).toLowerCase().includes(search) && 
                (!category || i.category === category)
            );

            document.getElementById('inventoryTableBody').innerHTML = filtered.map(i => `
                <tr>
                    <td>${i.code || i.item_code}</td>
                    <td>${i.name || i.item_name}</td>
                    <td>${i.category}</td>
                    <td>${i.quantity}</td>
                    <td>${i.unit}</td>
                    <td>${i.location}</td>
                    <td><span class="badge badge-success">${i.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editInventory('${i.code || i.item_code}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventory('${i.code || i.item_code}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveInventory(event) {
            event.preventDefault();
            
            const newItem = {
                item_code: document.getElementById('itemCode').value,
                item_name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                unit: document.getElementById('itemUnit').value,
                location: document.getElementById('itemLocation').value
            };

            try {
                const response = await fetchWithAuth('/inventory', {
                    method: 'POST',
                    body: JSON.stringify(newItem)
                });

                if (response.ok) {
                    closeModal('addInventoryModal');
                    await loadInventoryFromBackend();
                    showAlert('Inventory item added successfully!', 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error adding item', 'danger');
                }
            } catch (error) {
                console.error('Error saving inventory:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function editInventory(code) {
            const item = AppData.inventory.find(i => (i.code || i.item_code) === code);
            if (!item) return;

            document.getElementById('itemCode').value = item.code || item.item_code;
            document.getElementById('itemName').value = item.name || item.item_name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemLocation').value = item.location;

            const form = document.querySelector('#addInventoryModal form');
            form.onsubmit = (e) => updateInventory(e, code);
            
            openModal('addInventoryModal');
        }

        async function updateInventory(event, code) {
            event.preventDefault();
            
            const updatedItem = {
                item_code: document.getElementById('itemCode').value,
                item_name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                unit: document.getElementById('itemUnit').value,
                location: document.getElementById('itemLocation').value
            };

            try {
                const response = await fetchWithAuth(`/inventory/${code}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedItem)
                });

                if (response.ok) {
                    closeModal('addInventoryModal');
                    await loadInventoryFromBackend();
                    showAlert('Inventory updated successfully', 'success');
                    
                    document.querySelector('#addInventoryModal form').reset();
                    document.querySelector('#addInventoryModal form').onsubmit = saveInventory;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating item', 'danger');
                }
            } catch (error) {
                console.error('Error updating inventory:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteInventory(code) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/inventory/${code}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadInventoryFromBackend();
                        showAlert('Inventory item deleted', 'success');
                    } else {
                        showAlert('Error deleting item', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting inventory:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // TRANSPORT FUNCTIONS
        // =====================================================
        function loadTransport() {
            document.getElementById('transportTableBody').innerHTML = AppData.transport.map(t => `
                <tr>
                    <td>${t.route || t.route_name}</td>
                    <td>${t.vehicle || t.vehicle_reg}</td>
                    <td>${t.driver || t.driver_name}</td>
                    <td>${t.students || t.students_count || 0}</td>
                    <td><span class="badge badge-success">${t.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editRoute('${t.route || t.route_name}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRoute('${t.route || t.route_name}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveRoute(event) {
            event.preventDefault();
            
            const newRoute = {
                route_name: document.getElementById('routeName').value,
                vehicle_reg: document.getElementById('vehicleReg').value,
                driver_name: document.getElementById('driverName').value,
                driver_phone: document.getElementById('driverPhone').value,
                capacity: parseInt(document.getElementById('vehicleCapacity').value) || 40
            };

            try {
                const response = await fetchWithAuth('/transport', {
                    method: 'POST',
                    body: JSON.stringify(newRoute)
                });

                if (response.ok) {
                    closeModal('addRouteModal');
                    await loadTransportFromBackend();
                    showAlert('Transport route added successfully!', 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error adding route', 'danger');
                }
            } catch (error) {
                console.error('Error saving route:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function editRoute(route) {
            const routeData = AppData.transport.find(t => (t.route || t.route_name) === route);
            if (!routeData) return;

            document.getElementById('routeName').value = routeData.route || routeData.route_name;
            document.getElementById('vehicleReg').value = routeData.vehicle || routeData.vehicle_reg;
            document.getElementById('driverName').value = routeData.driver || routeData.driver_name;
            document.getElementById('driverPhone').value = routeData.driver_phone || '';
            document.getElementById('vehicleCapacity').value = routeData.capacity || 40;

            const form = document.querySelector('#addRouteModal form');
            form.onsubmit = (e) => updateRoute(e, route);
            
            openModal('addRouteModal');
        }

        async function updateRoute(event, oldRoute) {
            event.preventDefault();
            
            const updatedRoute = {
                route_name: document.getElementById('routeName').value,
                vehicle_reg: document.getElementById('vehicleReg').value,
                driver_name: document.getElementById('driverName').value,
                driver_phone: document.getElementById('driverPhone').value,
                capacity: parseInt(document.getElementById('vehicleCapacity').value) || 40
            };

            try {
                const response = await fetchWithAuth(`/transport/${encodeURIComponent(oldRoute)}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedRoute)
                });

                if (response.ok) {
                    closeModal('addRouteModal');
                    await loadTransportFromBackend();
                    showAlert('Route updated successfully', 'success');
                    
                    document.querySelector('#addRouteModal form').reset();
                    document.querySelector('#addRouteModal form').onsubmit = saveRoute;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating route', 'danger');
                }
            } catch (error) {
                console.error('Error updating route:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteRoute(route) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/transport/${encodeURIComponent(route)}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadTransportFromBackend();
                        showAlert('Route deleted', 'success');
                    } else {
                        showAlert('Error deleting route', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting route:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // HOSTEL FUNCTIONS
        // =====================================================
        function loadHostel() {
            const roomStudent = document.getElementById('roomStudent');
            if (roomStudent) {
                roomStudent.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
            }

            document.getElementById('hostelTableBody').innerHTML = AppData.hostel.map(h => `
                <tr>
                    <td>${h.hostel || h.hostel_name}</td>
                    <td>${h.room || h.room_number}</td>
                    <td>${h.bed || h.bed_number}</td>
                    <td>${h.student || ''}</td>
                    <td>${h.admNo || h.adm_no || ''}</td>
                    <td><span class="badge badge-success">${h.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editAllocation('${h.room || h.room_number}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAllocation('${h.room || h.room_number}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Update stats
            const totalBeds = 240;
            const occupied = AppData.hostel.filter(h => h.status === 'Occupied').length;
            const available = totalBeds - occupied;
            
            document.getElementById('totalCapacity').textContent = totalBeds;
            document.getElementById('occupiedBeds').textContent = occupied;
            document.getElementById('availableBeds').textContent = available;
        }

        async function saveAllocation(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('roomStudent').value;
            const student = AppData.students.find(s => s.id === studentId);
            
            const allocation = {
                hostel_name: document.getElementById('hostelName').value,
                room_number: document.getElementById('roomNumber').value,
                bed_number: document.getElementById('bedNumber').value || 'B1',
                student_id: studentId || null,
                student_name: student?.name || '',
                status: studentId ? 'Occupied' : 'Available'
            };

            try {
                const response = await fetchWithAuth('/hostel', {
                    method: 'POST',
                    body: JSON.stringify(allocation)
                });

                if (response.ok) {
                    closeModal('allocateRoomModal');
                    await loadHostelFromBackend();
                    showAlert('Room allocated successfully!', 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error allocating room', 'danger');
                }
            } catch (error) {
                console.error('Error saving allocation:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function allocateRoom(event) {
            event.preventDefault();
            saveAllocation(event);
        }

        function editAllocation(room) {
            const allocation = AppData.hostel.find(h => (h.room || h.room_number) === room);
            if (!allocation) return;

            document.getElementById('hostelName').value = allocation.hostel || allocation.hostel_name;
            document.getElementById('roomNumber').value = allocation.room || allocation.room_number;
            document.getElementById('bedNumber').value = allocation.bed || allocation.bed_number;
            document.getElementById('roomStudent').value = allocation.student_id || allocation.admNo || allocation.adm_no || '';

            const form = document.querySelector('#allocateRoomModal form');
            form.onsubmit = (e) => updateAllocation(e, room);
            
            openModal('allocateRoomModal');
        }

        async function updateAllocation(event, oldRoom) {
            event.preventDefault();
            
            const studentId = document.getElementById('roomStudent').value;
            const student = AppData.students.find(s => s.id === studentId);
            
            const updatedAllocation = {
                hostel_name: document.getElementById('hostelName').value,
                room_number: document.getElementById('roomNumber').value,
                bed_number: document.getElementById('bedNumber').value || 'B1',
                student_id: studentId || null,
                student_name: student?.name || '',
                status: studentId ? 'Occupied' : 'Available'
            };

            try {
                const response = await fetchWithAuth(`/hostel/${encodeURIComponent(oldRoom)}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedAllocation)
                });

                if (response.ok) {
                    closeModal('allocateRoomModal');
                    await loadHostelFromBackend();
                    showAlert('Allocation updated successfully', 'success');
                    
                    document.querySelector('#allocateRoomModal form').reset();
                    document.querySelector('#allocateRoomModal form').onsubmit = allocateRoom;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating allocation', 'danger');
                }
            } catch (error) {
                console.error('Error updating allocation:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteAllocation(room) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/hostel/${encodeURIComponent(room)}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadHostelFromBackend();
                        showAlert('Allocation removed', 'success');
                    } else {
                        showAlert('Error removing allocation', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting allocation:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // LIBRARY FUNCTIONS
        // =====================================================
        function loadLibrary() {
            document.getElementById('libraryTableBody').innerHTML = AppData.library.map(b => `
                <tr>
                    <td>${b.isbn}</td>
                    <td>${b.title}</td>
                    <td>${b.author}</td>
                    <td>${b.category}</td>
                    <td>${b.total_copies || b.totalCopies}</td>
                    <td>${b.available_copies || b.available}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editBook('${b.isbn}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook('${b.isbn}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('borrowedBooksBody').innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center;">No borrowed books</td>
                </tr>
            `;
        }

        function filterBooks() {
            const search = document.getElementById('bookSearch').value.toLowerCase();
            const category = document.getElementById('bookCategoryFilter').value;
            
            const filtered = AppData.library.filter(b => 
                (b.title.toLowerCase().includes(search) || b.author?.toLowerCase().includes(search)) &&
                (!category || b.category === category)
            );

            document.getElementById('libraryTableBody').innerHTML = filtered.map(b => `
                <tr>
                    <td>${b.isbn}</td>
                    <td>${b.title}</td>
                    <td>${b.author}</td>
                    <td>${b.category}</td>
                    <td>${b.total_copies || b.totalCopies}</td>
                    <td>${b.available_copies || b.available}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editBook('${b.isbn}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook('${b.isbn}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveBook(event) {
            event.preventDefault();
            
            const newBook = {
                isbn: document.getElementById('bookIsbn').value || 'ISBN' + Date.now(),
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                publisher: document.getElementById('bookPublisher').value,
                category: document.getElementById('bookCategory').value,
                total_copies: parseInt(document.getElementById('bookCopies').value) || 1
            };

            try {
                const response = await fetchWithAuth('/library', {
                    method: 'POST',
                    body: JSON.stringify(newBook)
                });

                if (response.ok) {
                    closeModal('addBookModal');
                    await loadLibraryFromBackend();
                    showAlert('Book added to library successfully!', 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error adding book', 'danger');
                }
            } catch (error) {
                console.error('Error saving book:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function editBook(isbn) {
            const book = AppData.library.find(b => b.isbn === isbn);
            if (!book) return;

            document.getElementById('bookIsbn').value = book.isbn;
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookAuthor').value = book.author || '';
            document.getElementById('bookPublisher').value = book.publisher || '';
            document.getElementById('bookCategory').value = book.category;
            document.getElementById('bookCopies').value = book.total_copies || book.totalCopies || 1;

            const form = document.querySelector('#addBookModal form');
            form.onsubmit = (e) => updateBook(e, isbn);
            
            openModal('addBookModal');
        }

        async function updateBook(event, oldIsbn) {
            event.preventDefault();
            
            const updatedBook = {
                isbn: document.getElementById('bookIsbn').value || oldIsbn,
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                publisher: document.getElementById('bookPublisher').value,
                category: document.getElementById('bookCategory').value,
                total_copies: parseInt(document.getElementById('bookCopies').value) || 1
            };

            try {
                const response = await fetchWithAuth(`/library/${oldIsbn}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedBook)
                });

                if (response.ok) {
                    closeModal('addBookModal');
                    await loadLibraryFromBackend();
                    showAlert('Book updated successfully', 'success');
                    
                    document.querySelector('#addBookModal form').reset();
                    document.querySelector('#addBookModal form').onsubmit = saveBook;
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Error updating book', 'danger');
                }
            } catch (error) {
                console.error('Error updating book:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function deleteBook(isbn) {
            AppData.deleteCallback = async () => {
                try {
                    const response = await fetchWithAuth(`/library/${isbn}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        await loadLibraryFromBackend();
                        showAlert('Book deleted', 'success');
                    } else {
                        showAlert('Error deleting book', 'danger');
                    }
                } catch (error) {
                    console.error('Error deleting book:', error);
                    showAlert('Error connecting to server', 'danger');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // =====================================================
        // PROFILE FUNCTIONS
        // =====================================================
        function loadProfile() {
            const user = AppData.currentUser;
            if (!user) return;

            document.getElementById('profileName').value = user.name || '';
            document.getElementById('profileUsername').value = user.username || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profilePhone').value = user.phone || '';
            document.getElementById('profileRole').value = getRoleDisplay(user.role) || '';
            document.getElementById('profileProfId').value = user.professionalId || user.professional_id || '';
            document.getElementById('profileDept').value = user.department || '';
        }

        async function updateProfile() {
            const userData = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value,
                department: document.getElementById('profileDept').value
            };

            try {
                const response = await fetchWithAuth(`/users/${AppData.currentUser.username}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    // Update local user data
                    Object.assign(AppData.currentUser, userData);
                    updateUserDisplay();
                    showAlert('Profile updated successfully!', 'success');
                } else {
                    showAlert('Error updating profile', 'danger');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('Error connecting to server', 'danger');
            }
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Please fill in all password fields', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match', 'warning');
                return;
            }

            showAlert('Password changed successfully!', 'success');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // =====================================================
        // SETTINGS FUNCTIONS
        // =====================================================
        function loadSettings() {
            // Load settings from localStorage if available
            const savedSettings = localStorage.getItem('schoolSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('schoolName').value = settings.schoolName || 'Kagema Primary Junior Secondary';
                document.getElementById('schoolPhone').value = settings.schoolPhone || '0722 123456';
                document.getElementById('schoolEmail').value = settings.schoolEmail || 'info@kagema.ac.ke';
                document.getElementById('schoolAddress').value = settings.schoolAddress || 'P.O. Box 1234 - 00100 Nairobi';
                document.getElementById('schoolCounty').value = settings.schoolCounty || 'Nairobi';
                document.getElementById('academicYear').value = settings.academicYear || '2026';
                document.getElementById('currentTerm').value = settings.currentTerm || 'Term 1';
            }
        }

        function saveSettings() {
            const settings = {
                schoolName: document.getElementById('schoolName').value,
                schoolPhone: document.getElementById('schoolPhone').value,
                schoolEmail: document.getElementById('schoolEmail').value,
                schoolAddress: document.getElementById('schoolAddress').value,
                schoolCounty: document.getElementById('schoolCounty').value,
                academicYear: document.getElementById('academicYear').value,
                currentTerm: document.getElementById('currentTerm').value
            };

            localStorage.setItem('schoolSettings', JSON.stringify(settings));
            showAlert('Settings saved successfully!', 'success');
        }

        function backupSystem() {
            const data = JSON.stringify(AppData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kagema_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showAlert('System backup created successfully!', 'success');
        }

        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        Object.assign(AppData, data);
                        showAlert('System restored from backup successfully!', 'success');
                        loadAllLocalData();
                    } catch (error) {
                        showAlert('Error restoring backup', 'danger');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportAllData() {
            const data = JSON.stringify(AppData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kagema_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showAlert('All data exported successfully!', 'success');
        }

        function applyTheme() {
            const primaryColor = document.getElementById('primaryColor').value;
            const accentColor = document.getElementById('accentColor').value;
            
            document.documentElement.style.setProperty('--primary', primaryColor);
            document.documentElement.style.setProperty('--accent', accentColor);
            
            localStorage.setItem('themePrimary', primaryColor);
            localStorage.setItem('themeAccent', accentColor);
            
            showAlert('Theme applied successfully!', 'success');
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            else if (type === 'danger') icon = 'fa-exclamation-circle';
            else if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            alertDiv.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.classList.add('show'), 100);
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }

        function notifyParent(studentId) {
            const student = AppData.students.find(s => s.id === studentId);
            if (student) {
                showAlert(`Notification sent to ${student.fatherPhone || student.father_phone || student.motherPhone || student.mother_phone}`, 'success');
            }
        }

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            showAlert('Receipt downloaded as PDF', 'success');
        }

        function emailReceipt() {
            showAlert('Receipt emailed successfully', 'success');
        }

        function printReportCard() {
            window.print();
        }

        function downloadReportCard() {
            showAlert('Report card downloaded as PDF', 'success');
        }

        function emailReportCard() {
            showAlert('Report card emailed successfully', 'success');
        }

        function printResultsSlip() {
            window.print();
        }

        function downloadResultsSlip() {
            showAlert('Results slip downloaded as PDF', 'success');
        }

        function exportData(type) {
            showAlert(`${type} data exported successfully!`, 'success');
        }

        function confirmDelete() {
            if (AppData.deleteCallback) {
                AppData.deleteCallback();
            }
        }

        function showNotifications() {
            loadNotifications();
            showAlert('Notifications checked', 'info');
        }

        // =====================================================
        // GLOBAL EVENT LISTENERS
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Kagema School Management System v10.0 initializing...');
            
            // Initialize sample data
            initializeSampleData();
            
            // Check if user is already logged in
            const token = localStorage.getItem('token');
            const sessionId = sessionStorage.getItem('sessionId');
            
            if (token && sessionId) {
                try {
                    const tokenData = JSON.parse(atob(token));
                    const user = AppData.users.find(u => u.username === tokenData.username);
                    if (user) {
                        const { password, ...userWithoutPassword } = user;
                        AppData.currentUser = userWithoutPassword;
                        
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainDashboard').classList.add('active');
                        
                        updateUserDisplay();
                        generateMenu();
                        loadAllLocalData();
                        loadDashboardData();
                        
                        showAlert(`Welcome back, ${user.name}!`, 'success');
                    } else {
                        localStorage.removeItem('token');
                        sessionStorage.removeItem('sessionId');
                    }
                } catch (e) {
                    console.error('Error parsing token:', e);
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('sessionId');
                }
            }

            // Global search handler
            document.getElementById('globalSearch')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const search = e.target.value.toLowerCase();
                    const student = AppData.students.find(s => 
                        s.name.toLowerCase().includes(search) || 
                        s.id.toLowerCase().includes(search) ||
                        s.upi.toLowerCase().includes(search)
                    );
                    
                    if (student) {
                        viewStudentProfile(student.id);
                    } else {
                        showAlert('Student not found', 'warning');
                    }
                }
            });

            // Close modals on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show'));
                }
            });

            // Close modal on outside click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });

            // Load saved theme
            const savedPrimary = localStorage.getItem('themePrimary');
            const savedAccent = localStorage.getItem('themeAccent');
            if (savedPrimary) document.documentElement.style.setProperty('--primary', savedPrimary);
            if (savedAccent) document.documentElement.style.setProperty('--accent', savedAccent);
        });

        // =====================================================
        // ADDITIONAL UTILITY FUNCTIONS
        // =====================================================
        function formatCurrency(amount) {
            return 'KES ' + amount.toLocaleString();
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-KE', options);
        }

        function formatTime(timeString) {
            return new Date('1970-01-01T' + timeString).toLocaleTimeString('en-KE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function calculateAge(dobString) {
            const dob = new Date(dobString);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            return age;
        }

        function generateStudentId() {
            const year = new Date().getFullYear();
            const lastId = AppData.students
                .filter(s => s.id.startsWith(year))
                .map(s => parseInt(s.id.split('/')[1]))
                .sort((a, b) => b - a)[0] || 0;
            
            return `${year}/${String(lastId + 1).padStart(3, '0')}`;
        }

        function generateReceiptNumber() {
            return 'RCP' + Date.now().toString().slice(-8) + Math.random().toString(36).substr(2, 4).toUpperCase();
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePhone(phone) {
            const re = /^(0|\+254)[17]\d{8}$/;
            return re.test(phone.replace(/\s/g, ''));
        }

        function validateUPI(upi) {
            const re = /^\d{10}$/;
            return re.test(upi);
        }

        // =====================================================
        // IMPORT/EXPORT FUNCTIONS
        // =====================================================
        function importData() {
            const dataType = document.getElementById('importDataType').value;
            const format = document.getElementById('importFormat').value;
            const file = document.getElementById('importFile').files[0];
            const skipDuplicates = document.getElementById('importSkipDuplicates').checked;
            const updateExisting = document.getElementById('importUpdateExisting').checked;

            if (!file) {
                showAlert('Please select a file to import', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let data;
                    if (format === 'json') {
                        data = JSON.parse(e.target.result);
                    } else {
                        // Simple CSV parsing (in production use a proper CSV parser)
                        const lines = e.target.result.split('\n');
                        const headers = lines[0].split(',');
                        data = lines.slice(1).map(line => {
                            const values = line.split(',');
                            return headers.reduce((obj, header, i) => {
                                obj[header.trim()] = values[i]?.trim();
                                return obj;
                            }, {});
                        });
                    }

                    // Import based on data type
                    let imported = 0;
                    let skipped = 0;
                    let updated = 0;

                    data.forEach(item => {
                        switch(dataType) {
                            case 'students':
                                const existingStudent = AppData.students.find(s => s.id === item.id);
                                if (existingStudent) {
                                    if (updateExisting) {
                                        Object.assign(existingStudent, item);
                                        updated++;
                                    } else {
                                        skipped++;
                                    }
                                } else {
                                    AppData.students.push(item);
                                    imported++;
                                }
                                break;
                            case 'staff':
                                const existingStaff = AppData.staff.find(s => s.id === item.id);
                                if (existingStaff) {
                                    if (updateExisting) {
                                        Object.assign(existingStaff, item);
                                        updated++;
                                    } else {
                                        skipped++;
                                    }
                                } else {
                                    AppData.staff.push(item);
                                    imported++;
                                }
                                break;
                            case 'fees':
                                const existingFee = AppData.fees.find(f => f.studentId === item.studentId);
                                if (existingFee) {
                                    if (updateExisting) {
                                        Object.assign(existingFee, item);
                                        updated++;
                                    } else {
                                        skipped++;
                                    }
                                } else {
                                    AppData.fees.push(item);
                                    imported++;
                                }
                                break;
                            case 'assessments':
                                AppData.assessments.push(item);
                                imported++;
                                break;
                        }
                    });

                    closeModal('importDataModal');
                    loadAllLocalData();
                    showAlert(`Import complete: ${imported} imported, ${updated} updated, ${skipped} skipped`, 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    showAlert('Error importing data: ' + error.message, 'danger');
                }
            };

            if (format === 'csv' || format === 'excel') {
                reader.readAsText(file);
            } else {
                reader.readAsText(file);
            }
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                showAlert('No data to export', 'warning');
                return;
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(h => JSON.stringify(row[h] || '')).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // =====================================================
        // ANALYTICS FUNCTIONS
        // =====================================================
        function showAnalytics() {
            const content = document.getElementById('analyticsContent');
            
            // Calculate analytics
            const totalStudents = AppData.students.length;
            const totalStaff = AppData.staff.length;
            const totalFees = AppData.fees.reduce((sum, f) => sum + (f.total || 0), 0);
            const totalPaid = AppData.fees.reduce((sum, f) => sum + (f.paid || 0), 0);
            const collectionRate = totalFees > 0 ? ((totalPaid / totalFees) * 100).toFixed(1) : 0;
            
            const gradeDistribution = {};
            AppData.students.forEach(s => {
                gradeDistribution[s.grade] = (gradeDistribution[s.grade] || 0) + 1;
            });

            const performanceData = {};
            AppData.assessments.forEach(a => {
                if (!performanceData[a.subject]) {
                    performanceData[a.subject] = { total: 0, count: 0, grades: {} };
                }
                performanceData[a.subject].total += a.score;
                performanceData[a.subject].count++;
                
                const grade = a.score >= 80 ? 'A' : a.score >= 65 ? 'B' : a.score >= 50 ? 'C' : 'D';
                performanceData[a.subject].grades[grade] = (performanceData[a.subject].grades[grade] || 0) + 1;
            });

            let html = `
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Collection Rate</div>
                        <div class="kpi-value">${collectionRate}%</div>
                    </div>
                    <div class="kpi-card info">
                        <div class="kpi-label">Average Performance</div>
                        <div class="kpi-value">${calculateAveragePerformance()}%</div>
                    </div>
                    <div class="kpi-card success">
                        <div class="kpi-label">Teacher-Student Ratio</div>
                        <div class="kpi-value">1:${Math.round(totalStudents / totalStaff) || 0}</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Grade Distribution</h3>
                    </div>
                    <div style="padding: 20px;">
                        ${Object.entries(gradeDistribution).map(([grade, count]) => `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${grade}</span>
                                    <span>${count} students</span>
                                </div>
                                <div class="progress-bar" style="margin-top: 5px;">
                                    <div class="progress-fill" style="width: ${(count / totalStudents * 100)}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Subject Performance</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Average Score</th>
                                    <th>Grade Distribution</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(performanceData).map(([subject, data]) => {
                                    const avg = data.count > 0 ? (data.total / data.count).toFixed(1) : 0;
                                    return `
                                        <tr>
                                            <td>${subject}</td>
                                            <td>${avg}%</td>
                                            <td>
                                                <span class="grade-excellent">A: ${data.grades.A || 0}</span>
                                                <span class="grade-good">B: ${data.grades.B || 0}</span>
                                                <span class="grade-fair">C: ${data.grades.C || 0}</span>
                                                <span class="grade-poor">D: ${data.grades.D || 0}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            openModal('analyticsModal');
        }

        function calculateAveragePerformance() {
            let total = 0;
            let count = 0;
            
            AppData.assessments.forEach(a => {
                total += a.score;
                count++;
            });
            
            return count > 0 ? (total / count).toFixed(1) : 0;
        }

        // =====================================================
        // TIMELINE FUNCTIONS
        // =====================================================
        function loadTimeline() {
            const timeline = document.getElementById('timelineContent');
            if (!timeline) return;

            const events = [
                ...AppData.announcements.map(a => ({
                    type: 'announcement',
                    title: a.title,
                    description: a.content,
                    date: a.date,
                    icon: 'fa-bullhorn',
                    color: 'var(--info)'
                })),
                ...AppData.events.map(e => ({
                    type: 'event',
                    title: e.title,
                    description: e.description,
                    date: e.date,
                    time: e.time,
                    icon: 'fa-calendar',
                    color: 'var(--success)'
                }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));

            timeline.innerHTML = events.map(event => `
                <div class="timeline-item">
                    <div class="timeline-icon" style="background: ${event.color}">
                        <i class="fas ${event.icon}"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <h4>${event.title}</h4>
                            <span class="timeline-date">${event.date} ${event.time || ''}</span>
                        </div>
                        <p>${event.description}</p>
                    </div>
                </div>
            `).join('');
        }

        // =====================================================
        // BIRTHDAY FUNCTIONS
        // =====================================================
        function loadBirthdays() {
            const birthdays = document.getElementById('birthdayList');
            if (!birthdays) return;

            const today = new Date();
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();

            const birthdayPeople = [
                ...AppData.students.map(s => ({
                    name: s.name,
                    dob: s.dob,
                    role: 'student',
                    type: 'Student'
                })),
                ...AppData.staff.map(s => ({
                    name: s.name,
                    dob: s.dob,
                    role: 'staff',
                    type: 'Staff'
                })),
                ...AppData.users.map(u => ({
                    name: u.name,
                    dob: u.dob,
                    role: u.role,
                    type: 'Staff'
                }))
            ].filter(p => {
                if (!p.dob) return false;
                const dob = new Date(p.dob);
                return dob.getMonth() + 1 === todayMonth && dob.getDate() === todayDay;
            });

            if (birthdayPeople.length > 0) {
                birthdays.innerHTML = birthdayPeople.map(p => `
                    <div class="birthday-item">
                        <i class="fas fa-birthday-cake" style="color: var(--accent);"></i>
                        <span><strong>${p.name}</strong> (${p.type})</span>
                    </div>
                `).join('');
            } else {
                birthdays.innerHTML = '<p>No birthdays today</p>';
            }
        }

        // =====================================================
        // NOTIFICATION FUNCTIONS
        // =====================================================
        function loadNotifications() {
            const notifications = [];
            
            // Fee reminders
            AppData.fees.forEach(fee => {
                const student = AppData.students.find(s => s.id === fee.studentId);
                if (student && fee.balance > 0) {
                    notifications.push({
                        type: 'fee',
                        message: `${student.name} has fee balance of ${formatCurrency(fee.balance)}`,
                        date: new Date().toLocaleDateString(),
                        priority: fee.balance > 10000 ? 'high' : 'normal'
                    });
                }
            });

            // Performance alerts
            AppData.assessments.forEach(assessment => {
                if (assessment.score < 50) {
                    const student = AppData.students.find(s => s.id === assessment.studentId);
                    if (student) {
                        notifications.push({
                            type: 'performance',
                            message: `${student.name} scored ${assessment.score}% in ${assessment.subject}`,
                            date: new Date().toLocaleDateString(),
                            priority: 'high'
                        });
                    }
                }
            });

            // Low inventory alerts
            AppData.inventory.forEach(item => {
                if (item.quantity < 10) {
                    notifications.push({
                        type: 'inventory',
                        message: `Low stock: ${item.name} (${item.quantity} remaining)`,
                        date: new Date().toLocaleDateString(),
                        priority: 'normal'
                    });
                }
            });

            // Update notification count
            document.getElementById('notificationCount').textContent = notifications.length;

            return notifications;
        }

        function showNotifications() {
            const notifications = loadNotifications();
            
            if (notifications.length === 0) {
                showAlert('No new notifications', 'info');
                return;
            }

            let message = 'Notifications:\n\n';
            notifications.forEach(n => {
                message += ` ${n.message}\n`;
            });
            
            showAlert(message, 'info');
        }

        // =====================================================
        // AUTO-SAVE FUNCTION
        // =====================================================
        let autoSaveTimer;
        function autoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                backupSystem();
                showAlert('Auto-saved successfully', 'success');
            }, 300000); // Auto-save every 5 minutes
        }

        // Start auto-save when logged in
        setInterval(autoSave, 300000);

        // =====================================================
        // ONLINE/OFFLINE DETECTION
        // =====================================================
        window.addEventListener('online', () => {
            showAlert('You are back online', 'success');
            // Attempt to sync data
            if (AppData.currentUser) {
                loadAllFromBackend();
            }
        });

        window.addEventListener('offline', () => {
            showAlert('You are offline - working in local mode', 'warning');
        });

        // =====================================================
        // KEYBOARD SHORTCUTS
        // =====================================================
        document.addEventListener('keydown', (e) => {
            // Ctrl + S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                autoSave();
            }
            
            // Ctrl + F to focus search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('globalSearch')?.focus();
            }
            
            // Ctrl + H to go to dashboard
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                showSection('dashboard');
            }
            
            // Ctrl + M for messages
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                showSection('communication');
            }
        });

        // =====================================================
        // CLEANUP ON PAGE UNLOAD
        // =====================================================
        window.addEventListener('beforeunload', () => {
            // Optional: warn user if there are unsaved changes
            // This is a simple implementation - you can make it more sophisticated
            if (AppData.currentUser) {
                // You could track unsaved changes here
            }
        });

        // =====================================================
        // FINAL INITIALIZATION
        // =====================================================
        // Load birthdays
        loadBirthdays();
        
        // Load timeline
        loadTimeline();
        
        // Set up periodic data refresh
        setInterval(() => {
            if (AppData.currentUser && navigator.onLine) {
                loadAllFromBackend();
            }
        }, 60000); // Refresh every minute

        console.log('Kagema School Management System v10.0 initialized successfully');
    </script>
</body>
</html>