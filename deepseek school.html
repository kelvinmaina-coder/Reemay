<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kagema Primary Junior Secondary School - Complete Management System">
    <meta name="keywords" content="school management, CBC, Kenya education, student records, fee management">
    <title>Kagema School Management System - Professional Edition v6.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2E7D32;
            --primary-dark: #1B5E20;
            --primary-light: #4CAF50;
            --secondary: #1565C0;
            --secondary-dark: #0D47A1;
            --accent: #FFB300;
            --background: #F5F5F5;
            --text: #212121;
            --text-light: #757575;
            --white: #FFFFFF;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --info: #2196F3;
            --border: #E0E0E0;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 20px;
        }

        .login-box {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .login-header h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 5px;
        }

        .login-header p {
            color: var(--text-light);
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .login-form input,
        .login-form select {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .login-form input:focus,
        .login-form select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .login-form button {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-form button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .demo-credentials {
            margin-top: 25px;
            padding: 15px;
            background: var(--background);
            border-radius: 8px;
            font-size: 13px;
        }

        .demo-credentials p {
            margin: 5px 0;
            color: var(--text-light);
        }

        .demo-credentials strong {
            color: var(--primary);
        }

        /* Main Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .user-profile-sidebar {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-role-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-menu {
            list-style: none;
            margin-bottom: 30px;
        }

        .nav-section {
            margin: 20px 0 10px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            padding-left: 15px;
        }

        .nav-item {
            margin: 5px 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-link i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.2);
            padding-left: 20px;
        }

        .nav-link.active {
            background: rgba(255,255,255,0.3);
            font-weight: 600;
            border-left: 3px solid var(--accent);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Top Header */
        .top-header {
            background: var(--white);
            padding: 15px 25px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 900;
        }

        .page-title {
            font-size: 22px;
            color: var(--primary);
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .global-search {
            display: flex;
            align-items: center;
            background: var(--background);
            border-radius: 8px;
            padding: 5px 15px;
            width: 300px;
        }

        .global-search i {
            color: var(--text-light);
            margin-right: 10px;
        }

        .global-search input {
            border: none;
            background: transparent;
            padding: 10px 5px;
            width: 100%;
            outline: none;
        }

        .user-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--background);
            padding: 8px 15px;
            border-radius: 8px;
        }

        .user-details {
            text-align: right;
        }

        .user-details .name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-details .role {
            font-size: 11px;
            color: var(--text-light);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        /* Content Area */
        .content-area {
            padding: 25px;
            flex: 1;
        }

        /* Alert Container */
        #alertContainer {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background: #c8e6c9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .alert-warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #e65100;
        }

        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }

        /* Section Content */
        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--background);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
        }

        .kpi-card.warning { border-left-color: var(--warning); }
        .kpi-card.danger { border-left-color: var(--danger); }
        .kpi-card.info { border-left-color: var(--info); }

        .kpi-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .kpi-trend {
            font-size: 12px;
            margin-top: 5px;
        }

        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--background);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tr:hover {
            background: var(--background);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 14px 28px;
            font-size: 16px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-bar input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
        }

        .search-bar select {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            min-width: 200px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .badge-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .badge-danger {
            background: #ffebee;
            color: #c62828;
        }

        .badge-info {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Role Badges */
        .role-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .role-admin { background: #fff3e0; color: #e65100; }
        .role-headteacher { background: #fce4ec; color: #c2185b; }
        .role-dht { background: #e8f5e9; color: #2e7d32; }
        .role-teacher { background: #e3f2fd; color: #1565c0; }
        .role-secretary { background: #f3e5f5; color: #8e24aa; }
        .role-bursar { background: #fff3e0; color: #e65100; }

        /* Grade Badges */
        .grade-excellent {
            background: #c8e6c9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .grade-good {
            background: #bbdefb;
            color: #1565c0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .grade-fair {
            background: #fff3e0;
            color: #e65100;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .grade-poor {
            background: #ffebee;
            color: #c62828;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--background);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--background);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        /* Score Entry Table */
        .score-entry-table input {
            width: 80px;
            padding: 8px;
            text-align: center;
            border: 2px solid var(--border);
            border-radius: 6px;
        }

        .score-entry-table input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* Report Card */
        .report-card {
            background: var(--white);
            padding: 40px;
            border: 2px solid var(--primary);
            border-radius: 12px;
            max-width: 900px;
            margin: 0 auto 30px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 20px;
        }

        .school-name {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .school-info {
            font-size: 12px;
            color: var(--text-light);
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--background);
            border-radius: 8px;
        }

        /* Receipt */
        .receipt {
            background: var(--white);
            padding: 30px;
            border: 2px dashed var(--success);
            border-radius: 12px;
            max-width: 500px;
            margin: 0 auto;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
        }

        /* Progress Bars */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--background);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid var(--background);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pagination */
        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .page-item {
            padding: 8px 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-item:hover {
            background: var(--primary);
            color: white;
        }

        .page-item.active {
            background: var(--primary);
            color: white;
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .top-header,
            .btn,
            .modal,
            .search-bar,
            .nav-menu,
            .logout-btn,
            .pagination {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
                padding: 0;
            }

            .report-card,
            .receipt {
                border: none;
                box-shadow: none;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .top-header {
                flex-direction: column;
                gap: 15px;
            }

            .global-search {
                width: 100%;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .student-info {
                grid-template-columns: 1fr;
            }

            .search-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo">üè´</div>
                <h1>KAGEMA SCHOOL</h1>
                <p>Complete Management System v6.0</p>
                <small style="color: var(--text-light);">KICD Compliant | CBC Ready | 2026</small>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit"><i class="fas fa-sign-in-alt"></i> Login to Dashboard</button>
            </form>

            <div class="demo-credentials">
                <p><strong>üîë System Credentials:</strong></p>
                <p>üëë <strong>Admin:</strong> admin / admin123</p>
                <p>üë®‚Äçüè´ <strong>Head Teacher:</strong> headteacher / head123</p>
                <p>üë©‚Äçüè´ <strong>Deputy Head:</strong> dht / dht123</p>
                <p>üìö <strong>Teacher:</strong> teacher / teacher123</p>
                <p>üìã <strong>Secretary:</strong> secretary / sec123</p>
                <p>üí∞ <strong>Bursar:</strong> bursar / bursar123</p>
                <p><em>Other users can be registered by Admin</em></p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üè´ KAGEMA</h2>
                <p>School System v6.0</p>
            </div>

            <div class="user-profile-sidebar">
                <div class="user-name" id="sidebarUserName">Loading...</div>
                <div class="user-role-badge" id="sidebarUserRole">Loading...</div>
                <div class="user-id" id="sidebarUserId" style="font-size: 11px; margin-top: 5px; opacity: 0.8;"></div>
            </div>

            <!-- Dynamic Menu -->
            <div id="dynamicMenu"></div>

            <!-- Logout Button -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                <button class="nav-link" onclick="logout()" style="width: 100%; text-align: left;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="page-title" id="pageTitle">Dashboard</div>
                <div class="header-actions">
                    <div class="global-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="Search students by name, admission, or UPI...">
                    </div>
                    <div class="user-info-header">
                        <div class="user-details">
                            <div class="name" id="headerUserName">Loading...</div>
                            <div class="role" id="headerUserRole">Loading...</div>
                            <div class="id" id="headerUserId" style="font-size: 10px; color: var(--text-light);"></div>
                        </div>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <div id="alertContainer"></div>

                <!-- Dashboard Section -->
                <section id="dashboard" class="section-content active">
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Students</div>
                            <div class="kpi-value" id="totalStudents">0</div>
                            <div class="kpi-trend" id="studentTrend"></div>
                        </div>
                        <div class="kpi-card info">
                            <div class="kpi-label">Active Staff</div>
                            <div class="kpi-value" id="totalStaff">0</div>
                            <div class="kpi-trend">Teachers & Admin</div>
                        </div>
                        <div class="kpi-card warning">
                            <div class="kpi-label">Fee Collection</div>
                            <div class="kpi-value" id="feeCollection">0%</div>
                            <div class="progress-bar" style="margin-top: 10px;">
                                <div class="progress-fill" id="feeProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="kpi-card danger">
                            <div class="kpi-label">Below Expectations</div>
                            <div class="kpi-value" id="belowExpectations">0</div>
                            <div class="kpi-trend">Need Intervention</div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Recent Students</h3>
                                <button class="btn btn-primary btn-sm" onclick="showSection('students')">
                                    <i class="fas fa-plus"></i> Add Student
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Adm No</th>
                                            <th>Name</th>
                                            <th>Grade</th>
                                            <th>Stream</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentStudents"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Fee Collection Status</h3>
                                <button class="btn btn-primary btn-sm" onclick="showSection('finance')">
                                    <i class="fas fa-eye"></i> View All
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feeStatus"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Performance Alerts</h3>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Subject</th>
                                            <th>Score</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="performanceAlerts"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Quick Actions</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button class="btn btn-primary" onclick="showSection('gradeEntry')">
                                    <i class="fas fa-pen"></i> Enter Marks
                                </button>
                                <button class="btn btn-success" onclick="showSection('finance')">
                                    <i class="fas fa-money-bill"></i> Record Payment
                                </button>
                                <button class="btn btn-info" onclick="showSection('reports')">
                                    <i class="fas fa-file-pdf"></i> Generate Reports
                                </button>
                                <button class="btn btn-warning" onclick="showSection('communication')">
                                    <i class="fas fa-comments"></i> Send Message
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- User Management Section -->
                <section id="userManagement" class="section-content">
                    <h2 style="margin-bottom: 20px;">üë• User Management</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Users</h3>
                            <button class="btn btn-primary" onclick="openModal('addUserModal')">
                                <i class="fas fa-plus"></i> Register New User
                            </button>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="userSearch" placeholder="Search by name, username, or role..." onkeyup="filterUsers()">
                            <select id="roleFilter" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Administrator</option>
                                <option value="headteacher">Head Teacher</option>
                                <option value="dht">Deputy Head Teacher</option>
                                <option value="teacher">Teacher</option>
                                <option value="secretary">Secretary</option>
                                <option value="bursar">Bursar</option>
                            </select>
                        </div>

                        <div class="table-responsive">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Professional ID</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Students Section -->
                <section id="students" class="section-content">
                    <h2 style="margin-bottom: 20px;">üë®‚Äçüéì Student Management</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Students</h3>
                            <div>
                                <button class="btn btn-success btn-sm" onclick="exportStudents()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openModal('addStudentModal')">
                                    <i class="fas fa-plus"></i> Register Student
                                </button>
                            </div>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="studentSearch" placeholder="Search by name, admission, or UPI..." onkeyup="filterStudents()">
                            <select id="gradeFilter" onchange="filterStudents()">
                                <option value="">All Grades</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </select>
                            <select id="streamFilter" onchange="filterStudents()">
                                <option value="">All Streams</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                                <option value="North">North</option>
                                <option value="South">South</option>
                            </select>
                        </div>

                        <div class="table-responsive">
                            <table id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Name</th>
                                        <th>Grade</th>
                                        <th>Stream</th>
                                        <th>UPI</th>
                                        <th>Parent Phone</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody"></tbody>
                            </table>
                        </div>

                        <div class="pagination" id="studentPagination"></div>
                    </div>
                </section>

                <!-- Grade Entry Section -->
                <section id="gradeEntry" class="section-content">
                    <h2 style="margin-bottom: 20px;">‚úçÔ∏è Enter Student Marks</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Select Assessment Details</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Grade</label>
                                <select id="gradeSelect" class="form-control" onchange="loadClassStreams()">
                                    <option value="">Select Grade</option>
                                    <option value="Grade 1">Grade 1</option>
                                    <option value="Grade 2">Grade 2</option>
                                    <option value="Grade 3">Grade 3</option>
                                    <option value="Grade 4">Grade 4</option>
                                    <option value="Grade 5">Grade 5</option>
                                    <option value="Grade 6">Grade 6</option>
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                    <option value="Grade 9">Grade 9</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stream</label>
                                <select id="streamSelect" class="form-control" onchange="loadSubjectStudents()">
                                    <option value="">Select Stream</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Subject</label>
                                <select id="subjectSelect" class="form-control" onchange="loadSubjectStudents()">
                                    <option value="">Select Subject</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="English">English</option>
                                    <option value="Kiswahili">Kiswahili</option>
                                    <option value="Science">Integrated Science</option>
                                    <option value="Social Studies">Social Studies</option>
                                    <option value="CRE">CRE</option>
                                    <option value="IRE">IRE</option>
                                    <option value="HRE">HRE</option>
                                    <option value="Agriculture">Agriculture</option>
                                    <option value="Computer">Computer Science</option>
                                    <option value="Business">Business Studies</option>
                                    <option value="Home Science">Home Science</option>
                                    <option value="French">French</option>
                                    <option value="German">German</option>
                                    <option value="PE">PE & Sports</option>
                                    <option value="Performing Arts">Performing Arts</option>
                                    <option value="Visual Arts">Visual Arts</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Assessment Type</label>
                                <select id="assessmentType" class="form-control">
                                    <option value="cat1">CAT 1</option>
                                    <option value="cat2">CAT 2</option>
                                    <option value="cat3">CAT 3</option>
                                    <option value="endterm">End Term Exam</option>
                                    <option value="project">Project</option>
                                    <option value="assignment">Assignment</option>
                                    <option value="practical">Practical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Term</label>
                                <select id="termSelect" class="form-control">
                                    <option value="Term 1, 2026">Term 1, 2026</option>
                                    <option value="Term 2, 2026">Term 2, 2026</option>
                                    <option value="Term 3, 2026">Term 3, 2026</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="loadSubjectStudents()" style="width: 100%;">
                            <i class="fas fa-sync"></i> Load Students
                        </button>
                    </div>

                    <div class="card" id="gradeEntryCard" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title" id="gradeEntryTitle">Enter Scores</h3>
                            <button class="btn btn-success" onclick="saveAllGrades()">
                                <i class="fas fa-save"></i> Save All
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="score-entry-table">
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Student Name</th>
                                        <th>Score (0-100)</th>
                                        <th>Grade</th>
                                        <th>Descriptor</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="gradeEntryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Finance Section -->
                <section id="finance" class="section-content">
                    <h2 style="margin-bottom: 20px;">üí∞ Finance Management</h2>
                    
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Expected Fees</div>
                            <div class="kpi-value" id="totalExpected">KES 0</div>
                        </div>
                        <div class="kpi-card info">
                            <div class="kpi-label">Collected</div>
                            <div class="kpi-value" id="totalCollected">KES 0</div>
                        </div>
                        <div class="kpi-card warning">
                            <div class="kpi-label">Outstanding</div>
                            <div class="kpi-value" id="totalOutstanding">KES 0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Collection Rate</div>
                            <div class="kpi-value" id="collectionRate">0%</div>
                            <div class="progress-bar" style="margin-top: 10px;">
                                <div class="progress-fill" id="collectionProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Fee Structure</h3>
                            <button class="btn btn-primary" onclick="openModal('feeStructureModal')">
                                <i class="fas fa-plus"></i> Add Fee Structure
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Grade</th>
                                        <th>Tuition</th>
                                        <th>Boarding</th>
                                        <th>Transport</th>
                                        <th>Uniform</th>
                                        <th>Activities</th>
                                        <th>Levies</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="feeStructureBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Fee Records</h3>
                            <button class="btn btn-primary" onclick="openModal('recordPaymentModal')">
                                <i class="fas fa-plus"></i> Record Payment
                            </button>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="feeSearch" placeholder="Search by student name or admission..." onkeyup="filterFeeRecords()">
                        </div>

                        <div class="table-responsive">
                            <table id="feeTable">
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Student Name</th>
                                        <th>Grade</th>
                                        <th>Total Fee</th>
                                        <th>Paid</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="feeTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports" class="section-content">
                    <h2 style="margin-bottom: 20px;">üìä Reports Generation</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Generate Report Card</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Select Student</label>
                                <select id="reportStudent" class="form-control">
                                    <option value="">-- Select Student --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Term</label>
                                <select id="reportTerm" class="form-control">
                                    <option value="Term 1, 2026">Term 1, 2026</option>
                                    <option value="Term 2, 2026">Term 2, 2026</option>
                                    <option value="Term 3, 2026">Term 3, 2026</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="generateStudentReportCard()">
                            <i class="fas fa-file-pdf"></i> Generate Report Card
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Generate Fee Statement</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Select Student</label>
                                <select id="statementStudent" class="form-control">
                                    <option value="">-- Select Student --</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="generateFeeStatement()">
                            <i class="fas fa-file-invoice"></i> Generate Fee Statement
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Class Performance Summary</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Grade</label>
                                <select id="summaryGrade" class="form-control">
                                    <option value="">Select Grade</option>
                                    <option value="Grade 1">Grade 1</option>
                                    <option value="Grade 2">Grade 2</option>
                                    <option value="Grade 3">Grade 3</option>
                                    <option value="Grade 4">Grade 4</option>
                                    <option value="Grade 5">Grade 5</option>
                                    <option value="Grade 6">Grade 6</option>
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                    <option value="Grade 9">Grade 9</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Stream</label>
                                <select id="summaryStream" class="form-control">
                                    <option value="">Select Stream</option>
                                    <option value="East">East</option>
                                    <option value="West">West</option>
                                    <option value="North">North</option>
                                    <option value="South">South</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Term</label>
                                <select id="summaryTerm" class="form-control">
                                    <option value="Term 1, 2026">Term 1, 2026</option>
                                    <option value="Term 2, 2026">Term 2, 2026</option>
                                    <option value="Term 3, 2026">Term 3, 2026</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="generateClassSummary()">
                            <i class="fas fa-chart-bar"></i> Generate Summary
                        </button>
                    </div>

                    <div id="reportContainer" style="margin-top: 20px;"></div>
                </section>

                <!-- Communication Section -->
                <section id="communication" class="section-content">
                    <h2 style="margin-bottom: 20px;">üì± Communication Center</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Send Message to Parents</h3>
                        </div>

                        <div class="form-group">
                            <label>Select Students</label>
                            <select id="messageStudents" multiple class="form-control" style="height: 200px;">
                                <!-- Populated by JS -->
                            </select>
                            <small>Hold Ctrl/Cmd to select multiple. Parent phone numbers shown.</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Message Type</label>
                                <select id="messageType" class="form-control" onchange="updateMessageTemplate()">
                                    <option value="sms">SMS</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="email">Email</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Template</label>
                                <select id="messageTemplate" class="form-control" onchange="loadMessageTemplate()">
                                    <option value="fee">Fee Reminder</option>
                                    <option value="exam">Exam Notice</option>
                                    <option value="meeting">Parent Meeting</option>
                                    <option value="performance">Performance Alert</option>
                                    <option value="graduation">Graduation</option>
                                    <option value="report">Report Card Ready</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Message</label>
                            <textarea id="messageContent" class="form-control" rows="6"></textarea>
                        </div>

                        <div class="form-group">
                            <label><input type="checkbox" id="includeBothParents"> Include both parents where available</label>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="sendMessage()" style="width: 100%;">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Message History</h3>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Recipients</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="messageHistory"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Staff Management Section -->
                <section id="staffManagement" class="section-content">
                    <h2 style="margin-bottom: 20px;">üë®‚Äçüè´ Staff Management</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Staff Members</h3>
                            <button class="btn btn-primary" onclick="openModal('addStaffModal')">
                                <i class="fas fa-plus"></i> Add Staff
                            </button>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="staffSearch" placeholder="Search by name, TSC, or role..." onkeyup="filterStaff()">
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>TSC No</th>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Department</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="staffTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Alumni Section -->
                <section id="alumni" class="section-content">
                    <h2 style="margin-bottom: 20px;">üéì Alumni & Transferred Students</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Former Students</h3>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="alumniSearch" placeholder="Search by name or admission..." onkeyup="filterAlumni()">
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Adm No</th>
                                        <th>Name</th>
                                        <th>Last Grade</th>
                                        <th>Stream</th>
                                        <th>Year Left</th>
                                        <th>Reason</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="alumniTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Inventory Section -->
                <section id="inventory" class="section-content">
                    <h2 style="margin-bottom: 20px;">üì¶ Inventory Management</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">School Inventory</h3>
                            <button class="btn btn-primary" onclick="openModal('addInventoryModal')">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="inventorySearch" placeholder="Search items..." onkeyup="filterInventory()">
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Unit</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Transport Section -->
                <section id="transport" class="section-content">
                    <h2 style="margin-bottom: 20px;">üöå Transport Management</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Routes & Vehicles</h3>
                            <button class="btn btn-primary" onclick="openModal('addRouteModal')">
                                <i class="fas fa-plus"></i> Add Route
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Route</th>
                                        <th>Vehicle</th>
                                        <th>Driver</th>
                                        <th>Students</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transportTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Hostel Section -->
                <section id="hostel" class="section-content">
                    <h2 style="margin-bottom: 20px;">üè† Hostel Management</h2>
                    
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Total Capacity</div>
                            <div class="kpi-value">240</div>
                        </div>
                        <div class="kpi-card info">
                            <div class="kpi-label">Occupied</div>
                            <div class="kpi-value">180</div>
                        </div>
                        <div class="kpi-card success">
                            <div class="kpi-label">Available</div>
                            <div class="kpi-value">60</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Room Allocations</h3>
                            <button class="btn btn-primary" onclick="openModal('allocateRoomModal')">
                                <i class="fas fa-plus"></i> Allocate Room
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Hostel</th>
                                        <th>Room</th>
                                        <th>Bed</th>
                                        <th>Student</th>
                                        <th>Adm No</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hostelTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Library Section -->
                <section id="library" class="section-content">
                    <h2 style="margin-bottom: 20px;">üìö Library Management</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Books & Resources</h3>
                            <button class="btn btn-primary" onclick="openModal('addBookModal')">
                                <i class="fas fa-plus"></i> Add Book
                            </button>
                        </div>

                        <div class="search-bar">
                            <input type="text" id="bookSearch" placeholder="Search by title, author, or ISBN...">
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ISBN</th>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Category</th>
                                        <th>Total Copies</th>
                                        <th>Available</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="libraryTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings" class="section-content">
                    <h2 style="margin-bottom: 20px;">‚öôÔ∏è System Settings</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">School Information</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>School Name</label>
                                <input type="text" id="schoolName" class="form-control" value="Kagema Primary Junior Secondary">
                            </div>
                            <div class="form-group">
                                <label>NEMIS Code</label>
                                <input type="text" id="nemisCode" class="form-control" value="14720001" readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="schoolPhone" class="form-control" value="0722 123456">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="schoolEmail" class="form-control" value="info@kagema.ac.ke">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Address</label>
                                <input type="text" id="schoolAddress" class="form-control" value="P.O. Box 1234 - 00100 Nairobi">
                            </div>
                            <div class="form-group">
                                <label>County</label>
                                <input type="text" id="schoolCounty" class="form-control" value="Nairobi">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Current Academic Year</label>
                                <select id="academicYear" class="form-control">
                                    <option value="2026" selected>2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Current Term</label>
                                <select id="currentTerm" class="form-control">
                                    <option value="Term 1" selected>Term 1</option>
                                    <option value="Term 2">Term 2</option>
                                    <option value="Term 3">Term 3</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Backup</h3>
                        </div>

                        <div class="form-group">
                            <p><strong>Last backup:</strong> 10/04/2026 11:30 PM</p>
                            <p><strong>Database size:</strong> 245 MB</p>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="backupSystem()">
                                    <i class="fas fa-database"></i> Create Backup
                                </button>
                                <button class="btn btn-info" onclick="restoreBackup()">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Register New User</h3>
                <button class="close-btn" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form onsubmit="saveUser(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="userUsername" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" id="userPassword" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="userRole" required>
                            <option value="">-- Select Role --</option>
                            <option value="admin">Administrator</option>
                            <option value="headteacher">Head Teacher</option>
                            <option value="dht">Deputy Head Teacher</option>
                            <option value="teacher">Teacher</option>
                            <option value="secretary">Secretary</option>
                            <option value="bursar">Bursar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Professional ID *</label>
                        <input type="text" id="userProfId" placeholder="TSC/Bursar/Admin ID" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="userPhone" placeholder="07XX XXX XXX">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="userDept" placeholder="e.g., Mathematics, Admin">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Register User
                </button>
            </form>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Register New Student</h3>
                <button class="close-btn" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <form onsubmit="saveStudent(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" id="studentDob" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Admission Number *</label>
                        <input type="text" id="admissionNo" placeholder="e.g., 2026/001" required>
                    </div>
                    <div class="form-group">
                        <label>UPI Number *</label>
                        <input type="text" id="upiNumber" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Grade *</label>
                        <select id="studentGrade" required>
                            <option value="">-- Select Grade --</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stream *</label>
                        <select id="studentStream" required>
                            <option value="">-- Select Stream --</option>
                            <option value="East">East</option>
                            <option value="West">West</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birth Certificate No</label>
                        <input type="text" id="birthCert">
                    </div>
                    <div class="form-group">
                        <label>Birth Place</label>
                        <input type="text" id="birthPlace">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>County</label>
                        <input type="text" id="county" placeholder="e.g., Nairobi, Kisumu">
                    </div>
                    <div class="form-group">
                        <label>Sub-County</label>
                        <input type="text" id="subCounty">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Religion</label>
                        <select id="religion">
                            <option value="Christian (CRE)">Christian (CRE)</option>
                            <option value="Muslim (IRE)">Muslim (IRE)</option>
                            <option value="Hindu (HRE)">Hindu (HRE)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Blood Group</label>
                        <select id="bloodGroup">
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                </div>
                <h4 style="margin: 20px 0 10px;">Parent/Guardian Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Father's Name</label>
                        <input type="text" id="fatherName">
                    </div>
                    <div class="form-group">
                        <label>Father's Phone</label>
                        <input type="tel" id="fatherPhone" placeholder="07XX XXX XXX">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Mother's Name</label>
                        <input type="text" id="motherName">
                    </div>
                    <div class="form-group">
                        <label>Mother's Phone</label>
                        <input type="tel" id="motherPhone" placeholder="07XX XXX XXX">
                    </div>
                </div>
                <div class="form-group">
                    <label>Emergency Contact</label>
                    <input type="tel" id="emergencyPhone" placeholder="07XX XXX XXX">
                </div>
                <div class="form-group">
                    <label>Medical Notes / Allergies</label>
                    <textarea id="medicalNotes" rows="3" placeholder="e.g., Asthma, Penicillin allergy, Special needs..."></textarea>
                </div>
                <div class="form-group">
                    <label>Previous School</label>
                    <input type="text" id="prevSchool">
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Register Student
                </button>
            </form>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div id="addStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Staff Member</h3>
                <button class="close-btn" onclick="closeModal('addStaffModal')">&times;</button>
            </div>
            <form onsubmit="saveStaff(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="staffName" required>
                    </div>
                    <div class="form-group">
                        <label>TSC Number *</label>
                        <input type="text" id="staffTsc" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="staffRole" required>
                            <option value="">-- Select Role --</option>
                            <option value="teacher">Teacher</option>
                            <option value="headteacher">Head Teacher</option>
                            <option value="dht">Deputy Head Teacher</option>
                            <option value="secretary">Secretary</option>
                            <option value="bursar">Bursar</option>
                            <option value="librarian">Librarian</option>
                            <option value="driver">Driver</option>
                            <option value="matron">Matron/Patron</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="staffDept" placeholder="e.g., Mathematics, Admin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="staffPhone" placeholder="07XX XXX XXX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="staffEmail">
                    </div>
                </div>
                <div class="form-group">
                    <label>Qualification</label>
                    <input type="text" id="staffQualification" placeholder="e.g., B.Ed, Diploma">
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Add Staff
                </button>
            </form>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="recordPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Record Payment</h3>
                <button class="close-btn" onclick="closeModal('recordPaymentModal')">&times;</button>
            </div>
            <form onsubmit="recordPayment(event)">
                <div class="form-group">
                    <label>Student *</label>
                    <select id="paymentStudent" class="form-control" required>
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount (KES) *</label>
                    <input type="number" id="paymentAmount" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label>Payment Method *</label>
                    <select id="paymentMethod" class="form-control" onchange="togglePaymentFields()" required>
                        <option value="cash">Cash</option>
                        <option value="bank_deposit">Bank Deposit</option>
                        <option value="cheque">Cheque</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="mpesa">M-Pesa</option>
                    </select>
                </div>
                <div id="paymentMethodFields"></div>
                <div class="form-group">
                    <label>Payment Date *</label>
                    <input type="date" id="paymentDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Received By</label>
                    <input type="text" id="receivedBy" class="form-control" value="Current User" readonly>
                </div>
                <button type="submit" class="btn btn-success btn-lg" style="width: 100%;">
                    <i class="fas fa-check"></i> Record Payment & Print Receipt
                </button>
            </form>
        </div>
    </div>

    <!-- Fee Structure Modal -->
    <div id="feeStructureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Fee Structure</h3>
                <button class="close-btn" onclick="closeModal('feeStructureModal')">&times;</button>
            </div>
            <form onsubmit="saveFeeStructure(event)">
                <div class="form-group">
                    <label>Grade *</label>
                    <select id="feeGrade" class="form-control" required>
                        <option value="">-- Select Grade --</option>
                        <option value="Grade 1">Grade 1</option>
                        <option value="Grade 2">Grade 2</option>
                        <option value="Grade 3">Grade 3</option>
                        <option value="Grade 4">Grade 4</option>
                        <option value="Grade 5">Grade 5</option>
                        <option value="Grade 6">Grade 6</option>
                        <option value="Grade 7">Grade 7</option>
                        <option value="Grade 8">Grade 8</option>
                        <option value="Grade 9">Grade 9</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tuition (KES)</label>
                        <input type="number" id="feeTuition" class="form-control" min="0" value="25000">
                    </div>
                    <div class="form-group">
                        <label>Boarding (KES)</label>
                        <input type="number" id="feeBoarding" class="form-control" min="0" value="18000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transport (KES)</label>
                        <input type="number" id="feeTransport" class="form-control" min="0" value="5000">
                    </div>
                    <div class="form-group">
                        <label>Uniform (KES)</label>
                        <input type="number" id="feeUniform" class="form-control" min="0" value="3500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Activities (KES)</label>
                        <input type="number" id="feeActivities" class="form-control" min="0" value="2000">
                    </div>
                    <div class="form-group">
                        <label>Levies (KES)</label>
                        <input type="number" id="feeLevies" class="form-control" min="0" value="1500">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Save Fee Structure
                </button>
            </form>
        </div>
    </div>

    <!-- Add Inventory Modal -->
    <div id="addInventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Inventory Item</h3>
                <button class="close-btn" onclick="closeModal('addInventoryModal')">&times;</button>
            </div>
            <form onsubmit="saveInventory(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Item Code *</label>
                        <input type="text" id="itemCode" required>
                    </div>
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" id="itemName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="itemCategory">
                            <option value="Furniture">Furniture</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Books">Books</option>
                            <option value="Sports">Sports</option>
                            <option value="Stationery">Stationery</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="itemQuantity" min="0" value="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Unit</label>
                        <input type="text" id="itemUnit" value="pcs">
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="itemLocation" placeholder="e.g., Store Room, Library">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Add Item
                </button>
            </form>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="addRouteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Transport Route</h3>
                <button class="close-btn" onclick="closeModal('addRouteModal')">&times;</button>
            </div>
            <form onsubmit="saveRoute(event)">
                <div class="form-group">
                    <label>Route Name *</label>
                    <input type="text" id="routeName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle Registration</label>
                        <input type="text" id="vehicleReg">
                    </div>
                    <div class="form-group">
                        <label>Driver Name</label>
                        <input type="text" id="driverName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Driver Phone</label>
                        <input type="tel" id="driverPhone">
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="vehicleCapacity" value="40">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Add Route
                </button>
            </form>
        </div>
    </div>

    <!-- Allocate Room Modal -->
    <div id="allocateRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Allocate Hostel Room</h3>
                <button class="close-btn" onclick="closeModal('allocateRoomModal')">&times;</button>
            </div>
            <form onsubmit="allocateRoom(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Hostel *</label>
                        <select id="hostelName" required>
                            <option value="">-- Select Hostel --</option>
                            <option value="Boys Hostel A">Boys Hostel A</option>
                            <option value="Boys Hostel B">Boys Hostel B</option>
                            <option value="Girls Hostel A">Girls Hostel A</option>
                            <option value="Girls Hostel B">Girls Hostel B</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Room Number *</label>
                        <input type="text" id="roomNumber" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bed Number</label>
                        <input type="text" id="bedNumber">
                    </div>
                    <div class="form-group">
                        <label>Student</label>
                        <select id="roomStudent" class="form-control">
                            <option value="">-- Select Student --</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Allocate Room
                </button>
            </form>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div id="addBookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Book</h3>
                <button class="close-btn" onclick="closeModal('addBookModal')">&times;</button>
            </div>
            <form onsubmit="saveBook(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>ISBN</label>
                        <input type="text" id="bookIsbn">
                    </div>
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" id="bookAuthor">
                    </div>
                    <div class="form-group">
                        <label>Publisher</label>
                        <input type="text" id="bookPublisher">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="bookCategory">
                            <option value="Textbook">Textbook</option>
                            <option value="Story Book">Story Book</option>
                            <option value="Reference">Reference</option>
                            <option value="Novel">Novel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Copies</label>
                        <input type="number" id="bookCopies" value="1" min="1">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                    <i class="fas fa-save"></i> Add Book
                </button>
            </form>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Payment Receipt</h3>
                <button class="close-btn" onclick="closeModal('receiptModal')">&times;</button>
            </div>
            <div id="receiptContent" class="receipt"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="printReceipt()" style="flex: 1;">
                    <i class="fas fa-print"></i> Print Receipt
                </button>
                <button class="btn btn-success" onclick="downloadReceipt()" style="flex: 1;">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>

    <!-- Report Card Modal -->
    <div id="reportCardModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Student Report Card</h3>
                <button class="close-btn" onclick="closeModal('reportCardModal')">&times;</button>
            </div>
            <div id="reportCardContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="printReportCard()" style="flex: 1;">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-success" onclick="downloadReportCard()" style="flex: 1;">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Delete</h3>
                <button class="close-btn" onclick="closeModal('deleteConfirmModal')">&times;</button>
            </div>
            <p style="margin: 20px 0;">Are you sure you want to delete this record? This action cannot be undone.</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">Yes, Delete</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA LAYER ====================
        const AppData = {
            currentUser: null,
            deleteCallback: null,

            users: [
                { username: 'admin', password: 'admin123', name: 'System Administrator', role: 'admin', professionalId: 'ADMIN001', email: 'admin@kagema.ac.ke', phone: '0722000001', department: 'Administration', status: 'active' },
                { username: 'headteacher', password: 'head123', name: 'Mr. Omondi', role: 'headteacher', professionalId: 'TSC001234', email: 'omondi@kagema.ac.ke', phone: '0722000002', department: 'Administration', status: 'active' },
                { username: 'dht', password: 'dht123', name: 'Ms. Achieng', role: 'dht', professionalId: 'TSC001235', email: 'achieng@kagema.ac.ke', phone: '0722000003', department: 'Academics', status: 'active' },
                { username: 'teacher', password: 'teacher123', name: 'Mrs. Atieno', role: 'teacher', professionalId: 'TSC001236', email: 'atieno@kagema.ac.ke', phone: '0722000004', department: 'Grade 7', status: 'active' },
                { username: 'secretary', password: 'sec123', name: 'Ms. Wambui', role: 'secretary', professionalId: 'SEC001', email: 'wambui@kagema.ac.ke', phone: '0722000005', department: 'Administration', status: 'active' },
                { username: 'bursar', password: 'bursar123', name: 'Mr. Otieno', role: 'bursar', professionalId: 'BUR001', email: 'otieno@kagema.ac.ke', phone: '0722000006', department: 'Finance', status: 'active' }
            ],

            students: [],

            staff: [
                { id: 1, tsc: 'TSC001236', name: 'Mrs. Atieno', role: 'teacher', department: 'Grade 7', phone: '0722123456', email: 'atieno@kagema.ac.ke', qualification: 'B.Ed English', status: 'active' },
                { id: 2, tsc: 'TSC001237', name: 'Mr. Kipchoge', role: 'teacher', department: 'Mathematics', phone: '0722123457', email: 'kipchoge@kagema.ac.ke', qualification: 'B.Ed Math', status: 'active' },
                { id: 3, tsc: 'TSC001238', name: 'Ms. Akinyi', role: 'teacher', department: 'Science', phone: '0722123458', email: 'akinyi@kagema.ac.ke', qualification: 'B.Sc Education', status: 'active' }
            ],

            feeStructures: [
                { grade: 'Grade 7', tuition: 25000, boarding: 18000, transport: 5000, uniform: 3500, activities: 2000, levies: 1500, total: 55000 },
                { grade: 'Grade 8', tuition: 25000, boarding: 18000, transport: 5000, uniform: 3500, activities: 2000, levies: 1500, total: 55000 },
                { grade: 'Grade 6', tuition: 20000, boarding: 15000, transport: 4000, uniform: 3000, activities: 1500, levies: 1000, total: 44500 }
            ],

            fees: [],

            assessments: [],

            messages: [],

            alumni: [],

            inventory: [
                { code: 'FUR001', name: 'Student Desk', category: 'Furniture', quantity: 450, unit: 'pcs', location: 'Classrooms', status: 'Good' },
                { code: 'ELE001', name: 'Laptop', category: 'Electronics', quantity: 45, unit: 'pcs', location: 'Computer Lab', status: 'Good' },
                { code: 'BOK001', name: 'Mathematics Textbook Gr7', category: 'Books', quantity: 120, unit: 'pcs', location: 'Library', status: 'Good' }
            ],

            transport: [
                { route: 'Kisumu Town', vehicle: 'KCA 123A', driver: 'Mr. Otieno', students: 35, status: 'Active' },
                { route: 'Nyando', vehicle: 'KCA 124B', driver: 'Mr. Odhiambo', students: 28, status: 'Active' }
            ],

            hostel: [
                { hostel: 'Boys Hostel A', room: '101', bed: 'B1', student: 'Kamau James', admNo: '2023/002', status: 'Occupied' },
                { hostel: 'Girls Hostel B', room: '201', bed: 'B5', student: 'Akinyi Otieno', admNo: '2023/001', status: 'Occupied' }
            ],

            library: [
                { isbn: '978-9966-123-45-6', title: 'Mathematics Grade 7', author: 'KICD', category: 'Textbook', totalCopies: 50, available: 45 },
                { isbn: '978-9966-123-45-7', title: 'English Grade 7', author: 'KICD', category: 'Textbook', totalCopies: 48, available: 42 }
            ]
        };

        // ==================== AUTHENTICATION ====================
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = AppData.users.find(u => u.username === username && u.password === password);

            if (user) {
                AppData.currentUser = { ...user };
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainDashboard').classList.add('active');
                
                updateUserDisplay();
                generateMenu();
                loadDashboardData();
                loadAllData();
                showAlert(`Welcome back, ${user.name}! You are logged in as ${getRoleDisplay(user.role)}.`, 'success');
            } else {
                showAlert('Invalid username or password', 'danger');
            }
        }

        function logout() {
            AppData.currentUser = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainDashboard').classList.remove('active');
            showAlert('You have been logged out successfully', 'info');
        }

        function updateUserDisplay() {
            const user = AppData.currentUser;
            document.getElementById('sidebarUserName').textContent = user.name;
            document.getElementById('sidebarUserRole').textContent = getRoleDisplay(user.role);
            document.getElementById('sidebarUserId').textContent = user.professionalId;
            document.getElementById('headerUserName').textContent = user.name;
            document.getElementById('headerUserRole').textContent = getRoleDisplay(user.role);
            document.getElementById('headerUserId').textContent = user.professionalId;
        }

        function getRoleDisplay(role) {
            const roles = {
                'admin': 'Administrator',
                'headteacher': 'Head Teacher',
                'dht': 'Deputy Head Teacher',
                'teacher': 'Teacher',
                'secretary': 'Secretary',
                'bursar': 'Bursar'
            };
            return roles[role] || role;
        }

        function generateMenu() {
            const role = AppData.currentUser.role;
            const menu = document.getElementById('dynamicMenu');
            let html = '';

            if (role === 'admin') {
                html = `
                    <div class="nav-section">Administration</div>
                    <div class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('userManagement')"><i class="fas fa-users-cog"></i> User Management</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('staffManagement')"><i class="fas fa-chalkboard-teacher"></i> Staff</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('alumni')"><i class="fas fa-graduation-cap"></i> Alumni</a></div>
                    
                    <div class="nav-section">Academics</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('gradeEntry')"><i class="fas fa-pen"></i> Enter Marks</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                    
                    <div class="nav-section">Finance</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('finance')"><i class="fas fa-coins"></i> Finance</a></div>
                    
                    <div class="nav-section">Support Services</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('inventory')"><i class="fas fa-box"></i> Inventory</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('transport')"><i class="fas fa-bus"></i> Transport</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('hostel')"><i class="fas fa-bed"></i> Hostel</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('library')"><i class="fas fa-book"></i> Library</a></div>
                    
                    <div class="nav-section">Communication</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments"></i> Communication</a></div>
                    
                    <div class="nav-section">Settings</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</a></div>
                `;
            } else if (role === 'headteacher' || role === 'dht') {
                html = `
                    <div class="nav-section">Dashboard</div>
                    <div class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
                    
                    <div class="nav-section">Students</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('alumni')"><i class="fas fa-graduation-cap"></i> Alumni</a></div>
                    
                    <div class="nav-section">Academics</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('gradeEntry')"><i class="fas fa-pen"></i> Enter Marks</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                    
                    <div class="nav-section">Finance</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('finance')"><i class="fas fa-coins"></i> Finance</a></div>
                    
                    <div class="nav-section">Communication</div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments"></i> Communication</a></div>
                `;
            } else if (role === 'teacher') {
                html = `
                    <div class="nav-section">Teaching</div>
                    <div class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('gradeEntry')"><i class="fas fa-pen"></i> Enter Marks</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments"></i> Communication</a></div>
                `;
            } else if (role === 'secretary') {
                html = `
                    <div class="nav-section">Administration</div>
                    <div class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('students')"><i class="fas fa-users"></i> Students</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('alumni')"><i class="fas fa-graduation-cap"></i> Alumni</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('communication')"><i class="fas fa-envelope"></i> Communication</a></div>
                `;
            } else if (role === 'bursar') {
                html = `
                    <div class="nav-section">Finance</div>
                    <div class="nav-item"><a class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('finance')"><i class="fas fa-coins"></i> Finance</a></div>
                    <div class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-pdf"></i> Reports</a></div>
                `;
            }

            menu.innerHTML = html;
        }

        // ==================== SECTION NAVIGATION ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            const titles = {
                'dashboard': 'Dashboard',
                'userManagement': 'User Management',
                'students': 'Student Management',
                'gradeEntry': 'Enter Marks',
                'finance': 'Finance Management',
                'reports': 'Reports Generation',
                'communication': 'Communication Center',
                'staffManagement': 'Staff Management',
                'alumni': 'Alumni Records',
                'inventory': 'Inventory Management',
                'transport': 'Transport Management',
                'hostel': 'Hostel Management',
                'library': 'Library Management',
                'settings': 'System Settings'
            };
            
            document.getElementById('pageTitle').textContent = titles[sectionId] || sectionId;
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (event) event.target.classList.add('active');

            // Load section data
            switch(sectionId) {
                case 'userManagement': loadUsers(); break;
                case 'students': loadStudents(); break;
                case 'staffManagement': loadStaff(); break;
                case 'finance': loadFinance(); break;
                case 'communication': loadCommunication(); break;
                case 'alumni': loadAlumni(); break;
                case 'inventory': loadInventory(); break;
                case 'transport': loadTransport(); break;
                case 'hostel': loadHostel(); break;
                case 'library': loadLibrary(); break;
                case 'reports': loadReportsDropdown(); break;
            }
        }

        // ==================== DASHBOARD ====================
        function loadDashboardData() {
            document.getElementById('totalStudents').textContent = AppData.students.length;
            document.getElementById('totalStaff').textContent = AppData.staff.length;
            
            const totalFee = AppData.fees.reduce((sum, f) => sum + f.total, 0);
            const totalPaid = AppData.fees.reduce((sum, f) => sum + f.paid, 0);
            const collectionRate = totalFee > 0 ? Math.round((totalPaid / totalFee) * 100) : 0;
            
            document.getElementById('feeCollection').textContent = collectionRate + '%';
            document.getElementById('feeProgress').style.width = collectionRate + '%';
            
            const belowExpectations = AppData.assessments.filter(a => a.score < 50).length;
            document.getElementById('belowExpectations').textContent = belowExpectations;
            document.getElementById('studentTrend').textContent = AppData.students.length > 0 ? `‚Üë ${Math.round(AppData.students.length / 10)}% from last term` : 'No data';

            // Recent Students
            const recent = AppData.students.slice(-5).reverse();
            document.getElementById('recentStudents').innerHTML = recent.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.stream}</td>
                    <td><button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s.id}')"><i class="fas fa-eye"></i></button></td>
                </tr>
            `).join('');

            // Fee Status
            const feeStatus = AppData.fees.slice(0, 3);
            document.getElementById('feeStatus').innerHTML = feeStatus.map(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                if (!student) return '';
                const statusClass = f.balance === 0 ? 'badge-success' : f.balance < 10000 ? 'badge-warning' : 'badge-danger';
                const statusText = f.balance === 0 ? 'Paid' : f.balance < 10000 ? 'Partial' : 'Overdue';
                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>KES ${f.balance.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td><button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${f.studentId}')"><i class="fas fa-money-bill"></i></button></td>
                    </tr>
                `;
            }).join('');

            // Performance Alerts
            const alerts = AppData.assessments.filter(a => a.score < 50).slice(0, 3);
            document.getElementById('performanceAlerts').innerHTML = alerts.map(a => {
                const student = AppData.students.find(s => s.id === a.studentId);
                if (!student) return '';
                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>${a.subject}</td>
                        <td>${a.score}%</td>
                        <td><button class="btn btn-sm btn-warning" onclick="notifyParent('${a.studentId}')"><i class="fas fa-bell"></i></button></td>
                    </tr>
                `;
            }).join('');
        }

        function loadAllData() {
            loadUsers();
            loadStudents();
            loadStaff();
            loadFinance();
            loadCommunication();
            loadAlumni();
            loadInventory();
            loadTransport();
            loadHostel();
            loadLibrary();
            loadReportsDropdown();
        }

        // ==================== USER MANAGEMENT ====================
        function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = AppData.users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.name}</td>
                    <td><span class="role-badge role-${u.role}">${getRoleDisplay(u.role)}</span></td>
                    <td>${u.professionalId}</td>
                    <td>${u.email}</td>
                    <td><span class="badge badge-success">${u.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editUser('${u.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            
            const filtered = AppData.users.filter(u => 
                (u.name.toLowerCase().includes(search) || u.username.toLowerCase().includes(search)) &&
                (!role || u.role === role)
            );

            document.getElementById('usersTableBody').innerHTML = filtered.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.name}</td>
                    <td><span class="role-badge role-${u.role}">${getRoleDisplay(u.role)}</span></td>
                    <td>${u.professionalId}</td>
                    <td>${u.email}</td>
                    <td><span class="badge badge-success">${u.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editUser('${u.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveUser(event) {
            event.preventDefault();
            
            const newUser = {
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value,
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                professionalId: document.getElementById('userProfId').value,
                phone: document.getElementById('userPhone').value,
                department: document.getElementById('userDept').value,
                status: 'active'
            };

            AppData.users.push(newUser);
            closeModal('addUserModal');
            loadUsers();
            showAlert(`User ${newUser.name} registered successfully! They can now login with the provided credentials.`, 'success');
            event.target.reset();
        }

        function editUser(username) {
            showAlert(`Edit user: ${username} - Feature coming soon`, 'info');
        }

        function deleteUser(username) {
            if (username === AppData.currentUser.username) {
                showAlert('You cannot delete your own account', 'warning');
                return;
            }
            
            AppData.deleteCallback = () => {
                AppData.users = AppData.users.filter(u => u.username !== username);
                loadUsers();
                showAlert('User deleted successfully', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== STUDENT MANAGEMENT ====================
        function loadStudents() {
            // Sort students by grade and stream
            const sorted = [...AppData.students].sort((a, b) => {
                if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                return a.stream.localeCompare(b.stream);
            });

            document.getElementById('studentsTableBody').innerHTML = sorted.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.stream}</td>
                    <td>${s.upi}</td>
                    <td>${s.fatherPhone || s.motherPhone || s.emergencyPhone || 'N/A'}</td>
                    <td><span class="badge badge-success">Active</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${s.id}')"><i class="fas fa-money-bill"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');

            // Populate dropdowns
            const reportStudent = document.getElementById('reportStudent');
            const statementStudent = document.getElementById('statementStudent');
            const messageStudents = document.getElementById('messageStudents');
            const roomStudent = document.getElementById('roomStudent');
            
            const options = sorted.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            if (reportStudent) reportStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
            if (statementStudent) statementStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
            if (messageStudents) messageStudents.innerHTML = sorted.map(s => 
                `<option value="${s.id}">${s.name} - ${s.grade} ${s.stream} (F:${s.fatherPhone || 'N/A'}, M:${s.motherPhone || 'N/A'})</option>`
            ).join('');
            if (roomStudent) roomStudent.innerHTML = '<option value="">-- Select Student --</option>' + options;
        }

        function filterStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const grade = document.getElementById('gradeFilter').value;
            const stream = document.getElementById('streamFilter').value;
            
            const filtered = AppData.students.filter(s => 
                (s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search) || s.upi.toLowerCase().includes(search)) &&
                (!grade || s.grade === grade) &&
                (!stream || s.stream === stream)
            );

            document.getElementById('studentsTableBody').innerHTML = filtered.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.stream}</td>
                    <td>${s.upi}</td>
                    <td>${s.fatherPhone || s.motherPhone || s.emergencyPhone || 'N/A'}</td>
                    <td><span class="badge badge-success">Active</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewStudentProfile('${s.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-warning" onclick="editStudent('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${s.id}')"><i class="fas fa-money-bill"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveStudent(event) {
            event.preventDefault();
            
            const newStudent = {
                id: document.getElementById('admissionNo').value,
                name: document.getElementById('studentName').value,
                dob: document.getElementById('studentDob').value,
                upi: document.getElementById('upiNumber').value,
                grade: document.getElementById('studentGrade').value,
                stream: document.getElementById('studentStream').value,
                birthCert: document.getElementById('birthCert').value,
                birthPlace: document.getElementById('birthPlace').value,
                county: document.getElementById('county').value,
                subCounty: document.getElementById('subCounty').value,
                religion: document.getElementById('religion').value,
                bloodGroup: document.getElementById('bloodGroup').value,
                fatherName: document.getElementById('fatherName').value,
                fatherPhone: document.getElementById('fatherPhone').value,
                motherName: document.getElementById('motherName').value,
                motherPhone: document.getElementById('motherPhone').value,
                emergencyPhone: document.getElementById('emergencyPhone').value,
                medicalNotes: document.getElementById('medicalNotes').value,
                prevSchool: document.getElementById('prevSchool').value,
                admissionDate: new Date().toISOString().split('T')[0],
                status: 'active'
            };

            AppData.students.push(newStudent);

            // Auto-create fee record based on grade
            const feeStructure = AppData.feeStructures.find(f => f.grade === newStudent.grade) || 
                                { tuition: 25000, boarding: 18000, transport: 5000, uniform: 3500, activities: 2000, levies: 1500, total: 55000 };
            
            AppData.fees.push({
                studentId: newStudent.id,
                total: feeStructure.total,
                paid: 0,
                balance: feeStructure.total
            });

            closeModal('addStudentModal');
            loadStudents();
            loadDashboardData();
            loadFinance();
            showAlert(`Student ${newStudent.name} registered successfully!`, 'success');
            event.target.reset();
        }

        function editStudent(studentId) {
            showAlert(`Edit student: ${studentId} - Feature coming soon`, 'info');
        }

        function deleteStudent(studentId) {
            AppData.deleteCallback = () => {
                const index = AppData.students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    const student = AppData.students[index];
                    
                    // Move to alumni
                    AppData.alumni.push({
                        ...student,
                        yearLeft: new Date().getFullYear(),
                        reason: 'Transferred/Deleted'
                    });
                    
                    AppData.students.splice(index, 1);
                    
                    // Remove associated fees and assessments
                    AppData.fees = AppData.fees.filter(f => f.studentId !== studentId);
                    AppData.assessments = AppData.assessments.filter(a => a.studentId !== studentId);
                    
                    loadStudents();
                    loadAlumni();
                    loadFinance();
                    loadDashboardData();
                    showAlert('Student moved to alumni records', 'success');
                }
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        function viewStudentProfile(studentId) {
            const student = AppData.students.find(s => s.id === studentId);
            if (!student) return;

            const fee = AppData.fees.find(f => f.studentId === studentId);
            const assessments = AppData.assessments.filter(a => a.studentId === studentId);

            const content = document.getElementById('reportCardContent');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>${student.name}</h3>
                    <p>Admission: ${student.id} | Grade: ${student.grade} ${student.stream}</p>
                </div>
                
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchProfileTab(event, 'personal')">Personal</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'parents')">Parents</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'medical')">Medical</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'academic')">Academic</button>
                    <button class="tab-btn" onclick="switchProfileTab(event, 'fees')">Fees</button>
                </div>

                <div id="personal" class="tab-pane active">
                    <p><strong>Name:</strong> ${student.name}</p>
                    <p><strong>Admission:</strong> ${student.id}</p>
                    <p><strong>UPI:</strong> ${student.upi}</p>
                    <p><strong>Grade:</strong> ${student.grade} ${student.stream}</p>
                    <p><strong>DOB:</strong> ${student.dob}</p>
                    <p><strong>Birth Cert:</strong> ${student.birthCert || 'N/A'}</p>
                    <p><strong>Birth Place:</strong> ${student.birthPlace || 'N/A'}</p>
                    <p><strong>County:</strong> ${student.county || 'N/A'}</p>
                    <p><strong>Religion:</strong> ${student.religion || 'N/A'}</p>
                </div>

                <div id="parents" class="tab-pane">
                    <p><strong>Father:</strong> ${student.fatherName || 'N/A'} (${student.fatherPhone || 'N/A'})</p>
                    <p><strong>Mother:</strong> ${student.motherName || 'N/A'} (${student.motherPhone || 'N/A'})</p>
                    <p><strong>Emergency:</strong> ${student.emergencyPhone || 'N/A'}</p>
                </div>

                <div id="medical" class="tab-pane">
                    <p><strong>Blood Group:</strong> ${student.bloodGroup || 'N/A'}</p>
                    <p><strong>Medical Notes:</strong> ${student.medicalNotes || 'None'}</p>
                </div>

                <div id="academic" class="tab-pane">
                    <p><strong>Admission Date:</strong> ${student.admissionDate}</p>
                    <p><strong>Previous School:</strong> ${student.prevSchool || 'N/A'}</p>
                </div>

                <div id="fees" class="tab-pane">
                    ${fee ? `
                        <p><strong>Total Fee:</strong> KES ${fee.total.toLocaleString()}</p>
                        <p><strong>Paid:</strong> KES ${fee.paid.toLocaleString()}</p>
                        <p><strong>Balance:</strong> KES ${fee.balance.toLocaleString()}</p>
                    ` : '<p>No fee records</p>'}
                </div>
            `;

            openModal('reportCardModal');
        }

        function switchProfileTab(event, tabId) {
            document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // ==================== GRADE ENTRY ====================
        function loadClassStreams() {
            const grade = document.getElementById('gradeSelect').value;
            const streamSelect = document.getElementById('streamSelect');
            
            if (grade) {
                const streams = ['East', 'West', 'North', 'South'];
                streamSelect.innerHTML = '<option value="">Select Stream</option>' + 
                    streams.map(s => `<option value="${s}">${s}</option>`).join('');
            }
        }

        function loadSubjectStudents() {
            const grade = document.getElementById('gradeSelect').value;
            const stream = document.getElementById('streamSelect').value;
            const subject = document.getElementById('subjectSelect').value;
            const type = document.getElementById('assessmentType').value;
            const term = document.getElementById('termSelect').value;

            if (!grade || !stream || !subject) {
                showAlert('Please select grade, stream, and subject', 'warning');
                return;
            }

            const students = AppData.students.filter(s => s.grade === grade && s.stream === stream);
            
            if (students.length === 0) {
                showAlert('No students found in this class', 'warning');
                return;
            }

            document.getElementById('gradeEntryTitle').textContent = `${subject} - ${grade} ${stream} (${type.toUpperCase()})`;
            document.getElementById('gradeEntryCard').style.display = 'block';

            const tbody = document.getElementById('gradeEntryBody');
            tbody.innerHTML = students.map(student => {
                const existing = AppData.assessments.find(a => 
                    a.studentId === student.id && 
                    a.subject === subject && 
                    a.type === type && 
                    a.term === term
                );
                const score = existing?.score || '';
                const gradeInfo = calculateGrade(score);
                
                return `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td><input type="number" min="0" max="100" class="score-input" data-student="${student.id}" value="${score}" onchange="updateGradeDisplay(this)"></td>
                        <td class="grade-cell">${gradeInfo.grade}</td>
                        <td class="descriptor-cell">${gradeInfo.descriptor}</td>
                        <td><button class="btn btn-success btn-sm" onclick="saveGrade('${student.id}')"><i class="fas fa-save"></i></button></td>
                    </tr>
                `;
            }).join('');
        }

        function calculateGrade(score) {
            if (!score || score === '') return { grade: '-', descriptor: '-' };
            const num = parseFloat(score);
            if (isNaN(num)) return { grade: '-', descriptor: '-' };
            
            if (num >= 80) return { grade: '4', descriptor: 'Exceeds Expectations' };
            if (num >= 65) return { grade: '3', descriptor: 'Meets Expectations' };
            if (num >= 50) return { grade: '2', descriptor: 'Approaching Expectations' };
            return { grade: '1', descriptor: 'Below Expectations' };
        }

        function updateGradeDisplay(input) {
            const row = input.closest('tr');
            const score = input.value;
            const grade = calculateGrade(score);
            row.querySelector('.grade-cell').innerHTML = grade.grade;
            row.querySelector('.descriptor-cell').textContent = grade.descriptor;
        }

        function saveGrade(studentId) {
            const row = document.querySelector(`input[data-student="${studentId}"]`).closest('tr');
            const score = row.querySelector('input').value;
            const subject = document.getElementById('subjectSelect').value;
            const type = document.getElementById('assessmentType').value;
            const term = document.getElementById('termSelect').value;

            if (!score) {
                showAlert('Please enter a score', 'warning');
                return;
            }

            const existingIndex = AppData.assessments.findIndex(a => 
                a.studentId === studentId && 
                a.subject === subject && 
                a.type === type && 
                a.term === term
            );

            if (existingIndex >= 0) {
                AppData.assessments[existingIndex].score = parseFloat(score);
            } else {
                AppData.assessments.push({ studentId, subject, type, term, score: parseFloat(score) });
            }

            showAlert('Score saved', 'success');
        }

        function saveAllGrades() {
            const inputs = document.querySelectorAll('.score-input');
            inputs.forEach(input => {
                if (input.value) {
                    const studentId = input.dataset.student;
                    saveGrade(studentId);
                }
            });
            showAlert('All scores saved successfully!', 'success');
        }

        // ==================== FINANCE ====================
        function loadFinance() {
            // Update KPI
            const totalExpected = AppData.fees.reduce((sum, f) => sum + f.total, 0);
            const totalPaid = AppData.fees.reduce((sum, f) => sum + f.paid, 0);
            const totalOutstanding = totalExpected - totalPaid;
            const collectionRate = totalExpected > 0 ? Math.round((totalPaid / totalExpected) * 100) : 0;

            document.getElementById('totalExpected').textContent = `KES ${totalExpected.toLocaleString()}`;
            document.getElementById('totalCollected').textContent = `KES ${totalPaid.toLocaleString()}`;
            document.getElementById('totalOutstanding').textContent = `KES ${totalOutstanding.toLocaleString()}`;
            document.getElementById('collectionRate').textContent = collectionRate + '%';
            document.getElementById('collectionProgress').style.width = collectionRate + '%';

            // Fee Structure
            document.getElementById('feeStructureBody').innerHTML = AppData.feeStructures.map(f => `
                <tr>
                    <td>${f.grade}</td>
                    <td>KES ${f.tuition.toLocaleString()}</td>
                    <td>KES ${f.boarding.toLocaleString()}</td>
                    <td>KES ${f.transport.toLocaleString()}</td>
                    <td>KES ${f.uniform.toLocaleString()}</td>
                    <td>KES ${f.activities.toLocaleString()}</td>
                    <td>KES ${f.levies.toLocaleString()}</td>
                    <td>KES ${f.total.toLocaleString()}</td>
                    <td><button class="btn btn-sm btn-warning" onclick="editFeeStructure('${f.grade}')"><i class="fas fa-edit"></i></button></td>
                </tr>
            `).join('');

            // Fee Records
            document.getElementById('feeTableBody').innerHTML = AppData.fees.map(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                if (!student) return '';
                const statusClass = f.balance === 0 ? 'badge-success' : f.balance < 10000 ? 'badge-warning' : 'badge-danger';
                const statusText = f.balance === 0 ? 'Paid' : f.balance < 10000 ? 'Partial' : 'Overdue';
                return `
                    <tr>
                        <td>${f.studentId}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>KES ${f.total.toLocaleString()}</td>
                        <td>KES ${f.paid.toLocaleString()}</td>
                        <td>KES ${f.balance.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${f.studentId}')"><i class="fas fa-money-bill"></i></button>
                            <button class="btn btn-sm btn-info" onclick="generateFeeStatement('${f.studentId}')"><i class="fas fa-file-invoice"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Payment dropdown
            const paymentSelect = document.getElementById('paymentStudent');
            if (paymentSelect) {
                paymentSelect.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            }
        }

        function filterFeeRecords() {
            const search = document.getElementById('feeSearch').value.toLowerCase();
            const filtered = AppData.fees.filter(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                return student?.name.toLowerCase().includes(search) || f.studentId.toLowerCase().includes(search);
            });

            document.getElementById('feeTableBody').innerHTML = filtered.map(f => {
                const student = AppData.students.find(s => s.id === f.studentId);
                if (!student) return '';
                const statusClass = f.balance === 0 ? 'badge-success' : f.balance < 10000 ? 'badge-warning' : 'badge-danger';
                const statusText = f.balance === 0 ? 'Paid' : f.balance < 10000 ? 'Partial' : 'Overdue';
                return `
                    <tr>
                        <td>${f.studentId}</td>
                        <td>${student.name}</td>
                        <td>${student.grade}</td>
                        <td>KES ${f.total.toLocaleString()}</td>
                        <td>KES ${f.paid.toLocaleString()}</td>
                        <td>KES ${f.balance.toLocaleString()}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="recordPaymentForStudent('${f.studentId}')"><i class="fas fa-money-bill"></i></button>
                            <button class="btn btn-sm btn-info" onclick="generateFeeStatement('${f.studentId}')"><i class="fas fa-file-invoice"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function recordPaymentForStudent(studentId) {
            const select = document.getElementById('paymentStudent');
            if (select) select.value = studentId;
            openModal('recordPaymentModal');
        }

        function togglePaymentFields() {
            const method = document.getElementById('paymentMethod').value;
            const fields = document.getElementById('paymentMethodFields');
            
            const html = {
                cash: `
                    <div class="form-group"><label>Receipt Number</label><input type="text" id="receiptNumber" class="form-control" placeholder="e.g., RCP-001"></div>
                    <div class="form-group"><label>Teller Name</label><input type="text" id="tellerName" class="form-control"></div>
                `,
                bank_deposit: `
                    <div class="form-group"><label>Bank Name</label><input type="text" id="bankName" class="form-control" placeholder="e.g., Equity"></div>
                    <div class="form-group"><label>Branch</label><input type="text" id="branch" class="form-control"></div>
                    <div class="form-group"><label>Deposit Slip No</label><input type="text" id="depositSlip" class="form-control"></div>
                `,
                cheque: `
                    <div class="form-group"><label>Cheque Number</label><input type="text" id="chequeNumber" class="form-control"></div>
                    <div class="form-group"><label>Bank</label><input type="text" id="chequeBank" class="form-control"></div>
                    <div class="form-group"><label>Drawer Name</label><input type="text" id="drawerName" class="form-control"></div>
                `,
                bank_transfer: `
                    <div class="form-group"><label>Reference Number</label><input type="text" id="referenceNumber" class="form-control"></div>
                    <div class="form-group"><label>Sender Name</label><input type="text" id="senderName" class="form-control"></div>
                    <div class="form-group"><label>Bank</label><input type="text" id="transferBank" class="form-control"></div>
                `,
                mpesa: `
                    <div class="form-group"><label>M-Pesa Transaction Code</label><input type="text" id="mpesaCode" class="form-control" placeholder="e.g., OK123ABC"></div>
                    <div class="form-group"><label>Phone Number</label><input type="text" id="mpesaPhone" class="form-control" placeholder="07XX XXX XXX"></div>
                `
            };

            fields.innerHTML = html[method] || '';
        }

        function recordPayment(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('paymentStudent').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            
            if (!studentId || !amount) {
                showAlert('Please select student and enter amount', 'warning');
                return;
            }

            const fee = AppData.fees.find(f => f.studentId === studentId);
            if (fee) {
                fee.paid += amount;
                fee.balance = fee.total - fee.paid;
            }

            // Generate receipt
            const student = AppData.students.find(s => s.id === studentId);
            const receiptNo = 'RCP' + Date.now().toString().slice(-8);
            
            const receiptContent = document.getElementById('receiptContent');
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <h3>KAGEMA PRIMARY SCHOOL</h3>
                    <p>P.O. Box 1234 - 00100 Nairobi</p>
                    <p>Tel: 0722 123456 | Email: info@kagema.ac.ke</p>
                </div>
                <div style="margin: 20px 0;">
                    <h4>OFFICIAL RECEIPT</h4>
                    <p><strong>Receipt No:</strong> ${receiptNo}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Student:</strong> ${student.name} (${studentId})</p>
                    <p><strong>Class:</strong> ${student.grade} ${student.stream}</p>
                    <p><strong>Amount:</strong> KES ${amount.toLocaleString()}</p>
                    <p><strong>Payment Method:</strong> ${method.replace('_', ' ').toUpperCase()}</p>
                    <p><strong>Balance:</strong> KES ${fee.balance.toLocaleString()}</p>
                </div>
                <div style="border-top: 1px solid #ddd; padding-top: 10px;">
                    <p><strong>Received By:</strong> ${AppData.currentUser.name}</p>
                    <p style="margin-top: 30px;">_________________________</p>
                    <p>Authorized Signature</p>
                </div>
            `;

            closeModal('recordPaymentModal');
            openModal('receiptModal');
            loadFinance();
            loadDashboardData();
            showAlert(`Payment of KES ${amount.toLocaleString()} recorded successfully!`, 'success');
        }

        function saveFeeStructure(event) {
            event.preventDefault();
            
            const grade = document.getElementById('feeGrade').value;
            const tuition = parseFloat(document.getElementById('feeTuition').value) || 0;
            const boarding = parseFloat(document.getElementById('feeBoarding').value) || 0;
            const transport = parseFloat(document.getElementById('feeTransport').value) || 0;
            const uniform = parseFloat(document.getElementById('feeUniform').value) || 0;
            const activities = parseFloat(document.getElementById('feeActivities').value) || 0;
            const levies = parseFloat(document.getElementById('feeLevies').value) || 0;
            const total = tuition + boarding + transport + uniform + activities + levies;

            const existing = AppData.feeStructures.findIndex(f => f.grade === grade);
            if (existing >= 0) {
                AppData.feeStructures[existing] = { grade, tuition, boarding, transport, uniform, activities, levies, total };
            } else {
                AppData.feeStructures.push({ grade, tuition, boarding, transport, uniform, activities, levies, total });
            }

            closeModal('feeStructureModal');
            loadFinance();
            showAlert('Fee structure saved successfully', 'success');
        }

        function editFeeStructure(grade) {
            showAlert(`Edit fee structure for ${grade} - Feature coming soon`, 'info');
        }

        // ==================== REPORTS ====================
        function loadReportsDropdown() {
            const reportStudent = document.getElementById('reportStudent');
            const statementStudent = document.getElementById('statementStudent');
            
            if (reportStudent) {
                reportStudent.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            }
            
            if (statementStudent) {
                statementStudent.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id}) - ${s.grade} ${s.stream}</option>`).join('');
            }
        }

        function generateStudentReportCard() {
            const studentId = document.getElementById('reportStudent').value;
            const term = document.getElementById('reportTerm').value;
            
            if (!studentId) {
                showAlert('Please select a student', 'warning');
                return;
            }

            const student = AppData.students.find(s => s.id === studentId);
            if (!student) return;

            const subjects = ['Mathematics', 'English', 'Kiswahili', 'Science', 'Social Studies', 'CRE', 'Agriculture', 'Computer'];
            const results = subjects.map(subject => {
                const score = AppData.assessments.find(a => a.studentId === studentId && a.subject === subject && a.term === term)?.score || '-';
                let grade = '-', descriptor = '-', gradeClass = '';
                if (score !== '-') {
                    if (score >= 80) { grade = '4'; descriptor = 'Exceeds'; gradeClass = 'grade-excellent'; }
                    else if (score >= 65) { grade = '3'; descriptor = 'Meets'; gradeClass = 'grade-good'; }
                    else if (score >= 50) { grade = '2'; descriptor = 'Approaching'; gradeClass = 'grade-fair'; }
                    else { grade = '1'; descriptor = 'Below'; gradeClass = 'grade-poor'; }
                }
                return `<tr><td>${subject}</td><td>${score}%</td><td><span class="${gradeClass}">${grade}</span></td><td>${descriptor}</td></tr>`;
            }).join('');

            const reportContent = document.getElementById('reportCardContent');
            reportContent.innerHTML = `
                <div class="report-card">
                    <div class="report-header">
                        <div class="school-name">KAGEMA PRIMARY JUNIOR SECONDARY</div>
                        <div class="school-info">NEMIS: 14720001 | P.O. Box 1234 - 00100 Nairobi</div>
                        <h3>LEARNER'S PROGRESS REPORT</h3>
                        <p>${term}</p>
                    </div>
                    
                    <div class="student-info">
                        <div><strong>NAME:</strong> ${student.name}</div>
                        <div><strong>ADM NO:</strong> ${student.id}</div>
                        <div><strong>CLASS:</strong> ${student.grade} ${student.stream}</div>
                        <div><strong>UPI:</strong> ${student.upi}</div>
                    </div>

                    <table style="width: 100%; margin: 20px 0;">
                        <thead><tr><th>LEARNING AREA</th><th>SCORE</th><th>GRADE</th><th>DESCRIPTOR</th></tr></thead>
                        <tbody>${results}</tbody>
                    </table>

                    <div style="margin-top: 20px;">
                        <p><strong>TEACHER'S COMMENTS:</strong> Good progress this term. Keep working hard.</p>
                        <p><strong>PRINCIPAL'S REMARKS:</strong> Well done. Continue with the same spirit.</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <p>NEXT TERM BEGINS: 08/05/2026</p>
                        <p>REPORT GENERATED: ${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            `;

            openModal('reportCardModal');
        }

        function generateFeeStatement() {
            const studentId = document.getElementById('statementStudent').value;
            if (!studentId) {
                showAlert('Please select a student', 'warning');
                return;
            }

            const student = AppData.students.find(s => s.id === studentId);
            const fee = AppData.fees.find(f => f.studentId === studentId);
            
            if (!student || !fee) return;

            const receiptContent = document.getElementById('receiptContent');
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <h3>KAGEMA PRIMARY SCHOOL</h3>
                    <p>FEE STATEMENT</p>
                </div>
                <div style="margin: 20px 0;">
                    <p><strong>Student:</strong> ${student.name}</p>
                    <p><strong>Admission No:</strong> ${student.id}</p>
                    <p><strong>Class:</strong> ${student.grade} ${student.stream}</p>
                    <p><strong>UPI:</strong> ${student.upi}</p>
                    
                    <table style="width: 100%; margin: 20px 0;">
                        <tr><td><strong>Total Fee Charged:</strong></td><td>KES ${fee.total.toLocaleString()}</td></tr>
                        <tr><td><strong>Total Paid:</strong></td><td>KES ${fee.paid.toLocaleString()}</td></tr>
                        <tr><td><strong>Balance:</strong></td><td>KES ${fee.balance.toLocaleString()}</td></tr>
                    </table>
                    
                    <p><strong>As at:</strong> ${new Date().toLocaleDateString()}</p>
                </div>
            `;

            openModal('receiptModal');
        }

        function generateClassSummary() {
            const grade = document.getElementById('summaryGrade').value;
            const stream = document.getElementById('summaryStream').value;
            const term = document.getElementById('summaryTerm').value;

            if (!grade || !stream) {
                showAlert('Please select grade and stream', 'warning');
                return;
            }

            const students = AppData.students.filter(s => s.grade === grade && s.stream === stream);
            if (students.length === 0) {
                showAlert('No students found in this class', 'warning');
                return;
            }

            showAlert(`Class summary generated for ${grade} ${stream}`, 'success');
        }

        // ==================== COMMUNICATION ====================
        function loadCommunication() {
            const history = document.getElementById('messageHistory');
            history.innerHTML = AppData.messages.map(m => `
                <tr>
                    <td>${m.date}</td>
                    <td>${m.type}</td>
                    <td>${m.recipients} parents</td>
                    <td>${m.message.substring(0, 50)}...</td>
                    <td><span class="badge badge-success">${m.status}</span></td>
                </tr>
            `).join('');
        }

        function updateMessageTemplate() {
            const type = document.getElementById('messageType').value;
            const template = document.getElementById('messageTemplate');
            const options = {
                sms: ['Fee Reminder', 'Exam Notice', 'Meeting', 'Performance Alert', 'Graduation', 'Report Card'],
                whatsapp: ['Fee Reminder', 'Exam Notice', 'Meeting', 'Report Card', 'Graduation', 'Performance Alert'],
                email: ['Fee Statement', 'Report Card', 'Newsletter', 'Meeting', 'Graduation']
            };
            template.innerHTML = options[type].map(opt => `<option value="${opt.toLowerCase().replace(' ', '')}">${opt}</option>`).join('');
            loadMessageTemplate();
        }

        function loadMessageTemplate() {
            const template = document.getElementById('messageTemplate').value;
            const content = document.getElementById('messageContent');
            
            const templates = {
                feereminder: 'Dear Parent, this is a reminder that school fees balance of KES [amount] is due. Please clear at your earliest convenience.\n\nPayment Methods: Cash, Bank Deposit, Cheque, Bank Transfer, M-Pesa\n\nThank you.\n- Kagema School',
                examnotice: 'EXAM NOTICE: End term examinations will begin on [date]. Please ensure your child is well prepared and attends all papers.\n\nExamination Timetable is available at the school notice board.\n\n- Kagema School',
                meeting: 'PARENT-TEACHER MEETING\n\nDear Parent,\n\nThere will be a parent-teacher conference on:\nüìÖ Date: [date]\n‚è∞ Time: [time]\nüìç Venue: School Hall\n\nYour attendance is important to discuss your child\'s progress.\n\n- Kagema School',
                performancealert: 'PERFORMANCE ALERT\n\nDear Parent,\n\nWe have noticed that your child needs improvement in [subject]. Current grade: [grade].\n\nPlease arrange a meeting with the subject teacher to discuss support strategies.\n\n- Kagema School',
                graduation: 'GRADUATION CEREMONY\n\nDear Parent,\n\nCongratulations! Your child has successfully completed [grade]. The graduation ceremony will be held on [date] at [time] in the school compound.\n\nWe look forward to celebrating with you.\n\n- Kagema School',
                reportcard: 'REPORT CARD READY\n\nDear Parent,\n\nYour child\'s report card for Term [term] is ready. You can:\n1. Collect from the school\n2. Download from the parent portal\n3. Receive via WhatsApp\n\nPlease contact the school for more information.\n\n- Kagema School'
            };
            
            content.value = templates[template] || 'Type your message here...';
        }

        function sendMessage() {
            const students = document.getElementById('messageStudents').selectedOptions;
            const type = document.getElementById('messageType').value;
            const message = document.getElementById('messageContent').value;
            
            if (students.length === 0) {
                showAlert('Please select at least one student', 'warning');
                return;
            }
            
            if (!message) {
                showAlert('Please enter a message', 'warning');
                return;
            }
            
            AppData.messages.push({
                date: new Date().toLocaleDateString(),
                type: type.toUpperCase(),
                recipients: students.length,
                message: message.substring(0, 50) + '...',
                status: 'Sent'
            });
            
            showAlert(`Message sent to ${students.length} parent(s) via ${type.toUpperCase()}!`, 'success');
            loadCommunication();
        }

        // ==================== STAFF MANAGEMENT ====================
        function loadStaff() {
            document.getElementById('staffTableBody').innerHTML = AppData.staff.map(s => `
                <tr>
                    <td>${s.tsc}</td>
                    <td>${s.name}</td>
                    <td><span class="role-badge role-${s.role === 'teacher' ? 'teacher' : 'staff'}">${getRoleDisplay(s.role)}</span></td>
                    <td>${s.department}</td>
                    <td>${s.phone}</td>
                    <td>${s.email}</td>
                    <td><span class="badge badge-success">${s.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editStaff('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStaff('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterStaff() {
            const search = document.getElementById('staffSearch').value.toLowerCase();
            const filtered = AppData.staff.filter(s => 
                s.name.toLowerCase().includes(search) || 
                s.tsc.toLowerCase().includes(search) ||
                s.role.toLowerCase().includes(search)
            );

            document.getElementById('staffTableBody').innerHTML = filtered.map(s => `
                <tr>
                    <td>${s.tsc}</td>
                    <td>${s.name}</td>
                    <td><span class="role-badge role-${s.role === 'teacher' ? 'teacher' : 'staff'}">${getRoleDisplay(s.role)}</span></td>
                    <td>${s.department}</td>
                    <td>${s.phone}</td>
                    <td>${s.email}</td>
                    <td><span class="badge badge-success">${s.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editStaff('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStaff('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveStaff(event) {
            event.preventDefault();
            
            const newStaff = {
                id: AppData.staff.length + 1,
                tsc: document.getElementById('staffTsc').value,
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                department: document.getElementById('staffDept').value,
                phone: document.getElementById('staffPhone').value,
                email: document.getElementById('staffEmail').value,
                qualification: document.getElementById('staffQualification').value,
                status: 'active'
            };

            AppData.staff.push(newStaff);
            closeModal('addStaffModal');
            loadStaff();
            showAlert(`Staff member ${newStaff.name} added successfully!`, 'success');
            event.target.reset();
        }

        function editStaff(staffId) {
            showAlert(`Edit staff: ${staffId} - Feature coming soon`, 'info');
        }

        function deleteStaff(staffId) {
            AppData.deleteCallback = () => {
                AppData.staff = AppData.staff.filter(s => s.id != staffId);
                loadStaff();
                showAlert('Staff record deleted', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== ALUMNI ====================
        function loadAlumni() {
            document.getElementById('alumniTableBody').innerHTML = AppData.alumni.map(a => `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.name}</td>
                    <td>${a.grade}</td>
                    <td>${a.stream}</td>
                    <td>${a.yearLeft}</td>
                    <td>${a.reason}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewAlumni('${a.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAlumni('${a.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterAlumni() {
            const search = document.getElementById('alumniSearch').value.toLowerCase();
            const filtered = AppData.alumni.filter(a => 
                a.name.toLowerCase().includes(search) || a.id.toLowerCase().includes(search)
            );

            document.getElementById('alumniTableBody').innerHTML = filtered.map(a => `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.name}</td>
                    <td>${a.grade}</td>
                    <td>${a.stream}</td>
                    <td>${a.yearLeft}</td>
                    <td>${a.reason}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewAlumni('${a.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAlumni('${a.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function viewAlumni(alumniId) {
            showAlert(`View alumni: ${alumniId}`, 'info');
        }

        function deleteAlumni(alumniId) {
            AppData.deleteCallback = () => {
                AppData.alumni = AppData.alumni.filter(a => a.id !== alumniId);
                loadAlumni();
                showAlert('Alumni record deleted', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== INVENTORY ====================
        function loadInventory() {
            document.getElementById('inventoryTableBody').innerHTML = AppData.inventory.map(i => `
                <tr>
                    <td>${i.code}</td>
                    <td>${i.name}</td>
                    <td>${i.category}</td>
                    <td>${i.quantity}</td>
                    <td>${i.unit}</td>
                    <td>${i.location}</td>
                    <td><span class="badge badge-success">${i.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editInventory('${i.code}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventory('${i.code}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function filterInventory() {
            const search = document.getElementById('inventorySearch').value.toLowerCase();
            const filtered = AppData.inventory.filter(i => 
                i.name.toLowerCase().includes(search) || i.code.toLowerCase().includes(search)
            );

            document.getElementById('inventoryTableBody').innerHTML = filtered.map(i => `
                <tr>
                    <td>${i.code}</td>
                    <td>${i.name}</td>
                    <td>${i.category}</td>
                    <td>${i.quantity}</td>
                    <td>${i.unit}</td>
                    <td>${i.location}</td>
                    <td><span class="badge badge-success">${i.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editInventory('${i.code}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventory('${i.code}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveInventory(event) {
            event.preventDefault();
            
            const newItem = {
                code: document.getElementById('itemCode').value,
                name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                unit: document.getElementById('itemUnit').value,
                location: document.getElementById('itemLocation').value,
                status: 'Good'
            };

            AppData.inventory.push(newItem);
            closeModal('addInventoryModal');
            loadInventory();
            showAlert('Inventory item added successfully!', 'success');
            event.target.reset();
        }

        function editInventory(code) {
            showAlert(`Edit inventory: ${code} - Feature coming soon`, 'info');
        }

        function deleteInventory(code) {
            AppData.deleteCallback = () => {
                AppData.inventory = AppData.inventory.filter(i => i.code !== code);
                loadInventory();
                showAlert('Inventory item deleted', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== TRANSPORT ====================
        function loadTransport() {
            document.getElementById('transportTableBody').innerHTML = AppData.transport.map(t => `
                <tr>
                    <td>${t.route}</td>
                    <td>${t.vehicle}</td>
                    <td>${t.driver}</td>
                    <td>${t.students}</td>
                    <td><span class="badge badge-success">${t.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editRoute('${t.route}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRoute('${t.route}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveRoute(event) {
            event.preventDefault();
            
            const newRoute = {
                route: document.getElementById('routeName').value,
                vehicle: document.getElementById('vehicleReg').value,
                driver: document.getElementById('driverName').value,
                students: 0,
                status: 'Active'
            };

            AppData.transport.push(newRoute);
            closeModal('addRouteModal');
            loadTransport();
            showAlert('Transport route added successfully!', 'success');
            event.target.reset();
        }

        function editRoute(route) {
            showAlert(`Edit route: ${route} - Feature coming soon`, 'info');
        }

        function deleteRoute(route) {
            AppData.deleteCallback = () => {
                AppData.transport = AppData.transport.filter(t => t.route !== route);
                loadTransport();
                showAlert('Route deleted', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== HOSTEL ====================
        function loadHostel() {
            const roomStudent = document.getElementById('roomStudent');
            if (roomStudent) {
                roomStudent.innerHTML = '<option value="">-- Select Student --</option>' + 
                    AppData.students.map(s => `<option value="${s.id}">${s.name} (${s.id})</option>`).join('');
            }

            document.getElementById('hostelTableBody').innerHTML = AppData.hostel.map(h => `
                <tr>
                    <td>${h.hostel}</td>
                    <td>${h.room}</td>
                    <td>${h.bed}</td>
                    <td>${h.student}</td>
                    <td>${h.admNo}</td>
                    <td><span class="badge badge-success">${h.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editAllocation('${h.room}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAllocation('${h.room}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function allocateRoom(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('roomStudent').value;
            const student = AppData.students.find(s => s.id === studentId);
            
            const newAllocation = {
                hostel: document.getElementById('hostelName').value,
                room: document.getElementById('roomNumber').value,
                bed: document.getElementById('bedNumber').value || 'B1',
                student: student ? student.name : 'Vacant',
                admNo: studentId || '-',
                status: studentId ? 'Occupied' : 'Available'
            };

            AppData.hostel.push(newAllocation);
            closeModal('allocateRoomModal');
            loadHostel();
            showAlert('Room allocated successfully!', 'success');
            event.target.reset();
        }

        function editAllocation(room) {
            showAlert(`Edit allocation: ${room} - Feature coming soon`, 'info');
        }

        function deleteAllocation(room) {
            AppData.deleteCallback = () => {
                AppData.hostel = AppData.hostel.filter(h => h.room !== room);
                loadHostel();
                showAlert('Allocation removed', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== LIBRARY ====================
        function loadLibrary() {
            document.getElementById('libraryTableBody').innerHTML = AppData.library.map(b => `
                <tr>
                    <td>${b.isbn}</td>
                    <td>${b.title}</td>
                    <td>${b.author}</td>
                    <td>${b.category}</td>
                    <td>${b.totalCopies}</td>
                    <td>${b.available}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editBook('${b.isbn}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook('${b.isbn}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function saveBook(event) {
            event.preventDefault();
            
            const newBook = {
                isbn: document.getElementById('bookIsbn').value || 'ISBN' + Date.now(),
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                category: document.getElementById('bookCategory').value,
                totalCopies: parseInt(document.getElementById('bookCopies').value) || 1,
                available: parseInt(document.getElementById('bookCopies').value) || 1
            };

            AppData.library.push(newBook);
            closeModal('addBookModal');
            loadLibrary();
            showAlert('Book added to library successfully!', 'success');
            event.target.reset();
        }

        function editBook(isbn) {
            showAlert(`Edit book: ${isbn} - Feature coming soon`, 'info');
        }

        function deleteBook(isbn) {
            AppData.deleteCallback = () => {
                AppData.library = AppData.library.filter(b => b.isbn !== isbn);
                loadLibrary();
                showAlert('Book deleted', 'success');
                closeModal('deleteConfirmModal');
            };
            openModal('deleteConfirmModal');
        }

        // ==================== SETTINGS ====================
        function saveSettings() {
            showAlert('Settings saved successfully!', 'success');
        }

        function backupSystem() {
            showAlert('System backup created successfully! Database exported.', 'success');
        }

        function restoreBackup() {
            showAlert('System restored from backup successfully!', 'success');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${message}`;
            container.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.classList.add('show'), 100);
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }

        function notifyParent(studentId) {
            const student = AppData.students.find(s => s.id === studentId);
            if (student) {
                showAlert(`Notification sent to ${student.fatherPhone || student.motherPhone}`, 'success');
            }
        }

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            showAlert('Receipt downloaded as PDF', 'success');
        }

        function printReportCard() {
            window.print();
        }

        function downloadReportCard() {
            showAlert('Report card downloaded as PDF', 'success');
        }

        function exportStudents() {
            showAlert('Student data exported successfully!', 'success');
        }

        function confirmDelete() {
            if (AppData.deleteCallback) {
                AppData.deleteCallback();
            }
        }

        // Global search
        document.getElementById('globalSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const search = e.target.value.toLowerCase();
                const student = AppData.students.find(s => 
                    s.name.toLowerCase().includes(search) || 
                    s.id.toLowerCase().includes(search) ||
                    s.upi.toLowerCase().includes(search)
                );
                
                if (student) {
                    viewStudentProfile(student.id);
                } else {
                    showAlert('Student not found', 'warning');
                }
            }
        });

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show'));
            }
        });

        // Close modal on outside click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Initialize sample data
        (function initSampleData() {
            if (AppData.students.length === 0) {
                AppData.students.push(
                    {
                        id: '2023/001',
                        name: 'Akinyi Otieno',
                        dob: '2012-06-12',
                        upi: '4567890123',
                        grade: 'Grade 7',
                        stream: 'East',
                        birthCert: 'BC123456',
                        birthPlace: 'Kisumu',
                        county: 'Kisumu',
                        subCounty: 'Kisumu East',
                        religion: 'Christian (CRE)',
                        bloodGroup: 'O+',
                        fatherName: 'Otieno John',
                        fatherPhone: '0722123456',
                        motherName: 'Otieno Mary',
                        motherPhone: '0723123456',
                        emergencyPhone: '0722123456',
                        medicalNotes: 'Asthma, uses inhaler',
                        prevSchool: 'Kisumu Junior Academy',
                        admissionDate: '2023-01-15',
                        status: 'active'
                    },
                    {
                        id: '2023/002',
                        name: 'Kamau James',
                        dob: '2012-03-08',
                        upi: '4567890124',
                        grade: 'Grade 7',
                        stream: 'West',
                        birthCert: 'BC123457',
                        birthPlace: 'Kiambu',
                        county: 'Kiambu',
                        subCounty: 'Kiambu Town',
                        religion: 'Christian (CRE)',
                        bloodGroup: 'A+',
                        fatherName: 'Kamau Peter',
                        fatherPhone: '0722123457',
                        motherName: 'Kamau Mary',
                        motherPhone: '0723123457',
                        emergencyPhone: '0722123457',
                        medicalNotes: '',
                        prevSchool: 'Kiambu Primary School',
                        admissionDate: '2023-01-15',
                        status: 'active'
                    },
                    {
                        id: '2023/003',
                        name: 'Mwangi Grace',
                        dob: '2011-09-20',
                        upi: '4567890125',
                        grade: 'Grade 8',
                        stream: 'East',
                        birthCert: 'BC123458',
                        birthPlace: 'Nakuru',
                        county: 'Nakuru',
                        subCounty: 'Nakuru East',
                        religion: 'Christian (CRE)',
                        bloodGroup: 'B+',
                        fatherName: 'Mwangi David',
                        fatherPhone: '0722123458',
                        motherName: 'Mwangi Jane',
                        motherPhone: '0723123458',
                        emergencyPhone: '0722123458',
                        medicalNotes: '',
                        prevSchool: 'Nakuru Primary',
                        admissionDate: '2023-01-20',
                        status: 'active'
                    }
                );

                AppData.fees.push(
                    { studentId: '2023/001', total: 55000, paid: 50000, balance: 5000 },
                    { studentId: '2023/002', total: 37000, paid: 37000, balance: 0 },
                    { studentId: '2023/003', total: 55000, paid: 25000, balance: 30000 }
                );

                AppData.assessments.push(
                    { studentId: '2023/001', subject: 'Mathematics', type: 'cat1', score: 45, term: 'Term 1, 2026' },
                    { studentId: '2023/001', subject: 'English', type: 'cat1', score: 72, term: 'Term 1, 2026' },
                    { studentId: '2023/001', subject: 'Science', type: 'cat1', score: 81, term: 'Term 1, 2026' },
                    { studentId: '2023/002', subject: 'Mathematics', type: 'cat1', score: 85, term: 'Term 1, 2026' },
                    { studentId: '2023/002', subject: 'English', type: 'cat1', score: 78, term: 'Term 1, 2026' },
                    { studentId: '2023/003', subject: 'Mathematics', type: 'cat1', score: 35, term: 'Term 1, 2026' }
                );
            }
        })();
    </script>
</body>
</html>